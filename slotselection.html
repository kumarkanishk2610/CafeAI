<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cafe Kyaa! – Slot Selection</title>

    <!-- External Resources -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Styles -->
    <style>
      :root {
        --sat: env(safe-area-inset-top, 0);
        --sab: env(safe-area-inset-bottom, 0);
      }

      html {
        --vh: 1vh;
      }

      body {
        font-family: "Quicksand", sans-serif;
        min-height: calc(var(--vh) * 100);
        padding: var(--sat) 0 var(--sab);
        background: linear-gradient(
          -60deg,
          #fff1f2 0%,
          #ffe4e6 25%,
          #fce7f3 50%,
          #ffe5f8 75%,
          #fff1f2 100%
        );
        background-size: 400% 400%;
        animation: grad 18s ease infinite;
      }

      @keyframes grad {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 5px rgba(236, 72, 153, 0.4);
        }
        50% {
          box-shadow: 0 0 20px rgba(236, 72, 153, 0.8);
        }
        100% {
          box-shadow: 0 0 5px rgba(236, 72, 153, 0.4);
        }
      }

      .glow-animation {
        animation: glow 2s ease-in-out infinite;
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .gradient-text {
        background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body class="text-gray-800">
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Header -->
    <header
      class="fixed inset-x-0 top-0 bg-white/60 backdrop-blur-md shadow-sm z-40"
    >
      <div class="flex items-center justify-between h-16 px-4">
        <div class="flex items-center">
          <a href="index.html" class="flex items-center hover:opacity-80">
            <img src="logo.png" class="h-12 w-12 rounded-full" alt="logo" />
            <div class="ml-2 flex flex-col">
              <h1
                class="text-lg font-bold bg-gradient-to-r from-pink-600 to-rose-500 bg-clip-text text-transparent uppercase tracking-wide leading-tight"
              >
                Cafe Kyaa!
              </h1>
              <span class="text-xs font-medium text-rose-600 leading-tight">
                Anime India 2025 · Mumbai
              </span>
            </div>
          </a>
        </div>
        <!-- User Details Button -->
        <button
          id="userDetailsBtn"
          class="p-2 text-pink-600 hover:text-pink-700 hover:bg-pink-50 rounded-full transition-colors duration-200"
          title="View User Details"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            ></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- User Details Popup -->
    <div
      id="userDetailsPopup"
      class="fixed top-16 right-4 bg-white rounded-lg shadow-lg border border-pink-200 p-4 z-50 hidden transform transition-all duration-200 opacity-0 scale-95"
    >
      <div class="space-y-3 min-w-[280px]">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-800">User Details</h3>
          <button
            id="closePopupBtn"
            class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
              ></path>
              <path
                d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
              ></path>
            </svg>
            <span class="text-gray-600">Email:</span>
            <span id="popupEmail" class="font-semibold text-gray-800"></span>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-gray-600">Booking ID:</span>
            <span id="popupBookingId" class="font-bold text-gray-800"></span>
            <button
              id="copyBookingIdPopupBtn"
              class="ml-2 p-1 text-pink-600 hover:text-pink-700 hover:bg-pink-50 rounded transition-colors duration-200"
              title="Copy Booking ID"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path>
              </svg>
            </button>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
              ></path>
            </svg>
            <span class="text-gray-600">Mobile:</span>
            <span id="popupMobile" class="font-semibold text-gray-800"></span>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-gray-600">Seats:</span>
            <span id="popupSeats" class="font-semibold text-gray-800"></span>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-gray-600">Amount:</span>
            <span id="popupAmount" class="font-semibold text-gray-800"></span>
          </div>
          <div id="popupDiscountInfo" class="text-sm text-gray-500 ml-6"></div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="pt-24 flex flex-col items-center p-4">
      <div class="w-full max-w-4xl space-y-4">
        <!-- Slot Selection Section -->
        <div class="fade-in" style="animation-delay: 0.2s">
          <div
            class="bg-white rounded-3xl shadow-2xl p-6 border border-pink-100"
          >
            <div class="text-center mb-4">
              <h3 class="text-xl font-bold text-gray-800 mb-2">
                Select Your Preferred Timing!
              </h3>
              <div id="topDiscountBanner" class="mb-4">
                <!-- Early Bird Discount will be populated here -->
              </div>
            </div>

            <!-- Day Selection Controls -->
            <div
              class="flex flex-col md:flex-row items-center justify-between mb-0 space-y-4 md:space-y-0"
            >
              <div class="flex items-center gap-3">
                <label
                  class="flex items-center gap-2 text-sm text-gray-700 font-medium"
                >
                  <svg
                    class="w-4 h-4 text-pink-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Select Day:
                </label>
                <select
                  id="daySelector"
                  class="border border-pink-300 rounded-lg px-4 py-2 text-base font-bold focus:ring-pink-500 focus:border-pink-500 bg-white shadow-sm"
                >
                  <option value="1">Fri, 22 Aug 2025</option>
                  <option value="2">Sat, 23 Aug 2025</option>
                  <option value="3">Sun, 24 Aug 2025</option>
                </select>
              </div>
            </div>

            <!-- Availability Table -->
            <div class="w-full">
              <div id="sheet-data"></div>

              <div id="selectionSummary" class="mt-0 text-center"></div>
            </div>
            <div class="mt-8 flex items-start gap-3">
              <div
                class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"
              >
                <svg
                  class="w-5 h-5 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <div>
                <h4 class="font-semibold text-gray-800 mb-1 text-sm">
                  Need Help?
                </h4>
                <p class="text-xs text-gray-600 break-words">
                  You can reach out to us by raising a ticket via
                  <a
                    href="https://forms.gle/e5BpBj6z9hTnk1Kt7"
                    target="_blank"
                    class="text-blue-600 underline hover:text-blue-800 font-medium"
                    >this form</a
                  >. We will try to get back to you as soon as possible.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Loading Modal with Spinner -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl p-8 shadow-2xl text-center max-w-sm mx-4"
      >
        <div
          class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full spinner mb-6 mx-auto"
        ></div>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">
          Loading your details…
        </h2>
        <p class="text-gray-600">Please wait a moment.</p>
      </div>
    </div>

    <!-- Payment Prompt Modal -->
    <div
      id="paymentPromptModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl p-6 shadow-2xl text-center max-w-md mx-4"
      >
        <div
          class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </div>
        <h2 class="text-lg font-bold text-gray-800 mb-3">Proceed to Payment</h2>
        <p class="text-gray-600 mb-4 leading-relaxed">
          Oops! It seems that you have already selected your slots in a previous
          booking attempt for your existing Booking ID. Please complete payment
          for your selected slots on the next page before the timer expires. In
          case you wish to change your slot, please start a fresh booking.
        </p>
        <button
          id="proceedToPaymentBtn"
          class="bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white px-5 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
        >
          Continue to Payment
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="price-utility.js"></script>
    <script>
      // ===== REFERRER CHECK =====
      /*<const allowedReferrer = window.location.origin + "/initiatebooking.html";
      if (document.referrer !== allowedReferrer) {
        // Access denied: Invalid referrer
        // Expected referrer: allowedReferrer
        // Actual referrer: document.referrer
        alert("Please access this page through the proper booking flow.");
        window.location.href = "initiatebooking.html";
      }*/

      // ===== SLOT SELECTION TRACKING =====
      const slotSelectionFormURL =
        "https://docs.google.com/forms/d/e/1FAIpQLSc98yaLaB8GrnXKEo-gXUiGLsGVbXH7XHktNUt9arN850hrTQ/formResponse";
      const slotSelectionSheetID =
        "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const slotSelectionSheetName = "TabBlocking";

      /**
       * Checks if booking ID already has "SlotSelection" recorded
       * @param {string} bookingId - The booking ID to check
       * @returns {Promise<boolean>} - True if SlotSelection is found, false otherwise
       */
      const checkSlotSelectionExists = async (bookingId) => {
        try {
          // === CHECKING SLOT SELECTION STATUS ===
          // Checking booking ID: bookingId

          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${slotSelectionSheetID}/gviz/tq?sheet=${encodeURIComponent(
            slotSelectionSheetName
          )}&tq=${query}`;

          // Making fetch request to check slot selection...
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.text();
          const jsonStart = data.indexOf("{");
          const jsonEnd = data.lastIndexOf("}") + 1;
          const jsonData = data.substring(jsonStart, jsonEnd);
          const json = JSON.parse(jsonData);

          const rows = json.table.rows;
          // Total rows in sheet: rows.length

          // Search for the booking ID in column B (index 1) and check if SlotSelection exists in column C (index 2)
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const bookingIdInSheet = row.c[1]?.v
              ? String(row.c[1].v).trim()
              : ""; // Column B (index 1)
            const tabToBlock = row.c[2]?.v ? String(row.c[2].v).trim() : ""; // Column C (index 2)

            // Row i: Booking ID = bookingIdInSheet, Tab To Block = tabToBlock

            if (bookingIdInSheet === bookingId) {
              // Found booking ID bookingId in row i

              if (tabToBlock === "SlotSelection") {
                // SlotSelection found in row i - User should be blocked
                return true;
              } else {
                // Booking ID found but Tab To Block is tabToBlock (not SlotSelection)
              }
            }
          }

          // Booking ID bookingId not found in sheet or no SlotSelection recorded
          return false;
        } catch (error) {
          // Error checking slot selection status: error
          return false;
        }
      };

      /**
       * Writes booking ID and "SlotSelection" to the Google Form
       * @param {string} bookingId - The booking ID to write
       * @returns {Promise<boolean>} - True if successful, false otherwise
       */
      const writeSlotSelection = async (bookingId) => {
        try {
          // === WRITING SLOT SELECTION ===
          // Writing booking ID: bookingId

          const formData = new FormData();
          formData.append("entry.1737294711", bookingId); // Booking ID
          formData.append("entry.1621765122", "SlotSelection"); // SlotSelection

          const response = await fetch(slotSelectionFormURL, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });

          // Slot selection data written successfully
          return true;
        } catch (error) {
          // Error writing slot selection: error
          return false;
        }
      };

      /**
       * Initializes slot selection tracking
       * @param {string} bookingId - The booking ID to process
       */
      const initializeSlotSelectionTracking = async (bookingId) => {
        try {
          // === INITIALIZING SLOT SELECTION TRACKING ===

          if (!bookingId) {
            // No booking ID provided
            return;
          }

          // Check if SlotSelection already exists
          const slotSelectionExists = await checkSlotSelectionExists(bookingId);

          if (slotSelectionExists) {
            // SlotSelection already exists - Reload/Forward/Back detected
            alert(
              "Reload/Forward/Back was detected. Please start booking again."
            );
            window.location.href = "initiatebooking.html";
            return;
          }

          // Write SlotSelection to form
          // SlotSelection not found - writing to form
          const writeSuccess = await writeSlotSelection(bookingId);

          if (writeSuccess) {
            // Slot selection tracking initialized successfully
          } else {
            // Failed to write slot selection data
          }
        } catch (error) {
          // Error in slot selection tracking: error
        }
      };

      // ===== UTILITY FUNCTIONS =====

      // Set viewport height for mobile devices
      const setVH = () => {
        document.documentElement.style.setProperty(
          "--vh",
          `${innerHeight * 0.01}px`
        );
      };

      // Copy helper function
      const copy = async (text, btn) => {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }

          btn.classList.add(
            "ring-2",
            "ring-offset-1",
            "ring-green-400",
            "transition",
            "duration-150"
          );
          setTimeout(() => {
            btn.classList.remove("ring-2", "ring-offset-1", "ring-green-400");
          }, 1100);

          // Show toast notification
          showToast("Booking ID Copied!");
        } catch (err) {
          alert("Copy failed: " + err);
        }
      };

      // Toast notification function
      const showToast = (message) => {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        toast.className = `
          bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg 
          transform transition-all duration-300 ease-in-out
          opacity-0 translate-x-full
          flex items-center gap-2
        `;

        toast.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="font-medium">${message}</span>
        `;

        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => {
          toast.classList.remove("opacity-0", "translate-x-full");
          toast.classList.add("opacity-100", "translate-x-0");
        }, 10);

        // Auto remove after 3 seconds
        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-x-full");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      };

      // ===== GLOBAL VARIABLES =====
      const params = new URLSearchParams(location.search);
      let email = "";
      let mobile = "";
      let seats = 0;
      let amount = 0;
      const bookingId = params.get("code")?.trim() || "";

      let allRows = [];
      let selection = {};
      let totalSelected = 0;
      let maxSeats = 0;

      // ===== SHEET CONFIGURATION =====
      const sheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const sheetName = "availability";
      const query = encodeURIComponent("SELECT *");
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

      // ===== USER DETAILS SHEET CONFIGURATION =====
      const userDetailsSheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const userDetailsSheetName = "Raw Data";

      // ===== FETCH USER DETAILS BY BOOKING ID =====
      /**
       * Fetches user details from the Google Sheet using booking ID
       * @param {string} bookingId - The booking ID to search for
       * @returns {Promise<Object|null>} - User details object or null if not found
       */
      const fetchUserDetailsByBookingId = async (bookingId) => {
        try {
          // === FETCH USER DETAILS START ===
          // Input booking ID: bookingId
          // Sheet ID: userDetailsSheetID
          // Sheet Name: userDetailsSheetName

          // Fetch the entire sheet data
          const userUrl = `https://docs.google.com/spreadsheets/d/${userDetailsSheetID}/gviz/tq?sheet=${encodeURIComponent(
            userDetailsSheetName
          )}&tq=${encodeURIComponent("SELECT *")}`;

          // Query URL: userUrl

          // Making fetch request...
          const response = await fetch(userUrl);
          // Response status: response.status
          // Response ok: response.ok

          const data = await response.text();
          // Response data length: data.length
          // Raw response (first 500 chars): data.substring(0, 500)...

          if (!response.ok) {
            // HTTP Error: response.status response.statusText
            return null;
          }

          // Parsing JSON response...
          const json = JSON.parse(data.substring(47).slice(0, -2));
          // JSON parsed successfully
          // JSON structure: Object.keys(json)

          const rows = json.table.rows;
          // Total rows in sheet: rows.length

          if (rows.length === 0) {
            // No rows found in sheet
            return null;
          }

          // Searching for booking ID: bookingId
          // First few rows for debugging:
          for (let i = 0; i < Math.min(3, rows.length); i++) {
            const row = rows[i];
            // Row i: row.c?.map((cell, idx) => `col${idx}="${cell?.v || ""}"`).join(", ")
          }

          // Search through all rows for the matching booking ID
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const hashValue = row.c[4]?.v || ""; // E column (Hash/Booking ID) - 5th column (0-indexed as 4)
            const hashValueStr = String(hashValue); // Convert to string to handle both number and string types

            // Row i: Hash value = hashValueStr, looking for bookingId
            // Row i comparison: hashValueStr === bookingId = hashValueStr === bookingId

            // Detailed character analysis
            // Row i - hashValue type: typeof hashValue, length: hashValueStr.length
            // Row i - bookingId type: typeof bookingId, length: bookingId.length
            // Row i - hashValue char codes: Array.from(hashValueStr).map((c) => c.charCodeAt(0)).join(", ")
            // Row i - bookingId char codes: Array.from(bookingId).map((c) => c.charCodeAt(0)).join(", ")
            // Row i - hashValue trimmed: hashValueStr.trim()
            // Row i - bookingId trimmed: bookingId.trim()
            // Row i - trimmed comparison: hashValueStr.trim() === bookingId.trim() = hashValueStr.trim() === bookingId.trim()

            if (
              hashValueStr === bookingId ||
              hashValueStr.trim() === bookingId.trim()
            ) {
              // Found matching booking ID in row i (hashValueStr === bookingId ? "exact match" : "trimmed match")

              const userDetails = {
                email: row.c[1]?.v || "", // B column (Email) - 2nd column (0-indexed as 1)
                seats: parseInt(row.c[2]?.v) || 0, // C column (Seats) - 3rd column (0-indexed as 2)
                mobile: row.c[3]?.v || "", // D column (Mobile Number) - 4th column (0-indexed as 3)
                hash: hashValue, // E column (Hash/Booking ID) - 5th column (0-indexed as 4)
              };

              // User details found: userDetails
              // === FETCH USER DETAILS SUCCESS ===
              return userDetails;
            }
          }

          // No user details found for booking ID: bookingId
          // All rows checked, no match found
          // === FETCH USER DETAILS FAILED ===
          return null;
        } catch (error) {
          // === ERROR IN FETCH USER DETAILS ===
          // Error details: error
          // Error message: error.message
          // Error stack: error.stack
          return null;
        }
      };

      // ===== INITIALIZATION =====

      // Initialize viewport height
      setVH();
      addEventListener("resize", setVH);

      // Validate booking ID parameter
      if (!bookingId) {
        location.replace("initiatebooking.html");
      }

      // ===== SLOT SELECTION TRACKING INITIALIZATION =====
      // Initialize slot selection tracking first
      initializeSlotSelectionTracking(bookingId);

      // ===== INITIALIZE USER DETAILS =====
      const initializeUserDetails = async () => {
        try {
          // === INITIALIZE USER DETAILS START ===
          // Booking ID from URL: bookingId
          // Sheet ID: userDetailsSheetID
          // Sheet Name: userDetailsSheetName

          // Show loading state
          document.getElementById("loadingModal").classList.remove("hidden");

          // Wait 2 seconds before fetching user details from Raw Data
          // Waiting 2 seconds before fetching...
          await new Promise((resolve) => setTimeout(resolve, 2000));
          // 2-second wait completed, now fetching user details...

          // Fetch user details from sheet
          const userDetails = await fetchUserDetailsByBookingId(bookingId);

          // User details returned: userDetails

          if (!userDetails) {
            // No user details found - redirecting to initiatebooking.html
            alert("Invalid booking ID. Please try again.");
            location.replace("initiatebooking.html");
            return;
          }

          // Validate user details
          // Validating user details:
          // Email: userDetails.email
          // Mobile: userDetails.mobile
          // Seats: userDetails.seats

          if (
            !userDetails.email ||
            !userDetails.mobile ||
            userDetails.seats < 1
          ) {
            // Invalid user details - redirecting to initiatebooking.html
            // Email valid: !!userDetails.email
            // Mobile valid: !!userDetails.mobile
            // Seats valid: userDetails.seats >= 1
            alert("Invalid user details. Please try again.");
            location.replace("initiatebooking.html");
            return;
          }

          // User details validation passed

          // Set global variables
          email = userDetails.email;
          mobile = userDetails.mobile;
          seats = userDetails.seats;
          amount = await PriceUtility.calculateAmount(seats);
          maxSeats = seats;

          // Global variables set:
          // Email: email
          // Mobile: mobile
          // Seats: seats
          // Amount: amount
          // Max Seats: maxSeats

          // Store user details for popup (no need to update header elements since they were removed)
          // The popup will be populated when the user clicks the details button

          // UI elements updated successfully

          // Hide loading modal
          document.getElementById("loadingModal").classList.add("hidden");

          // Loading modal hidden, starting application...

          // Start the application
          fetchAndRenderTable();

          // === INITIALIZE USER DETAILS COMPLETED ===
        } catch (error) {
          // === ERROR IN INITIALIZE USER DETAILS ===
          // Error details: error
          // Error message: error.message
          // Error stack: error.stack
          alert("Failed to load user details. Please try again.");
          location.replace("initiatebooking.html");
        }
      };

      // Initialize user details and start the application
      initializeUserDetails();

      // ===== EVENT HANDLERS =====

      // Copy button event handler (removed since the header button was removed)
      // The copy functionality is now handled in the popup

      // Day selector handler
      document.getElementById("daySelector").onchange = (e) =>
        renderTable(+e.target.value);

      // ===== DATA FETCHING =====
      const fetchAndRenderTable = () => {
        fetch(url)
          .then((response) => response.text())
          .then((data) => {
            const json = JSON.parse(data.substring(47).slice(0, -2));
            allRows = json.table.rows;
            allRows.columns = json.table.cols;

            // Revalidate selection based on updated availability
            for (const slotId in selection) {
              const row = allRows.find((r) => r.c[0]?.v === slotId);
              const available = +row?.c[1]?.v || 0;
              if (selection[slotId] > available) {
                totalSelected -= selection[slotId] - available;
                selection[slotId] = available;
              }
            }

            const currentDay =
              +document.getElementById("daySelector").value || 1;
            renderTable(currentDay);
          })
          .catch((error) => {
            // Error loading sheet: error
            document.getElementById("sheet-data").innerHTML =
              '<p class="text-red-600 text-center">Failed to load availability data.</p>';
          });
      };

      // Slot name mapping - easily customizable
      const slotNameMapping = {
        "Slot 1": "10:30 AM",
        "Slot 2": "11:45 AM",
        "Slot 3": "01:00 PM",
        "Slot 4": "02:15 PM",
        "Slot 5": "03:30 PM",
        "Slot 6": "04:45 PM",
        "Slot 7": "DO NOT SELECT - SYSTEM",
        "Slot 8": "DO NOT SELECT - SYSTEM",
        "Slot 9": "DO NOT SELECT - SYSTEM",
        "Slot 10": "DO NOT SELECT - SYSTEM",
      };

      // Function to format slotId for frontend display only
      const formatSlotIdForDisplay = (slotId) => {
        // Extract slot number from the slotId
        const slotMatch = slotId.match(/Slot (\d+)/);
        const slotName = slotMatch ? `Slot ${slotMatch[1]}` : slotId;
        return slotNameMapping[slotName] || slotName;
      };

      // ===== TABLE RENDERING =====

      const renderTable = async (day = 1) => {
        const startIdx = (day - 1) * 10;
        const endIdx = startIdx + 10;
        const visibleRows = allRows.slice(startIdx, endIdx);
        const dayLabels = [
          "Fri, 22 Aug 2025",
          "Sat, 23 Aug 2025",
          "Sun, 24 Aug 2025",
        ];
        const dayLabel = dayLabels[day - 1] || `Day ${day}`;

        let html = ``;
        let validRowCount = 0;

        // Filter out rows where both free slots and processing are 0
        const validRows = visibleRows.filter((row) => {
          const freeSlots = +row.c[1]?.v || 0;
          const processing = +row.c[2]?.v || 0;
          return !(freeSlots === 0 && processing === 0);
        });

        validRows.forEach((row, i) => {
          const slotId = row.c[0]?.v || `Slot${i}`;
          const freeSlots = +row.c[1]?.v || 0;
          const processing = +row.c[2]?.v || 0;
          const booked = +row.c[3]?.v || 0;
          const selected = selection[slotId] || 0;

          const disableMinus = selected <= 0;
          const disablePlus =
            selected >= freeSlots || totalSelected >= maxSeats;

          // Use formattedSlotId ONLY for display
          const formattedSlotId = formatSlotIdForDisplay(slotId);

          // Show alert only if less than 12 seats available
          const seatsLeft = freeSlots;
          const showAlert = seatsLeft < 12;

          html += `
    <div class="flex items-center justify-between py-4 ${
      i < validRows.length - 1 ? "border-b border-gray-200" : ""
    }">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-4">
          <h4 class="text-lg font-semibold text-gray-800 w-20">${formattedSlotId}</h4>
          <div class="w-px h-8 bg-gray-200"></div>
        </div>
        <div class="text-sm text-gray-600">
          ${
            seatsLeft === 0
              ? `<span class="text-xs text-red-600 font-medium">Sold Out!</span>`
              : `<span class="font-medium text-gray-800">Selected:</span> ${selected}${
                  showAlert
                    ? `<br><span class="text-xs text-orange-600 font-medium">Only ${seatsLeft} seats left!</span>`
                    : ""
                }`
          }
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button data-slot="${slotId}" class="decBtn w-8 h-8 bg-gray-100 text-gray-600 rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 ${
            disableMinus
              ? "opacity-40 cursor-not-allowed"
              : "hover:bg-gray-200 hover:scale-105"
          }" ${disableMinus ? "disabled" : ""}>−</button>
        <button data-slot="${slotId}" class="incBtn w-8 h-8 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 ${
            disablePlus
              ? "opacity-40 cursor-not-allowed"
              : "hover:from-pink-600 hover:to-rose-600 hover:scale-105"
          }" ${disablePlus ? "disabled" : ""}>+</button>
      </div>
    </div>`;
        });

        document.getElementById("sheet-data").innerHTML = html;

        // Attach button event listeners
        document.querySelectorAll(".incBtn").forEach((btn) => {
          btn.onclick = async () => await updateSelection(btn.dataset.slot, 1);
        });

        document.querySelectorAll(".decBtn").forEach((btn) => {
          btn.onclick = async () => await updateSelection(btn.dataset.slot, -1);
        });

        await updateSummary();
        await updateTopDiscountBanner();
      };

      // ===== SELECTION MANAGEMENT =====

      const updateSelection = async (slotId, delta) => {
        const row = allRows.find((r) => r.c[0]?.v === slotId);
        const available = +row?.c[1]?.v || 0;
        const current = selection[slotId] || 0;

        if (delta === 1 && totalSelected < maxSeats && current < available) {
          selection[slotId] = current + 1;
          totalSelected++;
        } else if (delta === -1 && current > 0) {
          selection[slotId] = current - 1;
          totalSelected--;
        }

        await renderTable(+document.getElementById("daySelector").value);
      };

      const updateSummary = async () => {
        const summaryDiv = document.getElementById("selectionSummary");
        // [SlotSelection] updateSummary called

        summaryDiv.innerHTML = `
          <div class="text-center mb-4">
            <div class="text-sm text-gray-700">
              <span class="font-semibold text-green-600">${totalSelected}</span> of <span class="font-semibold text-gray-800">${maxSeats}</span> seats selected
            </div>
          </div>
          <button id="confirmBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 rounded-lg font-semibold text-lg transition-all duration-200 ${
            totalSelected !== maxSeats
              ? "opacity-50 cursor-not-allowed"
              : "hover:shadow-lg"
          }" ${totalSelected !== maxSeats ? "disabled" : ""}>
            Confirm Slot Selection
          </button>
        `;

        const confirmBtn = document.getElementById("confirmBtn");
        if (confirmBtn) {
          confirmBtn.onclick = () => confirmSlotSelection();
        }
      };

      // ===== FORM URLS AND ENTRY IDS (CENTRALIZED) =====
      const FORM_URLS = {
        slotEntry:
          "https://docs.google.com/forms/d/e/1FAIpQLSe5CnXZ7cJ2Zv21bNdBoxvCel6rYjJAY6zokzT272nXL_-CyA/formResponse",
        lockSlot:
          "https://docs.google.com/forms/d/e/1FAIpQLSdT9FTGvtq2V7F00HBmrMgSczCTFVo5f54fiUsLIBsRBHpmIg/formResponse",
        finalSlot:
          "https://docs.google.com/forms/d/e/1FAIpQLSdKvVjiL3W356UZsWKy0BBRpqHxoFN7Q_5UQHUKlQDjxpNxBA/formResponse",
      };
      const ENTRY_IDS = {
        slotEntry: {
          day1Slot1: "entry.1796999400",
          day1Slot2: "entry.932368020",
          day1Slot3: "entry.2138292831",
          day1Slot4: "entry.289682458",
          day1Slot5: "entry.784258010",
          day1Slot6: "entry.1293731699",
          day1Slot7: "entry.1207107693",
          day1Slot8: "entry.1581124993",
          day1Slot9: "entry.379119257",
          day1Slot10: "entry.984452720",
          day2Slot1: "entry.870117852",
          day2Slot2: "entry.1157155505",
          day2Slot3: "entry.1474125256",
          day2Slot4: "entry.1575272486",
          day2Slot5: "entry.461195791",
          day2Slot6: "entry.125707347",
          day2Slot7: "entry.1444513547",
          day2Slot8: "entry.1470313618",
          day2Slot9: "entry.335063754",
          day2Slot10: "entry.364884408",
          day3Slot1: "entry.1042905315",
          day3Slot2: "entry.679434220",
          day3Slot3: "entry.1438879432",
          day3Slot4: "entry.1392821554",
          day3Slot5: "entry.210512443",
          day3Slot6: "entry.1759494387",
          day3Slot7: "entry.519624058",
          day3Slot8: "entry.142383170",
          day3Slot9: "entry.1733224228",
          day3Slot10: "entry.467333756",
        },
        lockSlot: {
          bookingId: "entry.1178870073",
          seatCount: "entry.1406053668",
          slotId: "entry.239115061",
        },
        finalSlot: {
          day: "entry.706936465",
          slot: "entry.1380648863",
          bookingId: "entry.1536265716",
          status: "entry.38505346",
        },
      };

      // ===== GOOGLE FORM SUBMISSION UTILITY =====
      /**
       * Submits data to a Google Form.
       * @param {string} formUrl - The Google Form POST URL
       * @param {Object} fields - Object mapping entry IDs to values
       * @param {number} [delay=200] - Optional delay after submission (ms)
       */
      async function submitToGoogleForm(formUrl, fields, delay = 200) {
        const formData = new FormData();
        for (const [entryId, value] of Object.entries(fields)) {
          formData.append(entryId, value);
        }
        await fetch(formUrl, {
          method: "POST",
          mode: "no-cors",
          body: formData,
        });
        if (delay > 0) await new Promise((res) => setTimeout(res, delay));
      }

      // ===== SLOT CONFIRMATION =====
      const confirmSlotSelection = async () => {
        try {
          if (!bookingId) {
            alert("Invalid booking ID.");
            return;
          }

          document.getElementById("loadingModal").classList.remove("hidden");

          // Triple pre-registration check
          const preRegistrationPassed = await triplePreRegistrationCheck();
          if (!preRegistrationPassed) {
            alert(
              "Selected slots are locked by another user. Please try again later."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Submit to Google Form (slotEntry)
          for (let slotId in selection) {
            const count = selection[slotId];
            if (count === 0) continue;
            // Map slotId to entryId
            const entryField = Object.entries(ENTRY_IDS.slotEntry).find(
              ([k, v]) =>
                k.replace(
                  /([a-z]+)(\d)Slot(\d)/i,
                  (m, d, day, slot) =>
                    `Day ${day} - ${
                      ["22 Aug", "23 Aug", "24 Aug"][day - 1]
                    } - Slot ${slot}`
                ) === slotId
            )?.[1];
            if (!entryField) {
              // No entry field mapping found for slot slotId
              continue;
            }
            await submitToGoogleForm(FORM_URLS.slotEntry, {
              [entryField]: bookingId,
            });
          }

          // Triple post-registration verification
          const postRegistrationVerified =
            await triplePostRegistrationVerification();
          if (!postRegistrationVerified) {
            alert(
              "Slot confirmation failed due to a mismatch. Please try again in a few moments."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Check seat availability
          const seatCheckPassed = await checkSlotAvailability();
          if (!seatCheckPassed) {
            alert(
              "One or more selected slots are fully booked. Please try again."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Final verification
          const finalCheckPassed = await verifyBookingIdInRaceCondition();
          if (!finalCheckPassed) {
            alert(
              "Slot confirmation failed due to a mismatch. Please try again in a few moments."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Check for active processing
          const hasActiveProcessing = await checkActiveProcessing();
          if (hasActiveProcessing) {
            document.getElementById("loadingModal").classList.add("hidden");
            document
              .getElementById("paymentPromptModal")
              .classList.remove("hidden");
            document.getElementById("proceedToPaymentBtn").onclick = () => {
              window.location.href = `order.html?${new URLSearchParams({
                email,
                mobile,
                seats,
                code: bookingId,
              })}`;
            };
            return;
          }

          // Lock slots (lockSlot form)
          for (let slotId in selection) {
            const count = selection[slotId];
            if (count === 0) continue;
            await submitToGoogleForm(FORM_URLS.lockSlot, {
              [ENTRY_IDS.lockSlot.bookingId]: bookingId,
              [ENTRY_IDS.lockSlot.seatCount]: count,
              [ENTRY_IDS.lockSlot.slotId]: slotId,
            });
          }

          // Final slot form submission (finalSlot form)
          for (let slotId in selection) {
            const count = selection[slotId];
            if (count === 0) continue;

            // Extract day and slot information from slotId
            const dayMatch = slotId.match(/Day\s*(\d+)/);
            const slotMatch = slotId.match(/Slot\s*(\d+)/);

            if (!dayMatch || !slotMatch) {
              // Invalid slotId format: slotId
              continue;
            }

            const dayCode = `D${dayMatch[1]}`;
            const slotCode = `S${slotMatch[1]}`;

            for (let i = 0; i < count; i++) {
              await submitToGoogleForm(FORM_URLS.finalSlot, {
                [ENTRY_IDS.finalSlot.day]: dayCode,
                [ENTRY_IDS.finalSlot.slot]: slotCode,
                [ENTRY_IDS.finalSlot.bookingId]: bookingId,
                [ENTRY_IDS.finalSlot.status]: "Processing",
              });
            }
          }

          window.location.href = `order.html?${new URLSearchParams({
            //email,
            //mobile,
            //seats,
            code: bookingId,
          })}`;
        } catch (error) {
          alert(
            "An error occurred while confirming your slots. Please try again."
          );
          document.getElementById("loadingModal").classList.add("hidden");
        }
      };

      // ===== HELPER FUNCTIONS =====

      // ===== TRIPLE PRE-REGISTRATION CHECK =====
      /**
       * Checks 5 times that slots are either expired or contain own booking ID
       * @returns {Promise<boolean>} - true if all checks pass, false otherwise
       */
      const triplePreRegistrationCheck = async () => {
        for (let attempt = 1; attempt <= 5; attempt++) {
          // Pre-registration check attempt attempt/5

          const { allCleared, matchedBookingId } =
            await checkRaceConditionStatus();

          // Check if all slots are either expired or belong to current user
          if (!allCleared && !matchedBookingId) {
            // Pre-registration check attempt/5 FAILED: Slots locked by others
            if (attempt < 5) {
              await new Promise((res) => setTimeout(res, 1000)); // Wait 1 second between checks
            }
            continue;
          }

          // Pre-registration check attempt/5 PASSED

          // If this is the last attempt and it passed, return true
          if (attempt === 5) {
            return true;
          }

          // Wait 1 second before next check (except for the last one)
          await new Promise((res) => setTimeout(res, 1000));
        }

        return false;
      };

      // ===== TRIPLE POST-REGISTRATION VERIFICATION =====
      /**
       * Verifies 5 times that the sheet shows own booking ID after registration
       * @returns {Promise<boolean>} - true if all verifications pass, false otherwise
       */
      const triplePostRegistrationVerification = async () => {
        for (let attempt = 1; attempt <= 5; attempt++) {
          // Post-registration verification attempt attempt/5

          const { allCleared, matchedBookingId } =
            await checkRaceConditionStatus();

          // Check if at least one slot belongs to current user (indicating successful registration)
          if (matchedBookingId) {
            // Post-registration verification attempt/5 PASSED: Own booking ID found
            return true;
          }

          // Post-registration verification attempt/5 FAILED: Own booking ID not found

          if (attempt < 5) {
            await new Promise((res) => setTimeout(res, 1000)); // Wait 1 second between checks
          }
        }

        return false;
      };

      const checkRaceConditionStatus = async () => {
        const raceConditionSheet = "Race Condition";
        const raceQuery = encodeURIComponent("SELECT A, B");
        const raceUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${raceConditionSheet}&tq=${raceQuery}`;
        const raceResponse = await fetch(raceUrl);
        const raceData = await raceResponse.text();
        const raceJson = JSON.parse(raceData.substring(47).slice(0, -2));
        const raceRows = raceJson.table.rows;

        const raceStatusMap = {};
        raceRows.forEach((row) => {
          const slotId = row.c[0]?.v ? String(row.c[0].v).trim() : "";
          const userVal = row.c[1]?.v ? String(row.c[1].v).trim() : "";
          if (slotId) raceStatusMap[slotId] = userVal;
        });

        let allCleared = true;
        let matchedBookingId = false;

        for (let slotId of Object.keys(selection)) {
          if (selection[slotId] === 0) continue;

          const statusOrUser = raceStatusMap[slotId];
          // Slot slotId: Status/User = statusOrUser

          if (statusOrUser === "Expired") {
            // Slot slotId is Expired. ✅
            continue;
          } else if (statusOrUser === bookingId) {
            // Slot slotId belongs to current Booking ID (bookingId). ✅ Proceeding...
            matchedBookingId = true;
            break;
          } else {
            // Slot slotId is held by another booking or not expired. ⏳
            allCleared = false;
          }
        }

        return { allCleared, matchedBookingId };
      };

      const checkSlotAvailability = async () => {
        const slotAvailabilitySheet = "Availability Helper";
        const seatQuery = encodeURIComponent("SELECT A, B");
        const seatUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(
          slotAvailabilitySheet
        )}&tq=${seatQuery}`;

        try {
          const slotIdToFullName = {
            "Day 1 - 22 Aug - Slot 1": "Day 1 - 22 Aug - Slot 1",
            "Day 1 - 22 Aug - Slot 2": "Day 1 - 22 Aug - Slot 2",
            "Day 1 - 22 Aug - Slot 3": "Day 1 - 22 Aug - Slot 3",
            "Day 1 - 22 Aug - Slot 4": "Day 1 - 22 Aug - Slot 4",
            "Day 1 - 22 Aug - Slot 5": "Day 1 - 22 Aug - Slot 5",
            "Day 1 - 22 Aug - Slot 6": "Day 1 - 22 Aug - Slot 6",
            "Day 1 - 22 Aug - Slot 7": "Day 1 - 22 Aug - Slot 7",
            "Day 1 - 22 Aug - Slot 8": "Day 1 - 22 Aug - Slot 8",
            "Day 1 - 22 Aug - Slot 9": "Day 1 - 22 Aug - Slot 9",
            "Day 1 - 22 Aug - Slot 10": "Day 1 - 22 Aug - Slot 10",
            "Day 2 - 23 Aug - Slot 1": "Day 2 - 23 Aug - Slot 1",
            "Day 2 - 23 Aug - Slot 2": "Day 2 - 23 Aug - Slot 2",
            "Day 2 - 23 Aug - Slot 3": "Day 2 - 23 Aug - Slot 3",
            "Day 2 - 23 Aug - Slot 4": "Day 2 - 23 Aug - Slot 4",
            "Day 2 - 23 Aug - Slot 5": "Day 2 - 23 Aug - Slot 5",
            "Day 2 - 23 Aug - Slot 6": "Day 2 - 23 Aug - Slot 6",
            "Day 2 - 23 Aug - Slot 7": "Day 2 - 23 Aug - Slot 7",
            "Day 2 - 23 Aug - Slot 8": "Day 2 - 23 Aug - Slot 8",
            "Day 2 - 23 Aug - Slot 9": "Day 2 - 23 Aug - Slot 9",
            "Day 2 - 23 Aug - Slot 10": "Day 2 - 23 Aug - Slot 10",
            "Day 3 - 24 Aug - Slot 1": "Day 3 - 24 Aug - Slot 1",
            "Day 3 - 24 Aug - Slot 2": "Day 3 - 24 Aug - Slot 2",
            "Day 3 - 24 Aug - Slot 3": "Day 3 - 24 Aug - Slot 3",
            "Day 3 - 24 Aug - Slot 4": "Day 3 - 24 Aug - Slot 4",
            "Day 3 - 24 Aug - Slot 5": "Day 3 - 24 Aug - Slot 5",
            "Day 3 - 24 Aug - Slot 6": "Day 3 - 24 Aug - Slot 6",
            "Day 3 - 24 Aug - Slot 7": "Day 3 - 24 Aug - Slot 7",
            "Day 3 - 24 Aug - Slot 8": "Day 3 - 24 Aug - Slot 8",
            "Day 3 - 24 Aug - Slot 9": "Day 3 - 24 Aug - Slot 9",
            "Day 3 - 24 Aug - Slot 10": "Day 3 - 24 Aug - Slot 10",
          };

          const seatResponse = await fetch(seatUrl);
          const seatData = await seatResponse.text();
          const seatJson = JSON.parse(seatData.substring(47).slice(0, -2));
          const seatRows = seatJson.table.rows;

          const freeSlotsMap = {};
          seatRows.forEach((row) => {
            const slotName = row.c[0]?.v
              ? String(row.c[0].v).trim().toLowerCase()
              : "";
            const freeCount = row.c[1]?.v ? parseInt(row.c[1].v) : 0;
            if (slotName) {
              freeSlotsMap[slotName] = freeCount;
              // Parsed from sheet: slotName → Free Slots = freeCount
            }
          });

          let allSlotsHaveCapacity = true;

          for (let slotId in selection) {
            const seatsRequested = selection[slotId];
            if (seatsRequested === 0) continue;

            const fullSlotName = slotIdToFullName[slotId];
            const normalizedSlotName = fullSlotName.toLowerCase();
            const availableSeats = freeSlotsMap[normalizedSlotName];

            // Slot fullSlotName: Available = availableSeats, Requested = seatsRequested

            if (availableSeats === undefined) {
              // ⚠️ Slot fullSlotName not found in sheet.
              allSlotsHaveCapacity = false;
            } else if (availableSeats < seatsRequested) {
              // ❌ Not enough seats in fullSlotName.
              allSlotsHaveCapacity = false;
            } else {
              // ✅ Slot fullSlotName has enough seats.
            }
          }

          return allSlotsHaveCapacity;
        } catch (err) {
          // Error checking slot availability: err
          return false;
        }
      };

      const verifyBookingIdInRaceCondition = async () => {
        const raceConditionSheet = "Race Condition";
        const raceQuery = encodeURIComponent("SELECT A, B");
        const raceUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${raceConditionSheet}&tq=${raceQuery}`;
        const raceResponse = await fetch(raceUrl);
        const raceData = await raceResponse.text();
        const raceJson = JSON.parse(raceData.substring(47).slice(0, -2));
        const raceRows = raceJson.table.rows;

        const raceStatusMap = {};
        raceRows.forEach((row) => {
          const slotId = row.c[0]?.v ? String(row.c[0].v).trim() : "";
          const userVal = row.c[1]?.v ? String(row.c[1].v).trim() : "";
          if (slotId) raceStatusMap[slotId] = userVal;
        });

        let allMatched = true;

        for (let slotId of Object.keys(selection)) {
          if (selection[slotId] === 0) continue;

          const recordedVal = raceStatusMap[slotId];
          // Post-submission check: Slot slotId = recordedVal

          if (recordedVal !== bookingId) {
            // Slot slotId does not match bookingId. Status: recordedVal
            allMatched = false;
          }

          if (recordedVal === "Expired") {
            // Slot slotId is marked as Expired — invalid after form submission.
            allMatched = false;
          }
        }

        return allMatched;
      };

      const checkActiveProcessing = async () => {
        const blockingSheet = "Slot Blocking Sources";
        const query = encodeURIComponent("SELECT *");
        const blockingUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${blockingSheet}&tq=${query}`;
        const response = await fetch(blockingUrl);
        const data = await response.text();
        const json = JSON.parse(data.substring(47).slice(0, -2));
        const rows = json.table.rows;

        return rows.some((row) => {
          const rowBookingId = row.c[3]?.v ? String(row.c[3].v).trim() : "";
          const status = row.c[4]?.v ? String(row.c[4].v).trim() : "";
          const activity = row.c[6]?.v ? String(row.c[6].v).trim() : "";

          const match =
            rowBookingId === bookingId &&
            status === "Processing" &&
            activity === "Active";
          if (match)
            // MATCH FOUND: rowBookingId, status, activity
            return match;
        });
      };

      const lockSlots = async () => {
        const lockFormURL =
          "https://docs.google.com/forms/d/e/1FAIpQLSdT9FTGvtq2V7F00HBmrMgSczCTFVo5f54fiUsLIBsRBHpmIg/formResponse";

        for (let slotId in selection) {
          const count = selection[slotId];
          if (count === 0) continue;

          const formData = new FormData();
          formData.append("entry.1178870073", bookingId);
          formData.append("entry.1406053668", count);
          formData.append("entry.239115061", slotId);

          await fetch(lockFormURL, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });

          await new Promise((res) => setTimeout(res, 200));
        }
      };

      const submitFinalForms = async () => {
        const formBaseURL =
          "https://docs.google.com/forms/d/e/1FAIpQLSdKvVjiL3W356UZsWKy0BBRpqHxoFN7Q_5UQHUKlQDjxpNxBA/formResponse";

        for (let slotId in selection) {
          const count = selection[slotId];
          if (count === 0) continue;

          // Extract day and slot information from slotId
          const dayMatch = slotId.match(/Day\s*(\d+)/);
          const slotMatch = slotId.match(/Slot\s*(\d+)/);

          if (!dayMatch || !slotMatch) {
            // Invalid slotId format: slotId
            continue;
          }

          const dayCode = `D${dayMatch[1]}`;
          const slotCode = `S${slotMatch[1]}`;

          for (let i = 0; i < count; i++) {
            const formData = new FormData();
            formData.append("entry.706936465", dayCode);
            formData.append("entry.1380648863", slotCode);
            formData.append("entry.1536265716", bookingId);
            formData.append("entry.38505346", "Processing");

            await fetch(formBaseURL, {
              method: "POST",
              mode: "no-cors",
              body: formData,
            });

            await new Promise((r) => setTimeout(r, 200));
          }
        }
      };

      // ===== POPUP FUNCTIONALITY =====

      // Popup elements
      const userDetailsBtn = document.getElementById("userDetailsBtn");
      const userDetailsPopup = document.getElementById("userDetailsPopup");
      const closePopupBtn = document.getElementById("closePopupBtn");

      // Toggle popup function
      const togglePopup = async (show) => {
        if (show) {
          // Populate popup with current data from global variables
          document.getElementById("popupEmail").textContent = email;
          document.getElementById("popupBookingId").textContent = bookingId;
          document.getElementById("popupMobile").textContent = mobile;
          document.getElementById("popupSeats").textContent = seats;

          // Update popup amount with discount information
          const popupAmountEl = document.getElementById("popupAmount");
          const popupDiscountInfoEl =
            document.getElementById("popupDiscountInfo");

          if (popupAmountEl) {
            try {
              const discountData = await PriceUtility.getCurrentDiscountData();
              if (
                discountData.discountName &&
                Math.abs(discountData.discountPercent) > 0
              ) {
                // Calculate pre-discount total amount
                const preDiscountTotal = seats * discountData.preDiscountPrice;
                const currentTotal = amount;
                popupAmountEl.innerHTML = `
                  <span class="text-gray-400" style="text-decoration: line-through;">₹${preDiscountTotal}</span>
                  <span class="text-green-600">₹${currentTotal}</span>
                `;

                // Show discount info in popup
                if (popupDiscountInfoEl) {
                  const absDiscountPercent = Math.abs(
                    discountData.discountPercent
                  );
                  popupDiscountInfoEl.innerHTML = `
                    <span class="text-green-600 font-medium">${
                      discountData.discountName
                    }</span>
                                            <span class="text-gray-500"> (${Math.round(
                                              absDiscountPercent
                                            )}% off)</span>
                  `;
                }
              } else {
                // No discount, show normal amount
                popupAmountEl.textContent = `₹${amount}`;

                // Hide discount info in popup
                if (popupDiscountInfoEl) {
                  popupDiscountInfoEl.innerHTML = "";
                }
              }
            } catch (error) {
              // Error updating popup amount: error
              // Fallback to normal amount display
              popupAmountEl.textContent = `₹${amount}`;

              // Hide discount info in popup
              if (popupDiscountInfoEl) {
                popupDiscountInfoEl.innerHTML = "";
              }
            }
          }

          // Show popup with animation
          userDetailsPopup.classList.remove("hidden");
          setTimeout(() => {
            userDetailsPopup.classList.remove("opacity-0", "scale-95");
            userDetailsPopup.classList.add("opacity-100", "scale-100");
          }, 10);

          // Add grey highlight to button
          userDetailsBtn.classList.add("bg-gray-200", "text-gray-600");
          userDetailsBtn.classList.remove(
            "text-pink-600",
            "hover:text-pink-700",
            "hover:bg-pink-50"
          );
        } else {
          // Hide popup with animation
          userDetailsPopup.classList.add("opacity-0", "scale-95");
          setTimeout(() => {
            userDetailsPopup.classList.add("hidden");
          }, 200);

          // Remove grey highlight from button
          userDetailsBtn.classList.remove("bg-gray-200", "text-gray-600");
          userDetailsBtn.classList.add(
            "text-pink-600",
            "hover:text-pink-700",
            "hover:bg-pink-50"
          );
        }
      };

      // Track popup state
      let isPopupOpen = false;

      // Toggle popup on button click
      userDetailsBtn.addEventListener("click", () => {
        isPopupOpen = !isPopupOpen;
        togglePopup(isPopupOpen);
      });

      // Close popup
      closePopupBtn.addEventListener("click", () => {
        isPopupOpen = false;
        togglePopup(false);
      });

      // Close popup when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !userDetailsPopup.contains(e.target) &&
          !userDetailsBtn.contains(e.target) &&
          isPopupOpen
        ) {
          isPopupOpen = false;
          togglePopup(false);
        }
      });

      // Copy booking ID button event handler
      document
        .getElementById("copyBookingIdPopupBtn")
        .addEventListener("click", () => {
          copy(bookingId, document.getElementById("copyBookingIdPopupBtn"));
        });

      // ===== INITIALIZATION =====

      setInterval(fetchAndRenderTable, 5000);

      // ===== DISCOUNT BANNER MANAGEMENT =====
      const updateTopDiscountBanner = async () => {
        const bannerDiv = document.getElementById("topDiscountBanner");
        if (!bannerDiv) return;

        try {
          const discountData = await PriceUtility.getCurrentDiscountData();

          if (
            discountData.discountName &&
            Math.abs(discountData.discountPercent) > 0
          ) {
            const absDiscountPercent = Math.abs(discountData.discountPercent);
            bannerDiv.innerHTML = `
              <div class="relative overflow-hidden">
                <div class="bg-gradient-to-r from-amber-50 via-yellow-50 to-orange-50 rounded-2xl p-6 border-2 border-amber-200 shadow-lg relative">
                  <!-- Background Pattern -->
                  <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-amber-300 rounded-full -translate-y-16 translate-x-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-orange-300 rounded-full translate-y-12 -translate-x-12"></div>
                  </div>
                  
                  <!-- Main Content -->
                  <div class="relative z-10 text-center">
                    <div class="flex items-center justify-center gap-2 mb-3">
                      <div class="w-8 h-8 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                      <span class="text-lg font-bold text-amber-800">${
                        discountData.discountName
                      }</span>
                    </div>
                    
                    <div class="flex items-center justify-center gap-3 text-base">
                      <span class="text-gray-600 text-base line-through font-medium">₹${
                        discountData.preDiscountPrice
                      }</span>
                      <div class="flex items-center justify-center gap-3 text-base">

                        <span class="text-green-600 text-base font-extrabold font-medium">₹${
                          discountData.price
                        }</span>
                      </div>
                      <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                        ${Math.round(absDiscountPercent)}% OFF
                      </span>
                    </div>
                    
                    <div class="mt-3 text-xs text-amber-700 font-medium">
                      ⏰ Limited time offer - Book now to secure your discount!
                    </div>
                  </div>
                </div>
              </div>
            `;
          } else {
            bannerDiv.innerHTML = "";
          }
        } catch (error) {
          // [SlotSelection] Error updating top discount banner: error
          bannerDiv.innerHTML = "";
        }
      };
    </script>
  </body>
</html>
