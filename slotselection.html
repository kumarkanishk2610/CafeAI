<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cafe Kyaa! – Slot Selection</title>

    <!-- External Resources -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Styles -->
    <style>
      :root {
        --sat: env(safe-area-inset-top, 0);
        --sab: env(safe-area-inset-bottom, 0);
      }

      html {
        --vh: 1vh;
      }

      body {
        font-family: "Quicksand", sans-serif;
        min-height: calc(var(--vh) * 100);
        padding: var(--sat) 0 var(--sab);
        background: linear-gradient(
          -60deg,
          #fff1f2 0%,
          #ffe4e6 25%,
          #fce7f3 50%,
          #ffe5f8 75%,
          #fff1f2 100%
        );
        background-size: 400% 400%;
        animation: grad 18s ease infinite;
      }

      @keyframes grad {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 5px rgba(236, 72, 153, 0.4);
        }
        50% {
          box-shadow: 0 0 20px rgba(236, 72, 153, 0.8);
        }
        100% {
          box-shadow: 0 0 5px rgba(236, 72, 153, 0.4);
        }
      }

      .glow-animation {
        animation: glow 2s ease-in-out infinite;
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .gradient-text {
        background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body class="text-gray-800">
    <!-- Header -->
    <header
      class="fixed inset-x-0 top-0 bg-white/60 backdrop-blur-md shadow-sm z-40"
    >
      <div class="flex items-center h-14 px-4">
        <a href="index.html" class="flex items-center hover:opacity-80">
          <img src="logo.png" class="h-10 w-10 rounded-full" alt="logo" />
          <h1
            class="ml-2 text-lg font-bold bg-gradient-to-r from-pink-600 to-rose-500 bg-clip-text text-transparent uppercase tracking-wide"
          >
            Cafe Kyaa!
          </h1>
        </a>
        <span
          class="ml-auto text-xs font-medium text-rose-600 whitespace-nowrap"
        >
          Anime India 2025 · Mumbai
        </span>
      </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20 flex flex-col items-center p-4">
      <div class="w-full max-w-4xl space-y-6">
        <!-- Order Summary Card -->
        <div class="fade-in">
          <div
            class="relative isolate overflow-hidden rounded-3xl bg-gradient-to-br from-white to-pink-50 p-6 shadow-2xl border border-pink-100"
          >
            <!-- Decorative elements -->
            <div
              class="absolute -top-20 -right-20 w-40 h-40 bg-gradient-to-br from-pink-200 to-rose-200 rounded-full opacity-20 blur-3xl"
            ></div>
            <div
              class="absolute -bottom-20 -left-20 w-40 h-40 bg-gradient-to-br from-rose-200 to-pink-200 rounded-full opacity-20 blur-3xl"
            ></div>

            <div class="relative z-10">
              <!-- Header -->
              <div
                class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 rounded-xl flex items-center justify-center shadow-lg"
                  >
                    <svg
                      class="w-6 h-6 text-white"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M2.25 9.75A2.25 2.25 0 0 1 4.5 7.5h15a2.25 2.25 0 0 1 2.25 2.25v1.08a3.219 3.219 0 0 0 0 6.42v1.08A2.25 2.25 0 0 1 19.5 21h-15A2.25 2.25 0 0 1 2.25 18.75v-1.08a3.219 3.219 0 0 0 0-6.42V9.75zM12 9a.75.75 0 0 0-.75.75v.75h1.5V9.75A.75.75 0 0 0 12 9zm-.75 3h1.5v1.5h-1.5V12zm1.5 4.5h-1.5V18a.75.75 0 0 0 1.5 0v-1.5z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1">
                      Reserve Your Slot!
                    </h2>
                    <p class="text-gray-600 font-medium">Cafe Kyaa! Tickets</p>
                  </div>
                </div>

                <!-- Price Summary -->
                <div class="text-right">
                  <div class="text-2xl font-bold gradient-text mb-1">
                    ₹<span id="amtTitle">0</span>
                  </div>
                  <div class="text-gray-600">
                    <span id="seatCount">0</span> seat(s) @ ₹500 each
                  </div>
                </div>
              </div>

              <!-- Contact Details -->
              <div
                class="bg-white rounded-xl p-4 shadow-lg border border-gray-100"
              >
                <h3
                  class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2"
                >
                  <svg
                    class="w-5 h-5 text-pink-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                    ></path>
                    <path
                      d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                    ></path>
                  </svg>
                  Your Details
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"
                  >
                    <div
                      class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-pink-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                        ></path>
                        <path
                          d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">Email</div>
                      <div
                        id="emailVal"
                        class="text-sm font-semibold text-gray-800 break-words max-w-[40vw]"
                      ></div>
                    </div>
                  </div>

                  <div
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"
                  >
                    <div
                      class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-pink-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">
                        Mobile
                      </div>
                      <div
                        id="mobileVal"
                        class="text-sm font-semibold text-gray-800"
                      ></div>
                    </div>
                  </div>
                </div>

                <!-- Booking ID Section -->
                <div
                  class="flex items-center justify-between p-4 bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl border border-pink-200"
                >
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-white"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">
                        Booking ID
                      </div>
                      <div
                        id="bookingIdValSummary"
                        class="text-sm font-bold text-gray-800"
                      ></div>
                    </div>
                  </div>
                  <button
                    id="copyBookingIdSummaryBtn"
                    class="bg-pink-500 hover:bg-pink-600 text-white px-2 py-1 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 shadow-md hover:shadow-lg"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 002 2z"
                      ></path>
                    </svg>
                    Copy
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Slot Selection Section -->
        <div class="fade-in" style="animation-delay: 0.2s">
          <div
            class="bg-white rounded-3xl shadow-2xl p-6 border border-pink-100"
          >
            <div class="text-center mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-2">
                Select Your Preferred Slots
              </h3>
              <p class="text-gray-600">
                Choose the day and time slots that work best for you
              </p>
            </div>

            <!-- Day Selection Controls -->
            <div
              class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-4 md:space-y-0"
            >
              <div class="flex items-center gap-3">
                <label
                  class="flex items-center gap-2 text-sm text-gray-700 font-medium"
                >
                  <svg
                    class="w-4 h-4 text-pink-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Select Day:
                </label>
                <select
                  id="daySelector"
                  class="border border-pink-300 rounded-lg px-4 py-2 text-sm focus:ring-pink-500 focus:border-pink-500 bg-white shadow-sm"
                >
                  <option value="1">Fri, 22 Aug 2025</option>
                  <option value="2">Sat, 23 Aug 2025</option>
                  <option value="3">Sun, 24 Aug 2025</option>
                </select>
              </div>
              <button
                id="refreshTableBtn"
                class="bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white text-sm px-6 py-2 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  ></path>
                </svg>
                Refresh Availability
              </button>
            </div>

            <!-- Availability Table -->
            <div class="w-full">
              <div id="sheet-data"></div>

              <div id="selectionSummary" class="mt-6 text-center"></div>
            </div>
          </div>
        </div>

        <!-- Information Cards -->
        <div class="fade-in" style="animation-delay: 0.4s">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Note Card -->
            <div
              class="bg-white rounded-xl p-4 shadow-lg border border-blue-100"
            >
              <div class="flex items-start gap-3">
                <div
                  class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"
                >
                  <svg
                    class="w-5 h-5 text-blue-600"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800 mb-1">
                    Important Note
                  </h4>
                  <p class="text-sm text-gray-600 leading-relaxed">
                    Use the same email and seat count throughout the booking.
                    After payment, our team will verify and confirm your ticket.
                    You'll receive a confirmation email once it's done.
                  </p>
                </div>
              </div>
            </div>

            <!-- Refund Card -->
            <div
              class="bg-white rounded-xl p-4 shadow-lg border border-green-100"
            >
              <div class="flex items-start gap-3">
                <div
                  class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"
                >
                  <svg
                    class="w-5 h-5 text-green-600"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800 mb-1">
                    Refund Policy
                  </h4>
                  <p class="text-sm text-gray-600 leading-relaxed">
                    If your preferred slot isn't available, you can request a
                    refund within 2 hours via
                    <a
                      href="https://forms.gle/e5BpBj6z9hTnk1Kt7"
                      target="_blank"
                      class="text-blue-600 underline hover:text-blue-800 font-medium"
                      >this form</a
                    >. If tickets are sold out, your payment will be refunded
                    automatically within 24 hours.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Loading Modal -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl p-6 shadow-2xl text-center max-w-sm mx-4"
      >
        <div
          class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full spinner mx-auto mb-4"
        ></div>
        <h2 class="text-lg font-bold text-gray-800 mb-2">
          Loading your details…
        </h2>
        <p class="text-gray-600">Fetching your booking information...</p>
      </div>
    </div>

    <!-- Payment Prompt Modal -->
    <div
      id="paymentPromptModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl p-6 shadow-2xl text-center max-w-md mx-4"
      >
        <div
          class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </div>
        <h2 class="text-lg font-bold text-gray-800 mb-3">Proceed to Payment</h2>
        <p class="text-gray-600 mb-4 leading-relaxed">
          Oops! It seems that you have already selected your slots in a previous
          booking attempt for your existing Booking ID. Please complete payment
          for your selected slots on the next page before the timer expires. In
          case you wish to change your slot, please start a fresh booking.
        </p>
        <button
          id="proceedToPaymentBtn"
          class="bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white px-5 py-2 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
        >
          Continue to Payment
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // ===== REFERRER CHECK =====
      const allowedReferrer = window.location.origin + "/initiatepayment.html";
      if (document.referrer !== allowedReferrer) {
        console.log("Access denied: Invalid referrer");
        console.log("Expected referrer:", allowedReferrer);
        console.log("Actual referrer:", document.referrer);
        alert("Please access this page through the proper booking flow.");
        window.location.href = "initiatepayment.html";
      }

      // ===== SLOT SELECTION TRACKING =====
      const slotSelectionFormURL =
        "https://docs.google.com/forms/d/e/1FAIpQLSc98yaLaB8GrnXKEo-gXUiGLsGVbXH7XHktNUt9arN850hrTQ/formResponse";
      const slotSelectionSheetID =
        "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const slotSelectionSheetName = "TabBlocking";

      /**
       * Checks if booking ID already has "SlotSelection" recorded
       * @param {string} bookingId - The booking ID to check
       * @returns {Promise<boolean>} - True if SlotSelection is found, false otherwise
       */
      const checkSlotSelectionExists = async (bookingId) => {
        try {
          console.log("=== CHECKING SLOT SELECTION STATUS ===");
          console.log(`Checking booking ID: "${bookingId}"`);

          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${slotSelectionSheetID}/gviz/tq?sheet=${encodeURIComponent(
            slotSelectionSheetName
          )}&tq=${query}`;

          console.log("Making fetch request to check slot selection...");
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.text();
          const jsonStart = data.indexOf("{");
          const jsonEnd = data.lastIndexOf("}") + 1;
          const jsonData = data.substring(jsonStart, jsonEnd);
          const json = JSON.parse(jsonData);

          const rows = json.table.rows;
          console.log(`Total rows in sheet: ${rows.length}`);

          // Search for the booking ID in column B (index 1) and check if SlotSelection exists in column C (index 2)
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const bookingIdInSheet = row.c[1]?.v
              ? String(row.c[1].v).trim()
              : ""; // Column B (index 1)
            const tabToBlock = row.c[2]?.v ? String(row.c[2].v).trim() : ""; // Column C (index 2)

            console.log(
              `Row ${i}: Booking ID = "${bookingIdInSheet}", Tab To Block = "${tabToBlock}"`
            );

            if (bookingIdInSheet === bookingId) {
              console.log(`Found booking ID "${bookingId}" in row ${i}`);

              if (tabToBlock === "SlotSelection") {
                console.log(
                  `SlotSelection found in row ${i} - User should be blocked`
                );
                return true;
              } else {
                console.log(
                  `Booking ID found but Tab To Block is "${tabToBlock}" (not SlotSelection)`
                );
              }
            }
          }

          console.log(
            `Booking ID "${bookingId}" not found in sheet or no SlotSelection recorded`
          );
          return false;
        } catch (error) {
          console.error("Error checking slot selection status:", error);
          return false;
        }
      };

      /**
       * Writes booking ID and "SlotSelection" to the Google Form
       * @param {string} bookingId - The booking ID to write
       * @returns {Promise<boolean>} - True if successful, false otherwise
       */
      const writeSlotSelection = async (bookingId) => {
        try {
          console.log("=== WRITING SLOT SELECTION ===");
          console.log(`Writing booking ID: "${bookingId}"`);

          const formData = new FormData();
          formData.append("entry.1737294711", bookingId); // Booking ID
          formData.append("entry.1621765122", "SlotSelection"); // SlotSelection

          const response = await fetch(slotSelectionFormURL, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });

          console.log("Slot selection data written successfully");
          return true;
        } catch (error) {
          console.error("Error writing slot selection:", error);
          return false;
        }
      };

      /**
       * Initializes slot selection tracking
       * @param {string} bookingId - The booking ID to process
       */
      const initializeSlotSelectionTracking = async (bookingId) => {
        try {
          console.log("=== INITIALIZING SLOT SELECTION TRACKING ===");

          if (!bookingId) {
            console.log("No booking ID provided");
            return;
          }

          // Check if SlotSelection already exists
          const slotSelectionExists = await checkSlotSelectionExists(bookingId);

          if (slotSelectionExists) {
            console.log(
              "SlotSelection already exists - Reload/Forward/Back detected"
            );
            alert(
              "Reload/Forward/Back was detected. Please start booking again."
            );
            window.location.href = "initiatepayment.html";
            return;
          }

          // Write SlotSelection to form
          console.log("SlotSelection not found - writing to form");
          const writeSuccess = await writeSlotSelection(bookingId);

          if (writeSuccess) {
            console.log("Slot selection tracking initialized successfully");
          } else {
            console.log("Failed to write slot selection data");
          }
        } catch (error) {
          console.error("Error in slot selection tracking:", error);
        }
      };

      // ===== UTILITY FUNCTIONS =====

      // Set viewport height for mobile devices
      const setVH = () => {
        document.documentElement.style.setProperty(
          "--vh",
          `${innerHeight * 0.01}px`
        );
      };

      // Copy helper function
      const copy = async (text, btn) => {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }

          btn.classList.add(
            "ring-2",
            "ring-offset-1",
            "ring-green-400",
            "transition",
            "duration-150"
          );
          setTimeout(() => {
            btn.classList.remove("ring-2", "ring-offset-1", "ring-green-400");
          }, 1100);
        } catch (err) {
          alert("Copy failed: " + err);
        }
      };

      // ===== GLOBAL VARIABLES =====
      const params = new URLSearchParams(location.search);
      let email = "";
      let mobile = "";
      let seats = 0;
      let amount = 0;
      const bookingId = params.get("code")?.trim() || "";

      let allRows = [];
      let selection = {};
      let totalSelected = 0;
      let maxSeats = 0;

      // ===== SHEET CONFIGURATION =====
      const sheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const sheetName = "availability";
      const query = encodeURIComponent("SELECT *");
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

      // ===== USER DETAILS SHEET CONFIGURATION =====
      const userDetailsSheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const userDetailsSheetName = "Raw Data";

      // ===== FETCH USER DETAILS BY BOOKING ID =====
      /**
       * Fetches user details from the Google Sheet using booking ID
       * @param {string} bookingId - The booking ID to search for
       * @returns {Promise<Object|null>} - User details object or null if not found
       */
      const fetchUserDetailsByBookingId = async (bookingId) => {
        try {
          console.log("=== FETCH USER DETAILS START ===");
          console.log(`Input booking ID: "${bookingId}"`);
          console.log(`Sheet ID: ${userDetailsSheetID}`);
          console.log(`Sheet Name: ${userDetailsSheetName}`);

          // Fetch the entire sheet data
          const userUrl = `https://docs.google.com/spreadsheets/d/${userDetailsSheetID}/gviz/tq?sheet=${encodeURIComponent(
            userDetailsSheetName
          )}&tq=${encodeURIComponent("SELECT *")}`;

          console.log(`Query URL: ${userUrl}`);

          console.log("Making fetch request...");
          const response = await fetch(userUrl);
          console.log(`Response status: ${response.status}`);
          console.log(`Response ok: ${response.ok}`);

          const data = await response.text();
          console.log(`Response data length: ${data.length}`);
          console.log(
            `Raw response (first 500 chars): ${data.substring(0, 500)}...`
          );

          if (!response.ok) {
            console.error(
              `HTTP Error: ${response.status} ${response.statusText}`
            );
            return null;
          }

          console.log("Parsing JSON response...");
          const json = JSON.parse(data.substring(47).slice(0, -2));
          console.log("JSON parsed successfully");
          console.log(`JSON structure:`, Object.keys(json));

          const rows = json.table.rows;
          console.log(`Total rows in sheet: ${rows.length}`);

          if (rows.length === 0) {
            console.warn("No rows found in sheet");
            return null;
          }

          console.log(`Searching for booking ID: "${bookingId}"`);
          console.log("First few rows for debugging:");
          for (let i = 0; i < Math.min(3, rows.length); i++) {
            const row = rows[i];
            console.log(
              `Row ${i}:`,
              row.c
                ?.map((cell, idx) => `col${idx}="${cell?.v || ""}"`)
                .join(", ")
            );
          }

          // Search through all rows for the matching booking ID
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const hashValue = row.c[4]?.v || ""; // E column (Hash/Booking ID) - 5th column (0-indexed as 4)
            const hashValueStr = String(hashValue); // Convert to string to handle both number and string types

            console.log(
              `Row ${i}: Hash value = "${hashValueStr}", looking for "${bookingId}"`
            );
            console.log(
              `Row ${i} comparison: "${hashValueStr}" === "${bookingId}" = ${
                hashValueStr === bookingId
              }`
            );

            // Detailed character analysis
            console.log(
              `Row ${i} - hashValue type: ${typeof hashValue}, length: ${
                hashValueStr.length
              }`
            );
            console.log(
              `Row ${i} - bookingId type: ${typeof bookingId}, length: ${
                bookingId.length
              }`
            );
            console.log(
              `Row ${i} - hashValue char codes: ${Array.from(hashValueStr)
                .map((c) => c.charCodeAt(0))
                .join(", ")}`
            );
            console.log(
              `Row ${i} - bookingId char codes: ${Array.from(bookingId)
                .map((c) => c.charCodeAt(0))
                .join(", ")}`
            );
            console.log(
              `Row ${i} - hashValue trimmed: "${hashValueStr.trim()}"`
            );
            console.log(`Row ${i} - bookingId trimmed: "${bookingId.trim()}"`);
            console.log(
              `Row ${i} - trimmed comparison: "${hashValueStr.trim()}" === "${bookingId.trim()}" = ${
                hashValueStr.trim() === bookingId.trim()
              }`
            );

            if (
              hashValueStr === bookingId ||
              hashValueStr.trim() === bookingId.trim()
            ) {
              console.log(
                `Found matching booking ID in row ${i} (${
                  hashValueStr === bookingId ? "exact match" : "trimmed match"
                })`
              );

              const userDetails = {
                email: row.c[1]?.v || "", // B column (Email) - 2nd column (0-indexed as 1)
                seats: parseInt(row.c[2]?.v) || 0, // C column (Seats) - 3rd column (0-indexed as 2)
                mobile: row.c[3]?.v || "", // D column (Mobile Number) - 4th column (0-indexed as 3)
                hash: hashValue, // E column (Hash/Booking ID) - 5th column (0-indexed as 4)
              };

              console.log(`User details found:`, userDetails);
              console.log("=== FETCH USER DETAILS SUCCESS ===");
              return userDetails;
            }
          }

          console.warn(`No user details found for booking ID: "${bookingId}"`);
          console.log("All rows checked, no match found");
          console.log("=== FETCH USER DETAILS FAILED ===");
          return null;
        } catch (error) {
          console.error("=== ERROR IN FETCH USER DETAILS ===");
          console.error("Error details:", error);
          console.error("Error message:", error.message);
          console.error("Error stack:", error.stack);
          return null;
        }
      };

      // ===== INITIALIZATION =====

      // Initialize viewport height
      setVH();
      addEventListener("resize", setVH);

      // Validate booking ID parameter
      if (!bookingId) {
        location.replace("initiatepayment.html");
      }

      // ===== SLOT SELECTION TRACKING INITIALIZATION =====
      // Initialize slot selection tracking first
      initializeSlotSelectionTracking(bookingId);

      // ===== INITIALIZE USER DETAILS =====
      const initializeUserDetails = async () => {
        try {
          console.log("=== INITIALIZE USER DETAILS START ===");
          console.log(`Booking ID from URL: "${bookingId}"`);
          console.log(`Sheet ID: ${userDetailsSheetID}`);
          console.log(`Sheet Name: ${userDetailsSheetName}`);

          // Show loading state
          document.getElementById("loadingModal").classList.remove("hidden");

          // Wait 2 seconds before fetching user details from Raw Data
          console.log("Waiting 2 seconds before fetching...");
          await new Promise((resolve) => setTimeout(resolve, 2000));
          console.log("2-second wait completed, now fetching user details...");

          // Fetch user details from sheet
          const userDetails = await fetchUserDetailsByBookingId(bookingId);

          console.log("User details returned:", userDetails);

          if (!userDetails) {
            console.error(
              "No user details found - redirecting to initiatepayment.html"
            );
            alert("Invalid booking ID. Please try again.");
            location.replace("initiatepayment.html");
            return;
          }

          // Validate user details
          console.log("Validating user details:");
          console.log(`Email: "${userDetails.email}"`);
          console.log(`Mobile: "${userDetails.mobile}"`);
          console.log(`Seats: ${userDetails.seats}`);

          if (
            !userDetails.email ||
            !userDetails.mobile ||
            userDetails.seats < 1
          ) {
            console.error(
              "Invalid user details - redirecting to initiatepayment.html"
            );
            console.error(`Email valid: ${!!userDetails.email}`);
            console.error(`Mobile valid: ${!!userDetails.mobile}`);
            console.error(`Seats valid: ${userDetails.seats >= 1}`);
            alert("Invalid user details. Please try again.");
            location.replace("initiatepayment.html");
            return;
          }

          console.log("User details validation passed");

          // Set global variables
          email = userDetails.email;
          mobile = userDetails.mobile;
          seats = userDetails.seats;
          amount = seats * 500;
          maxSeats = seats;

          console.log("Global variables set:");
          console.log(`Email: ${email}`);
          console.log(`Mobile: ${mobile}`);
          console.log(`Seats: ${seats}`);
          console.log(`Amount: ${amount}`);
          console.log(`Max Seats: ${maxSeats}`);

          // Update UI elements
          document.getElementById("seatCount").textContent = seats;
          document.getElementById("amtTitle").textContent = amount;
          document.getElementById("emailVal").textContent = email;
          document.getElementById("mobileVal").textContent = mobile;
          document.getElementById("bookingIdValSummary").textContent =
            bookingId;

          console.log("UI elements updated successfully");

          // Hide loading modal
          document.getElementById("loadingModal").classList.add("hidden");

          console.log("Loading modal hidden, starting application...");

          // Start the application
          fetchAndRenderTable();

          console.log("=== INITIALIZE USER DETAILS COMPLETED ===");
        } catch (error) {
          console.error("=== ERROR IN INITIALIZE USER DETAILS ===");
          console.error("Error details:", error);
          console.error("Error message:", error.message);
          console.error("Error stack:", error.stack);
          alert("Failed to load user details. Please try again.");
          location.replace("initiatepayment.html");
        }
      };

      // Initialize user details and start the application
      initializeUserDetails();

      // ===== EVENT HANDLERS =====

      // Copy button event handler
      document.getElementById("copyBookingIdSummaryBtn").onclick = () =>
        copy(bookingId, document.getElementById("copyBookingIdSummaryBtn"));

      // Day selector and refresh handlers
      document.getElementById("daySelector").onchange = (e) =>
        renderTable(+e.target.value);
      document.getElementById("refreshTableBtn").onclick = () =>
        fetchAndRenderTable();

      // ===== DATA FETCHING =====
      const fetchAndRenderTable = () => {
        fetch(url)
          .then((response) => response.text())
          .then((data) => {
            const json = JSON.parse(data.substring(47).slice(0, -2));
            allRows = json.table.rows;
            allRows.columns = json.table.cols;

            // Revalidate selection based on updated availability
            for (const slotId in selection) {
              const row = allRows.find((r) => r.c[0]?.v === slotId);
              const available = +row?.c[1]?.v || 0;
              if (selection[slotId] > available) {
                totalSelected -= selection[slotId] - available;
                selection[slotId] = available;
              }
            }

            const currentDay =
              +document.getElementById("daySelector").value || 1;
            renderTable(currentDay);
          })
          .catch((error) => {
            console.error("Error loading sheet:", error);
            document.getElementById("sheet-data").innerHTML =
              '<p class="text-red-600 text-center">Failed to load availability data.</p>';
          });
      };

      // Function to format slotId for frontend display only
      const formatSlotIdForDisplay = (slotId) => {
        let formatted = slotId
          .replace("Day 1 -", "Fri,")
          .replace("Day 2 -", "Sat,")
          .replace("Day 3 -", "Sun,");

        // Remove last 9 characters and append 2025
        if (formatted.length > 9) {
          formatted = formatted.slice(0, -9) + " 2025";
        }

        return formatted;
      };

      // ===== TABLE RENDERING =====

      const renderTable = (day = 1) => {
        const startIdx = (day - 1) * 4;
        const endIdx = startIdx + 4;
        const visibleRows = allRows.slice(startIdx, endIdx);
        const dayLabel =
          visibleRows[0]?.c[0]?.v?.split("Slot")[0]?.replace(/[\s–-]+$/, "") ||
          `Day ${day}`;

        let html = `
  <div class="text-xl font-bold text-gray-800 mb-4 text-center">${dayLabel}</div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

        visibleRows.forEach((row, i) => {
          const slotId = row.c[0]?.v || `Slot${i}`;
          const freeSlots = +row.c[1]?.v || 0;
          const processing = +row.c[2]?.v || 0;
          const booked = +row.c[3]?.v || 0;
          const selected = selection[slotId] || 0;

          const disableMinus = selected <= 0;
          const disablePlus =
            selected >= freeSlots || totalSelected >= maxSeats;

          // Use formattedSlotId ONLY for display
          const formattedSlotId = formatSlotIdForDisplay(slotId);

          html += `
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-lg hover:shadow-xl transition-all duration-200 card-hover">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-base font-bold text-gray-800">${formattedSlotId}</h4>
        <div class="w-12 h-8 bg-gradient-to-br from-pink-500 to-rose-500 rounded-full flex items-center justify-center">
          <span class="text-white text-xs font-bold">Slot ${i + 1}</span>
        </div>
      </div>
      
      <div class="grid grid-cols-3 gap-2 mb-3">
        <div class="bg-green-50 border border-green-200 rounded-lg p-2 text-center">
          <div class="text-base font-bold text-green-700">${freeSlots}</div>
          <div class="text-xs text-green-600 font-medium">Free</div>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-center">
          <div class="text-base font-bold text-yellow-700">${processing}</div>
          <div class="text-xs text-yellow-600 font-medium">Processing</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-2 text-center">
          <div class="text-base font-bold text-red-700">${booked}</div>
          <div class="text-xs text-red-600 font-medium">Booked</div>
        </div>
      </div>
      
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <span class="font-semibold text-gray-800">Selected:</span> ${selected}
        </div>
        <div class="flex items-center gap-2">
          <button data-slot="${slotId}" class="decBtn w-8 h-8 bg-gray-200 text-gray-800 rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 ${
            disableMinus
              ? "opacity-50 cursor-not-allowed"
              : "hover:bg-gray-300 hover:scale-110"
          }" ${disableMinus ? "disabled" : ""}>–</button>
          <button data-slot="${slotId}" class="incBtn w-8 h-8 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 ${
            disablePlus
              ? "opacity-50 cursor-not-allowed"
              : "hover:from-pink-600 hover:to-rose-600 hover:scale-110"
          }" ${disablePlus ? "disabled" : ""}>+</button>
        </div>
      </div>
    </div>`;
        });

        html += `</div>`;

        document.getElementById("sheet-data").innerHTML = html;

        // Attach button event listeners
        document.querySelectorAll(".incBtn").forEach((btn) => {
          btn.onclick = () => updateSelection(btn.dataset.slot, 1);
        });

        document.querySelectorAll(".decBtn").forEach((btn) => {
          btn.onclick = () => updateSelection(btn.dataset.slot, -1);
        });

        updateSummary();
      };

      // ===== SELECTION MANAGEMENT =====

      const updateSelection = (slotId, delta) => {
        const row = allRows.find((r) => r.c[0]?.v === slotId);
        const available = +row?.c[1]?.v || 0;
        const current = selection[slotId] || 0;

        if (delta === 1 && totalSelected < maxSeats && current < available) {
          selection[slotId] = current + 1;
          totalSelected++;
        } else if (delta === -1 && current > 0) {
          selection[slotId] = current - 1;
          totalSelected--;
        }

        renderTable(+document.getElementById("daySelector").value);
      };

      const updateSummary = () => {
        const summaryDiv = document.getElementById("selectionSummary");
        summaryDiv.innerHTML = `
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200 shadow-lg">
          <div class="text-center mb-4">
            <div class="text-2xl font-bold text-gray-800 mb-2">
              Selection Summary
            </div>
            <div class="text-lg text-gray-600">
              Selected <span class="font-bold text-green-600">${totalSelected}</span> of <span class="font-bold text-gray-800">${maxSeats}</span> seat(s)
            </div>
          </div>
          <div class="flex justify-center">
            <button id="confirmBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2 ${
              totalSelected !== maxSeats
                ? "opacity-50 cursor-not-allowed"
                : "hover:scale-105"
            }" ${totalSelected !== maxSeats ? "disabled" : ""}>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Confirm Slot Selection
            </button>
          </div>
        </div>`;

        const confirmBtn = document.getElementById("confirmBtn");
        if (confirmBtn) {
          confirmBtn.onclick = () => confirmSlotSelection();
        }
      };

      // ===== FORM URLS AND ENTRY IDS (CENTRALIZED) =====
      const FORM_URLS = {
        slotEntry:
          "https://docs.google.com/forms/d/e/1FAIpQLSe5CnXZ7cJ2Zv21bNdBoxvCel6rYjJAY6zokzT272nXL_-CyA/formResponse",
        lockSlot:
          "https://docs.google.com/forms/d/e/1FAIpQLSdT9FTGvtq2V7F00HBmrMgSczCTFVo5f54fiUsLIBsRBHpmIg/formResponse",
        finalSlot:
          "https://docs.google.com/forms/d/e/1FAIpQLSdKvVjiL3W356UZsWKy0BBRpqHxoFN7Q_5UQHUKlQDjxpNxBA/formResponse",
      };
      const ENTRY_IDS = {
        slotEntry: {
          day1Slot1: "entry.1796999400",
          day1Slot2: "entry.932368020",
          day1Slot3: "entry.2138292831",
          day1Slot4: "entry.289682458",
          day2Slot1: "entry.870117852",
          day2Slot2: "entry.1157155505",
          day2Slot3: "entry.1474125256",
          day2Slot4: "entry.1575272486",
          day3Slot1: "entry.1042905315",
          day3Slot2: "entry.679434220",
          day3Slot3: "entry.1438879432",
          day3Slot4: "entry.1392821554",
        },
        lockSlot: {
          bookingId: "entry.1178870073",
          seatCount: "entry.1406053668",
          slotId: "entry.239115061",
        },
        finalSlot: {
          day: "entry.706936465",
          slot: "entry.1380648863",
          bookingId: "entry.1536265716",
          status: "entry.38505346",
        },
      };

      // ===== GOOGLE FORM SUBMISSION UTILITY =====
      /**
       * Submits data to a Google Form.
       * @param {string} formUrl - The Google Form POST URL
       * @param {Object} fields - Object mapping entry IDs to values
       * @param {number} [delay=200] - Optional delay after submission (ms)
       */
      async function submitToGoogleForm(formUrl, fields, delay = 200) {
        const formData = new FormData();
        for (const [entryId, value] of Object.entries(fields)) {
          formData.append(entryId, value);
        }
        await fetch(formUrl, {
          method: "POST",
          mode: "no-cors",
          body: formData,
        });
        if (delay > 0) await new Promise((res) => setTimeout(res, delay));
      }

      // ===== SLOT CONFIRMATION =====
      const confirmSlotSelection = async () => {
        try {
          if (!bookingId) {
            alert("Invalid booking ID.");
            return;
          }

          document.getElementById("loadingModal").classList.remove("hidden");

          // Triple pre-registration check
          const preRegistrationPassed = await triplePreRegistrationCheck();
          if (!preRegistrationPassed) {
            alert(
              "Selected slots are locked by another user. Please try again later."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Submit to Google Form (slotEntry)
          for (let slotId in selection) {
            const count = selection[slotId];
            if (count === 0) continue;
            // Map slotId to entryId
            const entryField = Object.entries(ENTRY_IDS.slotEntry).find(
              ([k, v]) =>
                k.replace(
                  /([a-z]+)(\d)Slot(\d)/i,
                  (m, d, day, slot) =>
                    `Day ${day} - ${
                      ["22 Aug", "23 Aug", "24 Aug"][day - 1]
                    } - Slot ${slot}`
                ) === slotId
            )?.[1];
            if (!entryField) {
              console.warn(`No entry field mapping found for slot ${slotId}`);
              continue;
            }
            await submitToGoogleForm(FORM_URLS.slotEntry, {
              [entryField]: bookingId,
            });
          }

          // Triple post-registration verification
          const postRegistrationVerified =
            await triplePostRegistrationVerification();
          if (!postRegistrationVerified) {
            alert(
              "Slot confirmation failed due to a mismatch. Please try again in a few moments."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Check seat availability
          const seatCheckPassed = await checkSlotAvailability();
          if (!seatCheckPassed) {
            alert(
              "One or more selected slots are fully booked. Please try again."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Final verification
          const finalCheckPassed = await verifyBookingIdInRaceCondition();
          if (!finalCheckPassed) {
            alert(
              "Slot confirmation failed due to a mismatch. Please try again in a few moments."
            );
            document.getElementById("loadingModal").classList.add("hidden");
            return;
          }

          // Check for active processing
          const hasActiveProcessing = await checkActiveProcessing();
          if (hasActiveProcessing) {
            document.getElementById("loadingModal").classList.add("hidden");
            document
              .getElementById("paymentPromptModal")
              .classList.remove("hidden");
            document.getElementById("proceedToPaymentBtn").onclick = () => {
              window.location.href = `order.html?${new URLSearchParams({
                email,
                mobile,
                seats,
                code: bookingId,
              })}`;
            };
            return;
          }

          // Lock slots (lockSlot form)
          for (let slotId in selection) {
            const count = selection[slotId];
            if (count === 0) continue;
            await submitToGoogleForm(FORM_URLS.lockSlot, {
              [ENTRY_IDS.lockSlot.bookingId]: bookingId,
              [ENTRY_IDS.lockSlot.seatCount]: count,
              [ENTRY_IDS.lockSlot.slotId]: slotId,
            });
          }

          // Final slot form submission (finalSlot form)
          const dayVal = document.getElementById("daySelector").value;
          const dayCode = `D${dayVal}`;
          for (let slotId in selection) {
            const count = selection[slotId];
            if (count === 0) continue;
            const slotMatch = slotId.match(/Slot\s*(\d+)/);
            const slotCode = slotMatch ? `S${slotMatch[1]}` : "S1";
            for (let i = 0; i < count; i++) {
              await submitToGoogleForm(FORM_URLS.finalSlot, {
                [ENTRY_IDS.finalSlot.day]: dayCode,
                [ENTRY_IDS.finalSlot.slot]: slotCode,
                [ENTRY_IDS.finalSlot.bookingId]: bookingId,
                [ENTRY_IDS.finalSlot.status]: "Processing",
              });
            }
          }

          window.location.href = `order.html?${new URLSearchParams({
            //email,
            //mobile,
            //seats,
            code: bookingId,
          })}`;
        } catch (error) {
          alert(
            "An error occurred while confirming your slots. Please try again."
          );
          document.getElementById("loadingModal").classList.add("hidden");
        }
      };

      // ===== HELPER FUNCTIONS =====

      // ===== TRIPLE PRE-REGISTRATION CHECK =====
      /**
       * Checks 5 times that slots are either expired or contain own booking ID
       * @returns {Promise<boolean>} - true if all checks pass, false otherwise
       */
      const triplePreRegistrationCheck = async () => {
        for (let attempt = 1; attempt <= 5; attempt++) {
          console.log(`Pre-registration check attempt ${attempt}/5`);

          const { allCleared, matchedBookingId } =
            await checkRaceConditionStatus();

          // Check if all slots are either expired or belong to current user
          if (!allCleared && !matchedBookingId) {
            console.log(
              `Pre-registration check ${attempt}/5 FAILED: Slots locked by others`
            );
            if (attempt < 5) {
              await new Promise((res) => setTimeout(res, 1000)); // Wait 1 second between checks
            }
            continue;
          }

          console.log(`Pre-registration check ${attempt}/5 PASSED`);

          // If this is the last attempt and it passed, return true
          if (attempt === 5) {
            return true;
          }

          // Wait 1 second before next check (except for the last one)
          await new Promise((res) => setTimeout(res, 1000));
        }

        return false;
      };

      // ===== TRIPLE POST-REGISTRATION VERIFICATION =====
      /**
       * Verifies 5 times that the sheet shows own booking ID after registration
       * @returns {Promise<boolean>} - true if all verifications pass, false otherwise
       */
      const triplePostRegistrationVerification = async () => {
        for (let attempt = 1; attempt <= 5; attempt++) {
          console.log(`Post-registration verification attempt ${attempt}/5`);

          const { allCleared, matchedBookingId } =
            await checkRaceConditionStatus();

          // Check if at least one slot belongs to current user (indicating successful registration)
          if (matchedBookingId) {
            console.log(
              `Post-registration verification ${attempt}/5 PASSED: Own booking ID found`
            );
            return true;
          }

          console.log(
            `Post-registration verification ${attempt}/5 FAILED: Own booking ID not found`
          );

          if (attempt < 5) {
            await new Promise((res) => setTimeout(res, 1000)); // Wait 1 second between checks
          }
        }

        return false;
      };

      const checkRaceConditionStatus = async () => {
        const raceConditionSheet = "Race Condition";
        const raceQuery = encodeURIComponent("SELECT A, B");
        const raceUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${raceConditionSheet}&tq=${raceQuery}`;
        const raceResponse = await fetch(raceUrl);
        const raceData = await raceResponse.text();
        const raceJson = JSON.parse(raceData.substring(47).slice(0, -2));
        const raceRows = raceJson.table.rows;

        const raceStatusMap = {};
        raceRows.forEach((row) => {
          const slotId = row.c[0]?.v ? String(row.c[0].v).trim() : "";
          const userVal = row.c[1]?.v ? String(row.c[1].v).trim() : "";
          if (slotId) raceStatusMap[slotId] = userVal;
        });

        let allCleared = true;
        let matchedBookingId = false;

        for (let slotId of Object.keys(selection)) {
          if (selection[slotId] === 0) continue;

          const statusOrUser = raceStatusMap[slotId];
          console.log(`Slot ${slotId}: Status/User = ${statusOrUser}`);

          if (statusOrUser === "Expired") {
            console.log(`Slot ${slotId} is Expired. ✅`);
            continue;
          } else if (statusOrUser === bookingId) {
            console.log(
              `Slot ${slotId} belongs to current Booking ID (${bookingId}). ✅ Proceeding...`
            );
            matchedBookingId = true;
            break;
          } else {
            console.log(
              `Slot ${slotId} is held by another booking or not expired. ⏳`
            );
            allCleared = false;
          }
        }

        return { allCleared, matchedBookingId };
      };

      const checkSlotAvailability = async () => {
        const slotAvailabilitySheet = "Availability Helper";
        const seatQuery = encodeURIComponent("SELECT A, B");
        const seatUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(
          slotAvailabilitySheet
        )}&tq=${seatQuery}`;

        try {
          const slotIdToFullName = {
            "Day 1 - 22 Aug - Slot 1": "Day 1 - 22 Aug - Slot 1",
            "Day 1 - 22 Aug - Slot 2": "Day 1 - 22 Aug - Slot 2",
            "Day 1 - 22 Aug - Slot 3": "Day 1 - 22 Aug - Slot 3",
            "Day 1 - 22 Aug - Slot 4": "Day 1 - 22 Aug - Slot 4",
            "Day 2 - 23 Aug - Slot 1": "Day 2 - 23 Aug - Slot 1",
            "Day 2 - 23 Aug - Slot 2": "Day 2 - 23 Aug - Slot 2",
            "Day 2 - 23 Aug - Slot 3": "Day 2 - 23 Aug - Slot 3",
            "Day 2 - 23 Aug - Slot 4": "Day 2 - 23 Aug - Slot 4",
            "Day 3 - 24 Aug - Slot 1": "Day 3 - 24 Aug - Slot 1",
            "Day 3 - 24 Aug - Slot 2": "Day 3 - 24 Aug - Slot 2",
            "Day 3 - 24 Aug - Slot 3": "Day 3 - 24 Aug - Slot 3",
            "Day 3 - 24 Aug - Slot 4": "Day 3 - 24 Aug - Slot 4",
          };

          const seatResponse = await fetch(seatUrl);
          const seatData = await seatResponse.text();
          const seatJson = JSON.parse(seatData.substring(47).slice(0, -2));
          const seatRows = seatJson.table.rows;

          const freeSlotsMap = {};
          seatRows.forEach((row) => {
            const slotName = row.c[0]?.v
              ? String(row.c[0].v).trim().toLowerCase()
              : "";
            const freeCount = row.c[1]?.v ? parseInt(row.c[1].v) : 0;
            if (slotName) {
              freeSlotsMap[slotName] = freeCount;
              console.log(
                `Parsed from sheet: "${slotName}" → Free Slots = ${freeCount}`
              );
            }
          });

          let allSlotsHaveCapacity = true;

          for (let slotId in selection) {
            const seatsRequested = selection[slotId];
            if (seatsRequested === 0) continue;

            const fullSlotName = slotIdToFullName[slotId];
            const normalizedSlotName = fullSlotName.toLowerCase();
            const availableSeats = freeSlotsMap[normalizedSlotName];

            console.log(
              `Slot "${fullSlotName}": Available = ${availableSeats}, Requested = ${seatsRequested}`
            );

            if (availableSeats === undefined) {
              console.warn(`⚠️ Slot "${fullSlotName}" not found in sheet.`);
              allSlotsHaveCapacity = false;
            } else if (availableSeats < seatsRequested) {
              console.warn(`❌ Not enough seats in "${fullSlotName}".`);
              allSlotsHaveCapacity = false;
            } else {
              console.log(`✅ Slot "${fullSlotName}" has enough seats.`);
            }
          }

          return allSlotsHaveCapacity;
        } catch (err) {
          console.error("Error checking slot availability:", err);
          return false;
        }
      };

      const verifyBookingIdInRaceCondition = async () => {
        const raceConditionSheet = "Race Condition";
        const raceQuery = encodeURIComponent("SELECT A, B");
        const raceUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${raceConditionSheet}&tq=${raceQuery}`;
        const raceResponse = await fetch(raceUrl);
        const raceData = await raceResponse.text();
        const raceJson = JSON.parse(raceData.substring(47).slice(0, -2));
        const raceRows = raceJson.table.rows;

        const raceStatusMap = {};
        raceRows.forEach((row) => {
          const slotId = row.c[0]?.v ? String(row.c[0].v).trim() : "";
          const userVal = row.c[1]?.v ? String(row.c[1].v).trim() : "";
          if (slotId) raceStatusMap[slotId] = userVal;
        });

        let allMatched = true;

        for (let slotId of Object.keys(selection)) {
          if (selection[slotId] === 0) continue;

          const recordedVal = raceStatusMap[slotId];
          console.log(`Post-submission check: Slot ${slotId} = ${recordedVal}`);

          if (recordedVal !== bookingId) {
            console.warn(
              `Slot ${slotId} does not match bookingId. Status: ${recordedVal}`
            );
            allMatched = false;
          }

          if (recordedVal === "Expired") {
            console.warn(
              `Slot ${slotId} is marked as Expired — invalid after form submission.`
            );
            allMatched = false;
          }
        }

        return allMatched;
      };

      const checkActiveProcessing = async () => {
        const blockingSheet = "Slot Blocking Sources";
        const query = encodeURIComponent("SELECT *");
        const blockingUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${blockingSheet}&tq=${query}`;
        const response = await fetch(blockingUrl);
        const data = await response.text();
        const json = JSON.parse(data.substring(47).slice(0, -2));
        const rows = json.table.rows;

        return rows.some((row) => {
          const rowBookingId = row.c[3]?.v ? String(row.c[3].v).trim() : "";
          const status = row.c[4]?.v ? String(row.c[4].v).trim() : "";
          const activity = row.c[6]?.v ? String(row.c[6].v).trim() : "";

          const match =
            rowBookingId === bookingId &&
            status === "Processing" &&
            activity === "Active";
          if (match)
            console.log("MATCH FOUND:", rowBookingId, status, activity);
          return match;
        });
      };

      const lockSlots = async () => {
        const lockFormURL =
          "https://docs.google.com/forms/d/e/1FAIpQLSdT9FTGvtq2V7F00HBmrMgSczCTFVo5f54fiUsLIBsRBHpmIg/formResponse";

        for (let slotId in selection) {
          const count = selection[slotId];
          if (count === 0) continue;

          const formData = new FormData();
          formData.append("entry.1178870073", bookingId);
          formData.append("entry.1406053668", count);
          formData.append("entry.239115061", slotId);

          await fetch(lockFormURL, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });

          await new Promise((res) => setTimeout(res, 200));
        }
      };

      const submitFinalForms = async () => {
        const formBaseURL =
          "https://docs.google.com/forms/d/e/1FAIpQLSdKvVjiL3W356UZsWKy0BBRpqHxoFN7Q_5UQHUKlQDjxpNxBA/formResponse";
        const dayVal = document.getElementById("daySelector").value;
        const dayCode = `D${dayVal}`;

        for (let slotId in selection) {
          const count = selection[slotId];
          if (count === 0) continue;

          const slotMatch = slotId.match(/Slot\s*(\d+)/);
          const slotCode = slotMatch ? `S${slotMatch[1]}` : "S1";

          for (let i = 0; i < count; i++) {
            const formData = new FormData();
            formData.append("entry.706936465", dayCode);
            formData.append("entry.1380648863", slotCode);
            formData.append("entry.1536265716", bookingId);
            formData.append("entry.38505346", "Processing");

            await fetch(formBaseURL, {
              method: "POST",
              mode: "no-cors",
              body: formData,
            });

            await new Promise((r) => setTimeout(r, 200));
          }
        }
      };

      // ===== INITIALIZATION =====

      setInterval(fetchAndRenderTable, 5000);
    </script>
  </body>
</html>
