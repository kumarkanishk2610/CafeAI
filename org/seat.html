<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seat Booking - Cafe Kyaa!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      body {
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #334155 100%
        );
        min-height: 100vh;
      }

      .glass-effect {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .slide-up {
        animation: slideUp 0.6s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.8s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .glow-border {
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
      }

      .glow-border:focus {
        box-shadow: 0 0 25px rgba(59, 130, 246, 0.5);
      }

      .success-glow {
        animation: successPulse 2s infinite;
      }

      @keyframes successPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        50% {
          box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }
      }

      .error-glow {
        animation: errorPulse 2s infinite;
      }

      @keyframes errorPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
        50% {
          box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
        }
      }

      .table-selection-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .table-selection-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .gradient-text {
        background: linear-gradient(135deg, #60a5fa, #a78bfa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
    </style>
  </head>
  <body class="font-sans">
    <!-- Main Container -->
    <div
      class="min-h-screen flex items-center justify-center p-4 overflow-y-auto"
    >
      <div class="w-full max-w-sm py-4">
        <!-- Header -->
        <div class="text-center mb-4 fade-in">
          <div
            class="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-2"
          >
            <svg
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
              ></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-white mb-1">Seat Booking</h1>
          <p class="text-gray-400 text-sm">
            Cafe Kyaa! Table Assignment System
          </p>
        </div>
        <!-- Login Form -->
        <div id="loginForm" class="glass-effect rounded-xl p-4 mb-3 fade-in">
          <h2 class="text-lg font-semibold text-white mb-3 text-center">
            Authentication Required
          </h2>

          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1"
                >Password</label
              >
              <input
                type="password"
                id="passwordInput"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500 glow-border transition-all duration-300"
                placeholder="Enter seat booking password"
                onkeypress="if(event.key==='Enter') authenticate()"
              />
            </div>

            <button
              onclick="authenticate()"
              class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900"
            >
              <div class="flex items-center justify-center">
                <span id="loginBtnText">Authenticate</span>
                <div
                  id="loginSpinner"
                  class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full spinner ml-2"
                ></div>
              </div>
            </button>
          </div>
        </div>

        <!-- Seat Booking Form -->
        <div id="seatBookingForm" class="hidden">
          <!-- Input Fields -->
          <div class="glass-effect rounded-xl p-4 mb-3 fade-in">
            <h2 class="text-lg font-semibold text-white mb-3 text-center">
              Slot Selection
            </h2>

            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1"
                  >Slot</label
                >
                <select
                  id="topSlot"
                  class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 glow-border transition-all duration-300"
                >
                  <option value="">Select Slot</option>
                  <option value="Day 1 - 22 Aug - Slot 1">
                    Day 1 - 22 Aug - Slot 1
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 2">
                    Day 1 - 22 Aug - Slot 2
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 3">
                    Day 1 - 22 Aug - Slot 3
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 4">
                    Day 1 - 22 Aug - Slot 4
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 5">
                    Day 1 - 22 Aug - Slot 5
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 6">
                    Day 1 - 22 Aug - Slot 6
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 7">
                    Day 1 - 22 Aug - Slot 7
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 8">
                    Day 1 - 22 Aug - Slot 8
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 9">
                    Day 1 - 22 Aug - Slot 9
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 10">
                    Day 1 - 22 Aug - Slot 10
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 1">
                    Day 2 - 23 Aug - Slot 1
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 2">
                    Day 2 - 23 Aug - Slot 2
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 3">
                    Day 2 - 23 Aug - Slot 3
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 4">
                    Day 2 - 23 Aug - Slot 4
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 5">
                    Day 2 - 23 Aug - Slot 5
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 6">
                    Day 2 - 23 Aug - Slot 6
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 7">
                    Day 2 - 23 Aug - Slot 7
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 8">
                    Day 2 - 23 Aug - Slot 8
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 9">
                    Day 2 - 23 Aug - Slot 9
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 10">
                    Day 2 - 23 Aug - Slot 10
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 1">
                    Day 3 - 24 Aug - Slot 1
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 2">
                    Day 3 - 24 Aug - Slot 2
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 3">
                    Day 3 - 24 Aug - Slot 3
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 4">
                    Day 3 - 24 Aug - Slot 4
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 5">
                    Day 3 - 24 Aug - Slot 5
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 6">
                    Day 3 - 24 Aug - Slot 6
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 7">
                    Day 3 - 24 Aug - Slot 7
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 8">
                    Day 3 - 24 Aug - Slot 8
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 9">
                    Day 3 - 24 Aug - Slot 9
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 10">
                    Day 3 - 24 Aug - Slot 10
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- Booking Info Display -->
          <div class="glass-effect rounded-xl p-4 mb-3 fade-in">
            <h2 class="text-lg font-semibold text-white mb-3 text-center">
              Booking Information
            </h2>
            <div id="bookingInfo" class="text-gray-300 text-sm">
              <!-- Booking info will be populated here -->
            </div>
          </div>

          <!-- Manual Table Allocation Section -->
          <div class="glass-effect rounded-xl p-4 fade-in">
            <h2 class="text-lg font-semibold text-white mb-3 text-center">
              Table Allocation
            </h2>
            <p class="text-gray-300 text-sm text-center mb-4">
              Click on a booking ID above to allocate a table, or use manual
              entry below
            </p>

            <!-- Manual Entry Button -->
            <div class="space-y-3">
              <button
                onclick="openManualTableAllocation()"
                class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900"
              >
                Manual Table Allocation
              </button>
              <button
                onclick="logout()"
                class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Modal -->
    <div
      id="statusModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="glass-effect rounded-xl p-6 w-full max-w-sm mx-4 fade-in">
          <div class="text-center">
            <div
              id="statusIcon"
              class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl"
            ></div>
            <h3 id="statusTitle" class="text-xl font-bold mb-2"></h3>
            <p id="statusMessage" class="text-gray-300 text-sm mb-6"></p>
            <button
              onclick="closeStatusModal()"
              class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Modal -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen">
        <div class="glass-effect rounded-2xl p-8 text-center max-w-sm mx-4">
          <div class="relative">
            <div
              class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full spinner mx-auto mb-6"
            ></div>
            <div
              class="absolute inset-0 w-16 h-16 border-4 border-transparent border-blue-400 rounded-full animate-ping opacity-20"
            ></div>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Loading Data</h3>
          <p class="text-gray-300 text-sm">Fetching booking information...</p>
        </div>
      </div>
    </div>

    <!-- Table Allocation Modal -->
    <div
      id="tableAllocationModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden"
    >
      <div
        class="flex items-center justify-center min-h-screen p-4 overflow-y-auto"
      >
        <div
          class="glass-effect rounded-2xl p-6 w-full max-w-md mx-4 fade-in my-8"
        >
          <div class="text-center mb-6">
            <h3 class="text-xl font-bold text-white mb-2">
              Allocate Table to
              <span id="modalBookingId" class="text-blue-400">Guest</span>
            </h3>
            <p class="text-gray-300 text-sm">Select a table for this booking</p>
            <div
              id="modalBookingInfo"
              class="mt-3 p-3 bg-gray-800/50 rounded-lg text-sm text-gray-300"
            >
              <!-- Additional booking info will be displayed here -->
            </div>
          </div>

          <!-- Table Grid in Modal -->
          <div class="grid grid-cols-2 gap-3 mb-6 max-h-64 overflow-y-auto">
            <!-- Table buttons will be generated here -->
          </div>

          <!-- Action Buttons -->
          <div class="space-y-3">
            <button
              id="modalSubmitBtn"
              onclick="submitModalTableAllocation()"
              class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none"
              disabled
            >
              Allocate Table
            </button>
            <button
              onclick="closeTableAllocationModal()"
              class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // MD5 hash of password
      const ADMIN_PASSWORD_HASH = "0a7fe17e846e0e035cac91fff6ad7cef";
      let isAuthenticated = false;

      // Global variables
      let selectedTables = [];
      let maxSelections = 0;
      let bookingId = "";
      let slotName = "";
      let selectedBookingButton = null; // Track the currently selected booking button

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
      });

      // Check if already authenticated
      function checkAuth() {
        const authStatus = sessionStorage.getItem("seatAuthenticated");
        if (authStatus === "true") {
          isAuthenticated = true;
          showSeatBookingForm();
        } else {
          showLoginForm();
        }
      }

      // Authenticate user
      function authenticate() {
        const password = document.getElementById("passwordInput").value;
        const loginBtn = document.getElementById("loginBtnText");
        const loginSpinner = document.getElementById("loginSpinner");

        if (!password) {
          showStatus("Please enter a password", "error");
          return;
        }

        // Show loading state
        loginBtn.textContent = "Authenticating...";
        loginSpinner.classList.remove("hidden");

        // Simulate processing delay
        setTimeout(() => {
          const passwordHash = CryptoJS.MD5(password).toString();

          if (passwordHash === ADMIN_PASSWORD_HASH) {
            isAuthenticated = true;
            sessionStorage.setItem("seatAuthenticated", "true");
            showStatus("Authentication successful!", "success");
            showSeatBookingForm();
          } else {
            showStatus("Invalid password. Access denied.", "error");
            document.getElementById("passwordInput").value = "";
          }

          // Reset button state
          loginBtn.textContent = "Authenticate";
          loginSpinner.classList.add("hidden");
        }, 1000);
      }

      // Show seat booking form
      function showSeatBookingForm() {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("seatBookingForm").classList.remove("hidden");
        initializeSeatBooking();
      }

      // Show login form
      function showLoginForm() {
        document.getElementById("seatBookingForm").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("passwordInput").value = "";
      }

      // Logout
      function logout() {
        isAuthenticated = false;
        sessionStorage.removeItem("seatAuthenticated");
        showLoginForm();
        showStatus("Logged out successfully", "success");
      }

      // Show loading modal
      function showLoadingModal() {
        const loadingModal = document.getElementById("loadingModal");
        loadingModal.classList.remove("hidden");
      }

      // Hide loading modal
      function hideLoadingModal() {
        const loadingModal = document.getElementById("loadingModal");
        loadingModal.classList.add("hidden");
      }

      // Global variables for table allocation modal
      let modalSelectedTable = null;
      let currentModalBookingId = null;

      // Open table allocation modal for specific booking ID
      function openTableAllocationModal(bookingId) {
        currentModalBookingId = bookingId;
        modalSelectedTable = null;

        // Update modal title
        const modalBookingIdSpan = document.getElementById("modalBookingId");
        if (modalBookingIdSpan) {
          modalBookingIdSpan.textContent = bookingId;
        }

        // Populate booking info in modal
        populateModalBookingInfo(bookingId);

        // Generate table grid in modal
        generateModalTableGrid();

        // Show modal
        const modal = document.getElementById("tableAllocationModal");
        modal.classList.remove("hidden");
      }

      // Open manual table allocation modal
      function openManualTableAllocation() {
        // Prompt user to enter booking ID
        const manualBookingId = prompt("Please enter a booking ID:");
        if (!manualBookingId || manualBookingId.trim() === "") {
          showStatus("No booking ID provided", "error");
          return;
        }
        openTableAllocationModal(manualBookingId.trim());
      }

      // Close table allocation modal
      function closeTableAllocationModal() {
        const modal = document.getElementById("tableAllocationModal");
        modal.classList.add("hidden");
        modalSelectedTable = null;
        currentModalBookingId = null;

        // Reset the submit button
        const submitBtn = document.getElementById("modalSubmitBtn");
        if (submitBtn) {
          submitBtn.textContent = "Allocate Table";
          submitBtn.disabled = true;
        }
      }

      // Populate booking info in modal
      function populateModalBookingInfo(bookingId) {
        const modalBookingInfo = document.getElementById("modalBookingInfo");
        if (!modalBookingInfo) return;

        // Check payment status
        const hasPaid =
          (window.paymentStatuses && window.paymentStatuses[bookingId]) ||
          false;
        const paymentStatus = hasPaid ? "✅ Paid" : "❌ Not Paid";
        const paymentColor = hasPaid ? "text-green-400" : "text-red-400";

        // Check if already has seat allocated
        const seatNumbers =
          (window.seatAllocations && window.seatAllocations[bookingId]) || [];
        const seatStatus =
          seatNumbers.length > 0
            ? `🪑 Seat(s): ${seatNumbers.join(", ")}`
            : "🪑 No seat allocated";
        const seatColor =
          seatNumbers.length > 0 ? "text-green-400" : "text-yellow-400";

        modalBookingInfo.innerHTML = `
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-400">Payment Status:</span>
              <span class="${paymentColor} font-medium">${paymentStatus}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">Seat Status:</span>
              <span class="${seatColor} font-medium">${seatStatus}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">Slot:</span>
              <span class="text-white font-medium">${
                slotName || "Not specified"
              }</span>
            </div>
          </div>
        `;
      }

      // Generate table grid for modal
      function generateModalTableGrid() {
        const tableGrid = document.querySelector("#tableAllocationModal .grid");
        const allTables = [
          "A1",
          "A2",
          "B1",
          "B2",
          "C1",
          "C2",
          "D1",
          "D2",
          "E1",
          "E2",
          "F1",
          "F2",
        ];

        tableGrid.innerHTML = allTables
          .map((table) => {
            const isOccupied =
              window.occupiedSeats && window.occupiedSeats.includes(table);

            if (isOccupied) {
              return `
                <button 
                  class="p-4 border border-red-300 rounded-lg bg-red-50 text-sm font-medium text-red-700 table-selection-btn transition-all duration-200 cursor-not-allowed"
                  data-table="${table}"
                  disabled
                >
                  <div class="text-center">
                    <div class="font-bold">${table}</div>
                    <div class="text-xs text-red-600">Occupied</div>
                  </div>
                </button>
              `;
            } else {
              return `
                <button 
                  class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium text-gray-700 table-selection-btn transition-all duration-200"
                  data-table="${table}"
                  onclick="selectTableInModal('${table}')"
                >
                  ${table}
                </button>
              `;
            }
          })
          .join("");
      }

      // Select table in modal
      function selectTableInModal(tableSeat) {
        // Clear previous selection
        const allButtons = document.querySelectorAll(
          "#tableAllocationModal .table-selection-btn"
        );
        allButtons.forEach((btn) => {
          if (!btn.disabled) {
            btn.className =
              "p-4 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium text-gray-700 table-selection-btn transition-all duration-200";
          }
        });

        // Select new table
        const button = document.querySelector(
          `#tableAllocationModal [data-table="${tableSeat}"]`
        );
        if (button && !button.disabled) {
          button.className =
            "p-4 border border-blue-500 rounded-lg bg-blue-500 text-white text-sm font-medium table-selection-btn transition-all duration-200";
          modalSelectedTable = tableSeat;

          // Enable submit button
          const submitBtn = document.getElementById("modalSubmitBtn");
          if (submitBtn) {
            submitBtn.disabled = false;
          }
        }
      }

      // Submit table allocation from modal
      async function submitModalTableAllocation() {
        if (!modalSelectedTable || !currentModalBookingId) {
          showStatus("Please select a table first", "error");
          return;
        }

        try {
          // Show loading state
          const submitBtn = document.getElementById("modalSubmitBtn");
          const originalText = submitBtn.textContent;
          submitBtn.textContent = "Allocating...";
          submitBtn.disabled = true;

          // Submit to Google Form
          const formData = new FormData();
          formData.append("entry.863334335", currentModalBookingId); // Booking ID
          formData.append("entry.1779047001", slotName); // Slot Name
          formData.append("entry.1374097765", modalSelectedTable); // Table/Seat

          const response = await fetch(
            "https://docs.google.com/forms/d/e/1FAIpQLScr_5q__XyAbcK3wfBdKCEFwN-iDD6M21jU3U9Ss0u2FQRH0g/formResponse",
            {
              method: "POST",
              body: formData,
              mode: "no-cors", // Required for Google Forms
            }
          );

          

          // Store values before closing modal
          const allocatedTable = modalSelectedTable;
          const allocatedBookingId = currentModalBookingId;

          // Close modal
          closeTableAllocationModal();

          // Show success message
          showStatus(
            `Table ${allocatedTable} allocated to booking ${allocatedBookingId}`,
            "success"
          );

          // Refresh the booking data to show updated seat allocations
          setTimeout(() => {
            loadBookingDataSilent();
          }, 1000);
        } catch (error) {
          
          showStatus("Error allocating table: " + error.message, "error");

          // Reset button
          const submitBtn = document.getElementById("modalSubmitBtn");
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }

      // Initialize seat booking page
      function initializeSeatBooking() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        bookingId = urlParams.get("bookingId") || "";
        slotName = urlParams.get("slot") || "";

        
        
        

        // Always initialize the page components
        displayBookingInfo();
        populateTopFields();

        // If we have URL parameters, load data and set up auto-refresh
        if (bookingId && slotName) {
          loadBookingData();
          // Set up auto-refresh every 5 seconds (without loading modal)
          setInterval(() => {
            
            loadBookingDataSilent();
          }, 5000); // 5000ms = 5 seconds
        } else {
          // No popup needed for manual entry
        }
      }

      // Display booking information
      function displayBookingInfo() {
        const bookingInfoDiv = document.getElementById("bookingInfo");
        bookingInfoDiv.innerHTML = `
          <div class="space-y-2">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-400">Expected Guests:</span>
              <span class="text-white font-semibold" id="expectedGuestsCount">-</span>
            </div>
            <div id="expectedGuestsList" class="text-sm text-gray-300">
              <!-- Expected guests list will be populated here -->
            </div>
          </div>
        `;
      }

      // Populate top fields from URL parameters
      function populateTopFields() {
        const topSlot = document.getElementById("topSlot");

        if (topSlot) {
          topSlot.value = slotName;
        }

        // Add event listeners for changes
        if (topSlot) {
          topSlot.addEventListener("change", function () {
            slotName = this.value;
            // Reload data when slot changes
            if (slotName) {
              loadBookingData();
            }
          });
        }
      }

      // Update selection counter
      function updateSelectionCounter() {
        const counter = document.getElementById("selectedCount");
        const maxDisplay = document.getElementById("maxSelections");

        if (counter) counter.textContent = selectedTables.length;
        if (maxDisplay) maxDisplay.textContent = maxSelections;
      }

      // Update submit button state
      function updateSubmitButtonState() {
        const submitBtn = document.getElementById("submitSelectionBtn");

        if (submitBtn) {
          if (selectedTables.length > 0) {
            submitBtn.disabled = false;
            submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            submitBtn.classList.add(
              "bg-gradient-to-r",
              "from-blue-500",
              "to-purple-600",
              "hover:from-blue-600",
              "hover:to-purple-700"
            );
          } else {
            submitBtn.disabled = true;
            submitBtn.classList.remove(
              "bg-gradient-to-r",
              "from-blue-500",
              "to-purple-600",
              "hover:from-blue-600",
              "hover:to-purple-700"
            );
            submitBtn.classList.add("bg-gray-400", "cursor-not-allowed");
          }
        }
      }

      // Load booking data to determine max selections
      async function loadBookingData() {
        try {
          // Check if we have the required parameters
          if (!slotName) {
            
            displayExpectedGuests(0, []);
            return;
          }

          // Show loading modal
          showLoadingModal();

          

          // Fetch data from Reservations sheet
          const response = await fetch(
            `https://docs.google.com/spreadsheets/d/1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc/gviz/tq?tqx=out:json&tq=SELECT%20F%2C%20H%2C%20I%2C%20K%20WHERE%20F%20%3D%20'${encodeURIComponent(
              slotName
            )}'%20AND%20H%20%3D%20'Booked'&gid=706665562`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          const data = JSON.parse(text.substring(47, text.length - 2));

          

          if (data.status === "error") {
            throw new Error(
              `Query error: ${data.errors?.[0]?.message || "Unknown error"}`
            );
          }

          if (!data.table || !data.table.rows) {
            
            displayExpectedGuests(0, []);
            return;
          }

          // Extract booking IDs from column I
          const expectedGuests = data.table.rows.length;
          const bookingIds = data.table.rows
            .map((row) => row.c[2]?.v || "")
            .filter((id) => id);

          
          
           => typeof id)
          );

          // Fetch payment status for all booking IDs
          const paymentStatuses = await fetchPaymentStatuses(bookingIds);

          // Fetch seat allocations for all booking IDs
          const seatAllocations = await fetchSeatAllocations(bookingIds);

          // Display expected guests list with payment status and seat allocation
          displayExpectedGuests(
            expectedGuests,
            bookingIds,
            paymentStatuses,
            seatAllocations
          );

          // Set max selections for table selection
          maxSelections = 1; // Only allow 1 table selection
          

          // Update the display
          updateSelectionCounter();
          updateSubmitButtonState();

          // Hide loading modal
          hideLoadingModal();
        } catch (error) {
          
          showStatus("Error loading booking data: " + error.message, "error");

          // Hide loading modal on error
          hideLoadingModal();
        }
      }

      // Load booking data silently (without loading modal) for auto-refresh
      async function loadBookingDataSilent() {
        try {
          // Check if we have the required parameters
          if (!slotName) {
            
            displayExpectedGuests(0, []);
            return;
          }

          

          // Fetch data from Reservations sheet
          const response = await fetch(
            `https://docs.google.com/spreadsheets/d/1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc/gviz/tq?tqx=out:json&tq=SELECT%20F%2C%20H%2C%20I%2C%20K%20WHERE%20F%20%3D%20'${encodeURIComponent(
              slotName
            )}'%20AND%20H%20%3D%20'Booked'&gid=706665562`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          const data = JSON.parse(text.substring(47, text.length - 2));

          

          if (data.status === "error") {
            throw new Error(
              `Query error: ${data.errors?.[0]?.message || "Unknown error"}`
            );
          }

          if (!data.table || !data.table.rows) {
            
            displayExpectedGuests(0, []);
            return;
          }

          // Extract booking IDs from column I
          const expectedGuests = data.table.rows.length;
          const bookingIds = data.table.rows
            .map((row) => row.c[2]?.v || "")
            .filter((id) => id);

          
          
           => typeof id)
          );

          // Fetch payment status for all booking IDs
          const paymentStatuses = await fetchPaymentStatuses(bookingIds);

          // Fetch seat allocations for all booking IDs
          const seatAllocations = await fetchSeatAllocations(bookingIds);

          // Display expected guests list with payment status and seat allocation
          displayExpectedGuests(
            expectedGuests,
            bookingIds,
            paymentStatuses,
            seatAllocations
          );

          // Set max selections for table selection
          maxSelections = 1; // Only allow 1 table selection
          

          // Update the display
          updateSelectionCounter();
          updateSubmitButtonState();
        } catch (error) {
          
          // Don't show status modal for silent errors
        }
      }

      // Fetch payment statuses from Payment Tracker
      async function fetchPaymentStatuses(bookingIds) {
        try {
          

          // Fetch all payment data from Payment Tracker
          const response = await fetch(
            `https://docs.google.com/spreadsheets/d/1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc/gviz/tq?tqx=out:json&tq=SELECT%20A%2C%20E&gid=364335196`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          const data = JSON.parse(text.substring(47, text.length - 2));

          

          if (data.status === "error") {
            throw new Error(
              `Query error: ${data.errors?.[0]?.message || "Unknown error"}`
            );
          }

          // Create a map of booking ID to payment status
          const paymentMap = {};

          if (data.table && data.table.rows) {
            data.table.rows.forEach((row) => {
              const bookingId = row.c[0]?.v || "";
              const paymentStatus = row.c[1]?.v || false;

              if (bookingId) {
                paymentMap[bookingId] = paymentStatus === true;
              }
            });
          }

          
          // Store payment statuses globally for access in modal
          window.paymentStatuses = paymentMap;
          return paymentMap;
        } catch (error) {
          
          return {};
        }
      }

      // Fetch seat allocations from VenueTableReservation sheet
      async function fetchSeatAllocations(bookingIds) {
        try {
          

          // Fetch data from VenueTableReservation sheet (GID: 365103881)
          const response = await fetch(
            `https://docs.google.com/spreadsheets/d/1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc/gviz/tq?tqx=out:json&tq=SELECT%20B%2C%20D&gid=365103881`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          const data = JSON.parse(text.substring(47, text.length - 2));

          

          if (data.status === "error") {
            throw new Error(
              `Query error: ${data.errors?.[0]?.message || "Unknown error"}`
            );
          }

          // Create a map of booking ID to seat numbers (array for multiple seats)
          const seatAllocations = {};

          if (data.table && data.table.rows) {
            
            data.table.rows.forEach((row, index) => {
              const bookingId = row.c[0]?.v || "";
              const seatNumber = row.c[1]?.v || "";

              // Convert both to strings for comparison
              const bookingIdStr = bookingId.toString();
              const bookingIdsStr = bookingIds.map((id) => id.toString());

              , seatNumber="${seatNumber}"`
              );
              
              :`,
                bookingIdsStr.includes(bookingIdStr)
              );

              // Only include if this booking ID is in our expected guests list

              if (
                bookingId &&
                seatNumber &&
                bookingIdsStr.includes(bookingIdStr)
              ) {
                // Initialize array if not exists, then add seat number
                if (!seatAllocations[bookingId]) {
                  seatAllocations[bookingId] = [];
                }
                seatAllocations[bookingId].push(seatNumber);
                `
                );
              } else {
                
                  )})`
                );
              }
            });
          } else {
            
          }

          
          // Make seatAllocations accessible globally
          window.seatAllocations = seatAllocations;

          // Extract all seat names into a simple array
          const allOccupiedSeats = [];
          Object.values(seatAllocations).forEach((seats) => {
            seats.forEach((seat) => allOccupiedSeats.push(seat));
          });
          window.occupiedSeats = allOccupiedSeats;
          

          // Note: Table grid is regenerated when modal is opened

          return seatAllocations;
        } catch (error) {
          
          return {};
        }
      }

      // Display expected guests list
      function displayExpectedGuests(
        count,
        bookingIds,
        paymentStatuses,
        seatAllocations
      ) {
        const countElement = document.getElementById("expectedGuestsCount");
        const listElement = document.getElementById("expectedGuestsList");

        if (countElement) {
          countElement.textContent = count;
        }

        if (listElement) {
          if (bookingIds.length === 0) {
            listElement.innerHTML =
              '<span class="text-gray-500 italic">No expected guests found</span>';
          } else {
            // Create individual buttons for each guest entry
            const totalGuests = bookingIds.length;
            const leftColumn = bookingIds.slice(0, 6);
            const rightColumn = bookingIds.slice(6, 12);

            const leftColumnHTML = leftColumn
              .map((id, index) => {
                const hasPaid = paymentStatuses[id] || false;
                const paymentIcon = hasPaid ? "✅" : "❌";
                const paymentColor = hasPaid
                  ? "text-green-400"
                  : "text-red-400";

                // Get the specific seat for this guest instance
                const seatNumbers = seatAllocations[id] || [];
                const guestIndexForThisBooking =
                  bookingIds
                    .slice(0, index + 1)
                    .filter((bookingId) => bookingId === id).length - 1;
                const seatNumber =
                  seatNumbers[guestIndexForThisBooking] || null;

                const seatBadge = seatNumber
                  ? `<span class="px-1.5 py-0.5 bg-green-500 text-white text-xs rounded font-mono">${seatNumber}</span>`
                  : `<span class="px-1.5 py-0.5 bg-red-500 text-white text-xs rounded font-mono">NA</span>`;

                // Only disable if this specific guest already has a seat
                const isDisabled = seatNumber ? true : false;
                return `<button 
                  onclick="selectBooking('${id}')"
                  class="w-full p-2 rounded-lg border border-gray-600 hover:border-blue-500 hover:bg-gray-700/50 transition-all duration-200 text-left ${
                    isDisabled
                      ? "opacity-50 cursor-not-allowed"
                      : "cursor-pointer hover:scale-105"
                  }"
                  ${isDisabled ? "disabled" : ""}
                  title="${
                    isDisabled
                      ? "Already has seat allocated"
                      : "Click to allocate seat"
                  }"
                >
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-white font-mono">${id}</span>
                    <span class="text-sm ${paymentColor} font-medium">${paymentIcon}</span>
                    ${seatBadge}
                  </div>
                </button>`;
              })
              .join("");

            const rightColumnHTML = rightColumn
              .map((id, index) => {
                const hasPaid = paymentStatuses[id] || false;
                const paymentIcon = hasPaid ? "✅" : "❌";
                const paymentColor = hasPaid
                  ? "text-green-400"
                  : "text-red-400";

                // Get the specific seat for this guest instance
                const seatNumbers = seatAllocations[id] || [];
                const guestIndexForThisBooking =
                  bookingIds
                    .slice(0, index + 7)
                    .filter((bookingId) => bookingId === id).length - 1;
                const seatNumber =
                  seatNumbers[guestIndexForThisBooking] || null;

                const seatBadge = seatNumber
                  ? `<span class="px-1.5 py-0.5 bg-green-500 text-white text-xs rounded font-mono">${seatNumber}</span>`
                  : `<span class="px-1.5 py-0.5 bg-red-500 text-white text-xs rounded font-mono">NA</span>`;

                // Only disable if this specific guest already has a seat
                const isDisabled = seatNumber ? true : false;
                return `<button 
                  onclick="selectBooking('${id}')"
                  class="w-full p-2 rounded-lg border border-gray-600 hover:border-blue-500 hover:bg-gray-700/50 transition-all duration-200 text-left ${
                    isDisabled
                      ? "opacity-50 cursor-not-allowed"
                      : "cursor-pointer hover:scale-105"
                  }"
                  ${isDisabled ? "disabled" : ""}
                  title="${
                    isDisabled
                      ? "Already has seat allocated"
                      : "Click to allocate seat"
                  }"
                >
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-white font-mono">${id}</span>
                    <span class="text-sm ${paymentColor} font-medium">${paymentIcon}</span>
                    ${seatBadge}
                  </div>
                </button>`;
              })
              .join("");

            listElement.innerHTML = `
              <div class="bg-gray-800/50 rounded-lg p-3 mt-2">
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-1">
                    ${leftColumnHTML}
                  </div>
                  <div class="border-l border-gray-600 pl-4">
                    <div class="space-y-1">
                      ${rightColumnHTML}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
        }
      }

      // Submit table selection
      async function submitTableSelection() {
        const topBookingId = document.getElementById("topBookingId");
        const selectedBookingId = topBookingId ? topBookingId.value.trim() : "";

        if (!selectedBookingId) {
          showStatus("Please enter a booking ID", "error");
          return;
        }

        if (selectedTables.length === 0) {
          showStatus("Please select a table", "error");
          return;
        }

        if (selectedTables.length !== 1) {
          showStatus("Please select exactly 1 table", "error");
          return;
        }

        try {
          

          // Submit to Google Form
          const formData = new FormData();
          formData.append("entry.863334335", selectedBookingId); // Booking ID
          formData.append("entry.1779047001", slotName); // Slot Name
          formData.append("entry.1374097765", selectedTables[0]); // Table/Seat

          const response = await fetch(
            "https://docs.google.com/forms/d/e/1FAIpQLScr_5q__XyAbcK3wfBdKCEFwN-iDD6M21jU3U9Ss0u2FQRH0g/formResponse",
            {
              method: "POST",
              body: formData,
              mode: "no-cors", // Required for Google Forms
            }
          );

          
          showStatus(
            `Successfully assigned booking ${selectedBookingId} to table ${selectedTables[0]}`,
            "success"
          );
        } catch (error) {
          
          showStatus("Error submitting table selection", "error");
        }
      }

      // Show status modal
      function showStatus(message, type) {
        const statusModal = document.getElementById("statusModal");
        const statusIcon = document.getElementById("statusIcon");
        const statusTitle = document.getElementById("statusTitle");
        const statusMessage = document.getElementById("statusMessage");

        // Set the last status type for tracking
        lastStatusType = type;

        // Set icon, title, and message based on type
        if (type === "success") {
          statusIcon.innerHTML = "✅";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-green-500/20 border-2 border-green-500/40 success-glow";
          statusTitle.textContent = "Success!";
          statusTitle.className = "text-2xl font-bold text-green-200 mb-2";
        } else if (type === "error") {
          statusIcon.innerHTML = "❌";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-red-500/20 border-2 border-red-500/40 error-glow";
          statusTitle.textContent = "Error";
          statusTitle.className = "text-2xl font-bold text-red-200 mb-2";
        } else {
          statusIcon.innerHTML = "ℹ️";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-blue-500/20 border-2 border-blue-500/40";
          statusTitle.textContent = "Information";
          statusTitle.className = "text-2xl font-bold text-blue-200 mb-2";
        }

        statusMessage.textContent = message;
        statusMessage.className = "text-gray-300 text-base";

        // Show modal
        statusModal.classList.remove("hidden");
      }

      // Submit table selection (legacy function - kept for compatibility)
      async function submitTableSelection() {
        showStatus(
          "Please use the booking ID buttons above or manual allocation button",
          "error"
        );
      }

      // Select booking function - opens table allocation modal
      function selectBooking(bookingId) {
        // Allow selecting bookings even if they already have some seats allocated
        // The system will handle multiple seat allocations per booking ID

        // Reset previous button styling
        if (selectedBookingButton) {
          selectedBookingButton.classList.remove(
            "border-blue-500",
            "bg-blue-500/20"
          );
          selectedBookingButton.classList.add("border-gray-600");
        }

        // Find and highlight the clicked button
        const clickedButton = event.target.closest("button");
        if (clickedButton) {
          clickedButton.classList.remove("border-gray-600");
          clickedButton.classList.add("border-blue-500", "bg-blue-500/20");
          selectedBookingButton = clickedButton;
        }

        // Open table allocation modal
        openTableAllocationModal(bookingId);
      }

      // Global variable to track last status type
      let lastStatusType = null;

      // Close status modal
      function closeStatusModal() {
        const statusModal = document.getElementById("statusModal");
        statusModal.classList.add("hidden");

        // If the last status was a success, refresh the data instead of reloading
        if (lastStatusType === "success") {
          loadBookingDataSilent();
        }
      }
    </script>
  </body>
</html>
