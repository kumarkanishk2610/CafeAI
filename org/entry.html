<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Management - Cafe Kyaa!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body {
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #334155 100%
        );
        min-height: 100vh;
      }

      .glass-effect {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      .glow-border {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }

      .glow-border:focus {
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
      }

      .success-glow {
        animation: successPulse 2s ease-in-out;
      }

      @keyframes successPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(34, 197, 94, 0.6);
        }
      }

      .error-glow {
        animation: errorPulse 2s ease-in-out;
      }

      @keyframes errorPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
        }
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-up {
        animation: slideUp 0.6s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pulse-glow {
        animation: pulseGlow 2s ease-in-out infinite;
      }

      @keyframes pulseGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
        }
      }

      .scanning-indicator {
        position: relative;
        overflow: hidden;
      }

      .scanning-indicator::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        animation: scanning 2s linear infinite;
      }

      @keyframes scanning {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      #qr-reader {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      #qr-reader__scan_region {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        overflow: hidden;
      }

      #qr-reader__scan_region video {
        border-radius: 12px;
      }

      #qr-reader__dashboard {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        margin-top: 10px;
        padding: 10px;
      }

      #qr-reader__dashboard button {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      #qr-reader__dashboard button:hover {
        transform: scale(1.05);
      }
    </style>
  </head>
  <body class="font-sans">
    <!-- Loading Modal -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen">
        <div class="glass-effect rounded-3xl p-10 text-center max-w-sm mx-4">
          <div class="relative">
            <div
              class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full spinner mx-auto mb-6"
            ></div>
            <div
              class="absolute inset-0 w-16 h-16 border-4 border-transparent border-green-400 rounded-full animate-ping opacity-20"
            ></div>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Processing Entry</h3>
          <p class="text-gray-300 text-base">Verifying booking details...</p>
          <div class="mt-4 flex justify-center space-x-1">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce"></div>
            <div
              class="w-2 h-2 bg-green-500 rounded-full animate-bounce"
              style="animation-delay: 0.1s"
            ></div>
            <div
              class="w-2 h-2 bg-green-500 rounded-full animate-bounce"
              style="animation-delay: 0.2s"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Popup Modal -->
    <div
      id="statusModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="glass-effect rounded-3xl p-8 text-center max-w-md mx-4 slide-up"
        >
          <div class="mb-6">
            <div
              id="statusIcon"
              class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl"
            >
              <!-- Icon will be set dynamically -->
            </div>
            <h3 id="statusTitle" class="text-2xl font-bold text-white mb-2">
              <!-- Title will be set dynamically -->
            </h3>
            <p id="statusMessage" class="text-gray-300 text-base">
              <!-- Message will be set dynamically -->
            </p>
          </div>

          <!-- View Details Button (hidden by default) -->
          <div id="statusViewDetailsBtn" class="hidden mb-4">
            <button
              onclick="showReservationsPopup()"
              class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              📋 View Reservation Details
            </button>
          </div>

          <button
            onclick="closeStatusModal()"
            class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Reservations Popup Modal -->
    <div
      id="reservationsPopup"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="glass-effect rounded-2xl p-6 w-full max-w-4xl max-h-[80vh] overflow-hidden"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Reservation Details</h3>
            <button
              onclick="closeReservationsPopup()"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <div class="overflow-x-auto overflow-y-auto max-h-[60vh]">
            <table class="w-full text-left">
              <thead class="bg-gray-800/50 sticky top-0">
                <tr>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Slot Name
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Timestamp
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Status
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Booked By
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Txn ID
                  </th>
                </tr>
              </thead>
              <tbody id="reservationsTableBody">
                <!-- Data will be populated here -->
              </tbody>
            </table>
          </div>

          <div class="mt-4 text-center">
            <button
              onclick="closeReservationsPopup()"
              class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition-all duration-300"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Container -->
    <div class="h-screen flex items-center justify-center p-2">
      <div class="w-full max-w-sm">
        <!-- Header -->
        <div class="text-center mb-6 slide-up">
          <div
            class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full mb-3 shadow-lg"
          >
            <svg
              class="w-8 h-8 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </div>
          <h1
            class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent"
          >
            Entry Management
          </h1>
          <p class="text-gray-300 text-base">Cafe Kyaa! Entry Verification</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="glass-effect rounded-2xl p-8 mb-6 slide-up">
          <h2 class="text-xl font-bold text-white mb-6 text-center">
            🔐 Authentication Required
          </h2>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-2"
                >Password</label
              >
              <input
                type="password"
                id="passwordInput"
                class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-green-500 glow-border transition-all duration-300 text-center"
                placeholder="Enter entry password"
              />
            </div>

            <button
              onclick="authenticate()"
              class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              <div class="flex items-center justify-center">
                <span id="loginBtnText">🔓 Authenticate</span>
                <div
                  id="loginSpinner"
                  class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full spinner ml-3"
                ></div>
              </div>
            </button>
          </div>
        </div>

        <!-- QR Scanner Form -->
        <div
          id="scannerForm"
          class="glass-effect rounded-2xl p-8 hidden slide-up"
        >
          <h2 class="text-xl font-bold text-white mb-6 text-center">
            📱 QR Code Scanner
          </h2>

          <div class="space-y-6">
            <div class="scanning-indicator">
              <div
                id="qr-reader"
                class="rounded-xl overflow-hidden shadow-lg"
              ></div>
            </div>

            <div class="text-center">
              <p class="text-gray-300 text-sm mb-2">
                Point camera at the QR code to scan entry
              </p>
              <div class="flex items-center justify-center space-x-2">
                <div
                  class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
                ></div>
                <span class="text-green-400 text-xs font-medium"
                  >Ready to scan</span
                >
              </div>
            </div>
          </div>

          <!-- Logout Button -->
          <div class="mt-6 pt-6 border-t border-gray-600">
            <button
              onclick="logout()"
              class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              🚪 Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // MD5 hash of password (same as admin for now, you can change this)
      const ENTRY_PASSWORD_HASH = "0a7fe17e846e0e035cac91fff6ad7cef";

      let isAuthenticated = false;
      let html5QrcodeScanner = null;

      // Check if already authenticated
      function checkAuth() {
        const authStatus = sessionStorage.getItem("entryAuthenticated");
        if (authStatus === "true") {
          isAuthenticated = true;
          showScannerForm();
        }
      }

      // Authenticate user
      function authenticate() {
        const password = document.getElementById("passwordInput").value;
        const loginBtn = document.getElementById("loginBtnText");
        const loginSpinner = document.getElementById("loginSpinner");

        if (!password) {
          showStatus("Please enter a password", "error");
          return;
        }

        // Show loading state
        loginBtn.textContent = "Authenticating...";
        loginSpinner.classList.remove("hidden");

        // Simulate processing delay
        setTimeout(() => {
          const passwordHash = CryptoJS.MD5(password).toString();

          if (passwordHash === ENTRY_PASSWORD_HASH) {
            isAuthenticated = true;
            sessionStorage.setItem("entryAuthenticated", "true");
            showStatus("Authentication successful!", "success");
            showScannerForm();
          } else {
            showStatus("Invalid password. Access denied.", "error");
            document.getElementById("passwordInput").value = "";
          }

          // Reset button state
          loginBtn.textContent = "Authenticate";
          loginSpinner.classList.add("hidden");
        }, 1000);
      }

      // Show scanner form
      function showScannerForm() {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("scannerForm").classList.remove("hidden");
        initializeQRScanner();
      }

      // Show login form
      function showLoginForm() {
        document.getElementById("scannerForm").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("passwordInput").value = "";
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear();
        }
      }

      // Logout
      function logout() {
        isAuthenticated = false;
        sessionStorage.removeItem("entryAuthenticated");
        showLoginForm();
        showStatus("Logged out successfully", "success");

        // Hide view details button in status modal
        const statusViewDetailsBtn = document.getElementById(
          "statusViewDetailsBtn"
        );
        if (statusViewDetailsBtn) {
          statusViewDetailsBtn.classList.add("hidden");
        }

        // Clear reservations data
        window.currentReservationsData = null;
      }

      // Initialize QR Scanner
      function initializeQRScanner() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear();
        }

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0,
        };

        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config, false);

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      }

      // Handle successful QR scan
      function onScanSuccess(decodedText, decodedResult) {
        // Don't stop scanner - keep camera running
        // Just process the scanned booking ID
        processEntry(decodedText);
      }

      // Handle QR scan failure
      function onScanFailure(error) {
        // Handle scan failure, usually ignore
        // Disabled console logging to prevent spam
        // console.warn(`QR scan error = ${error}`);
      }

      // Process entry verification
      async function processEntry(bookingId) {
        console.log("=== ENTRY PROCESSING START ===");
        console.log("Scanned Booking ID:", bookingId);
        console.log("Booking ID type:", typeof bookingId);
        console.log("Booking ID length:", bookingId.length);

        document.getElementById("loadingModal").classList.remove("hidden");

        try {
          // Step 1: Check Payment Tracker tab - column A for booking ID existence
          console.log("\n--- STEP 1: Payment Tracker Check ---");
          const paymentTrackerStatus = await checkPaymentTracker(bookingId);
          console.log("Payment Tracker Status:", paymentTrackerStatus);

          if (paymentTrackerStatus === "not_found") {
            console.log("❌ ID Not Found in Payment Tracker");
            showStatus("ID Not Found", "error");
            return;
          } else if (paymentTrackerStatus === "not_approved") {
            console.log("❌ Admin Confirmation Pending");
            showStatus("Admin Confirmation Pending", "error");
            return;
          }

          console.log("✅ Payment Tracker Check Passed");

          // Step 2: Check Raw Data tab for existing entry in column I
          console.log("\n--- STEP 2: Raw Data Duplicate Check ---");
          const entryStatus = await checkExistingEntry(bookingId);
          console.log("Entry Status:", entryStatus);

          if (entryStatus === "exists") {
            console.log("❌ User already entered");
            // Still fetch reservations data to show details
            const reservationsData = await fetchReservationsData(bookingId);
            console.log("Reservations Data Count:", reservationsData.length);
            window.currentReservationsData = reservationsData;

            showStatus(
              "User already entered. You can still view reservation details.",
              "error"
            );
            showViewDetailsButton();
            return;
          }

          console.log("✅ Raw Data Check Passed");

          // Step 3: Fetch Reservations data for popup display
          console.log("\n--- STEP 3: Fetch Reservations Data ---");
          const reservationsData = await fetchReservationsData(bookingId);
          console.log("Reservations Data Count:", reservationsData.length);
          console.log("Reservations Data:", reservationsData);
          window.currentReservationsData = reservationsData; // Store for popup

          // Step 4: Log entry
          console.log("\n--- STEP 4: Log Entry ---");
          const logResult = await logEntry(bookingId);
          console.log("Log Result:", logResult);

          if (logResult === "success") {
            console.log("✅ Entry Logged Successfully");
            showStatus(
              "Entry successful! Click 'View Details' to see reservation info.",
              "success"
            );
            // Show the view details button
            showViewDetailsButton();
          } else {
            console.log("❌ Error Logging Entry");
            showStatus("Error logging entry", "error");
          }

          console.log("=== ENTRY PROCESSING COMPLETE ===");
        } catch (error) {
          console.error("❌ Entry processing error:", error);
          console.error("Error stack:", error.stack);
          showStatus("Error processing entry", "error");
        } finally {
          document.getElementById("loadingModal").classList.add("hidden");
          // No need to restart scanner - it's already running
        }
      }

      // Check Payment Tracker tab - column A for booking ID and column E for approval status
      async function checkPaymentTracker(bookingId) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "364335196"; // Payment Tracker tab GID (corrected)

        console.log("🔍 Checking Payment Tracker...");
        console.log("Spreadsheet ID:", spreadsheetId);
        console.log("GID:", gid);
        console.log("Booking ID to search:", bookingId);

        try {
          const query = encodeURIComponent(
            `SELECT A, E WHERE A = ${bookingId}`
          );
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          console.log("Query:", query);
          console.log("Full URL:", url);

          const response = await fetch(url);
          console.log("Response status:", response.status);
          console.log("Response ok:", response.ok);

          const text = await response.text();
          console.log("Raw response text length:", text.length);
          console.log(
            "Raw response text (first 200 chars):",
            text.substring(0, 200)
          );

          const jsonText = text.substring(47).slice(0, -2); // Remove "google.visualization.Query.setResponse(" and ");"
          console.log("JSON text length:", jsonText.length);
          console.log(
            "JSON text (first 200 chars):",
            jsonText.substring(0, 200)
          );

          const data = JSON.parse(jsonText);
          console.log("Parsed data:", data);
          console.log("Table rows count:", data.table?.rows?.length || 0);

          if (data.table.rows.length === 0) {
            console.log("❌ No rows found in Payment Tracker");
            return "not_found";
          }

          // Check column E (payment status) - should be true for approved
          const paymentStatus = data.table.rows[0].c[1]?.v;
          console.log("Payment status from column E:", paymentStatus);
          console.log("Payment status type:", typeof paymentStatus);

          const result = paymentStatus === true ? "approved" : "not_approved";
          console.log("Payment Tracker result:", result);
          return result;
        } catch (error) {
          console.error("❌ Error checking payment tracker:", error);
          console.error("Error details:", {
            message: error.message,
            stack: error.stack,
            name: error.name,
          });
          throw error;
        }
      }

      // Check existing entry in Raw Data tab
      async function checkExistingEntry(bookingId) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "0"; // Raw Data tab GID (usually 0 for first sheet)

        console.log("🔍 Checking Raw Data for existing entry...");
        console.log("Booking ID to check:", bookingId);

        try {
          // Try multiple approaches to find the booking ID
          // First, try searching as number
          let query = encodeURIComponent(`SELECT I WHERE I = ${bookingId}`);
          let url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          console.log("Raw Data Query (number):", query);
          console.log("Raw Data URL:", url);

          let response = await fetch(url);
          console.log("Raw Data Response status:", response.status);

          let text = await response.text();
          console.log("Raw Data response text length:", text.length);

          let jsonText = text.substring(47).slice(0, -2);
          let data = JSON.parse(jsonText);
          console.log("Raw Data parsed data:", data);

          // If we get an error, try searching as string
          if (data.status === "error") {
            console.log(
              "❌ Raw Data query error (number search):",
              data.errors
            );
            console.log("🔄 Trying string search...");

            query = encodeURIComponent(`SELECT I WHERE I = '${bookingId}'`);
            url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

            console.log("Raw Data Query (string):", query);
            console.log("Raw Data URL (string):", url);

            response = await fetch(url);
            text = await response.text();
            jsonText = text.substring(47).slice(0, -2);
            data = JSON.parse(jsonText);
            console.log("Raw Data parsed data (string search):", data);
          }

          // If still error, try a broader search
          if (data.status === "error") {
            console.log(
              "❌ Raw Data query error (string search):",
              data.errors
            );
            console.log("🔄 Trying broader search...");

            query = encodeURIComponent(
              `SELECT * WHERE I CONTAINS '${bookingId}'`
            );
            url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

            console.log("Raw Data Query (contains):", query);
            console.log("Raw Data URL (contains):", url);

            response = await fetch(url);
            text = await response.text();
            jsonText = text.substring(47).slice(0, -2);
            data = JSON.parse(jsonText);
            console.log("Raw Data parsed data (contains search):", data);
          }

          // Final check
          if (data.status === "error") {
            console.log("❌ All Raw Data queries failed:", data.errors);
            // If all queries fail, we should be more conservative and assume entry exists
            console.log("⚠️ Assuming entry exists due to query failures");
            return "exists";
          }

          console.log("Raw Data rows count:", data.table?.rows?.length || 0);

          const result = data.table.rows.length > 0 ? "exists" : "not_found";
          console.log("Raw Data check result:", result);
          return result;
        } catch (error) {
          console.error("❌ Error checking existing entry:", error);
          console.error("Error details:", {
            message: error.message,
            stack: error.stack,
            name: error.name,
          });
          // If there's an error, be conservative and assume entry exists
          console.log("⚠️ Error occurred, assuming entry exists for safety");
          return "exists";
        }
      }

      // Fetch Reservations data for the booking ID
      async function fetchReservationsData(bookingId) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "706665562"; // Reservations tab GID

        console.log("🔍 Fetching Reservations data...");
        console.log("Booking ID for reservations:", bookingId);

        try {
          const query = encodeURIComponent(
            `SELECT F, G, H, I, J WHERE I = ${bookingId}`
          );
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          console.log("Reservations Query:", query);
          console.log("Reservations URL:", url);

          const response = await fetch(url);
          console.log("Reservations Response status:", response.status);

          const text = await response.text();
          console.log("Reservations response text length:", text.length);

          const jsonText = text.substring(47).slice(0, -2); // Remove "google.visualization.Query.setResponse(" and ");"
          const data = JSON.parse(jsonText);
          console.log("Reservations parsed data:", data);

          // Check if there's an error in the response
          if (data.status === "error") {
            console.log("❌ Reservations query error:", data.errors);
            // If there's an error, return empty array
            return [];
          }

          console.log(
            "Reservations rows count:",
            data.table?.rows?.length || 0
          );

          const result = data.table.rows || [];
          console.log("Reservations data result:", result);
          return result;
        } catch (error) {
          console.error("❌ Error fetching reservations data:", error);
          console.error("Error details:", {
            message: error.message,
            stack: error.stack,
            name: error.name,
          });
          return [];
        }
      }

      // Show view details button in status modal
      function showViewDetailsButton() {
        const statusViewDetailsBtn = document.getElementById(
          "statusViewDetailsBtn"
        );
        if (statusViewDetailsBtn) {
          statusViewDetailsBtn.classList.remove("hidden");
        }
      }

      // Show reservations popup
      function showReservationsPopup() {
        const popup = document.getElementById("reservationsPopup");
        const tableBody = document.getElementById("reservationsTableBody");

        if (
          !window.currentReservationsData ||
          window.currentReservationsData.length === 0
        ) {
          showStatus("No reservation data found", "error");
          return;
        }

        // Clear existing table content
        tableBody.innerHTML = "";

        // Add data to table
        window.currentReservationsData.forEach((row, index) => {
          const tr = document.createElement("tr");
          tr.className = "border-b border-gray-700";

          // Process each column (F, G, H, I, J)
          const columns = [
            { index: 0, name: "Slot Name" },
            { index: 1, name: "Timestamp" },
            { index: 2, name: "Status" },
            { index: 3, name: "Booked By" },
            { index: 4, name: "Txn ID" },
          ];

          columns.forEach((col) => {
            const td = document.createElement("td");
            td.className = "px-4 py-2 text-sm text-gray-300";

            const cell = row.c[col.index];
            let cellValue = cell?.v || "";

            // Format timestamp if it's the timestamp column (index 1)
            if (col.index === 1 && cellValue) {
              cellValue = formatTimestamp(cellValue);
            }

            td.textContent = cellValue;
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });

        popup.classList.remove("hidden");
      }

      // Format timestamp from Google Sheets format
      function formatTimestamp(timestamp) {
        try {
          // Handle Google Sheets timestamp format: Date(2025,7,2,21,44,50)
          if (typeof timestamp === "string" && timestamp.startsWith("Date(")) {
            // Extract the date parts from Date(2025,7,2,21,44,50)
            const match = timestamp.match(
              /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/
            );
            if (match) {
              const [_, year, month, day, hour, minute, second] = match;
              // Note: Google Sheets months are 0-indexed, so we need to subtract 1
              const date = new Date(
                parseInt(year),
                parseInt(month) - 1,
                parseInt(day),
                parseInt(hour),
                parseInt(minute),
                parseInt(second)
              );
              return date.toLocaleString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true,
              });
            }
          }

          // If it's already a number (timestamp), convert it
          if (typeof timestamp === "number") {
            const date = new Date(timestamp);
            return date.toLocaleString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true,
            });
          }

          // Return as is if no special formatting needed
          return timestamp;
        } catch (error) {
          console.error("Error formatting timestamp:", error);
          return timestamp; // Return original value if formatting fails
        }
      }

      // Close reservations popup
      function closeReservationsPopup() {
        const popup = document.getElementById("reservationsPopup");
        popup.classList.add("hidden");
      }

      // Log entry to Google Form
      async function logEntry(bookingId) {
        const formData = new FormData();
        formData.append("entry.1735629859", bookingId);

        const formUrl =
          "https://docs.google.com/forms/d/e/1FAIpQLSfbGZ2i3oJTEhSm15EJ7IPmIz6G29lzze4P2da-cXLYGn0xLg/formResponse";

        try {
          await fetch(formUrl, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });
          return "success";
        } catch (error) {
          console.error("Error logging entry:", error);
          return "error";
        }
      }

      // Show status modal
      function showStatus(message, type) {
        const statusModal = document.getElementById("statusModal");
        const statusIcon = document.getElementById("statusIcon");
        const statusTitle = document.getElementById("statusTitle");
        const statusMessage = document.getElementById("statusMessage");
        const statusViewDetailsBtn = document.getElementById(
          "statusViewDetailsBtn"
        );

        // Set icon, title, and message based on type
        if (type === "success") {
          statusIcon.innerHTML = "✅";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-green-500/20 border-2 border-green-500/40 success-glow";
          statusTitle.textContent = "Success!";
          statusTitle.className = "text-2xl font-bold text-green-200 mb-2";
        } else if (type === "error") {
          statusIcon.innerHTML = "❌";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-red-500/20 border-2 border-red-500/40 error-glow";
          statusTitle.textContent = "Error";
          statusTitle.className = "text-2xl font-bold text-red-200 mb-2";
        } else {
          statusIcon.innerHTML = "ℹ️";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-blue-500/20 border-2 border-blue-500/40";
          statusTitle.textContent = "Information";
          statusTitle.className = "text-2xl font-bold text-blue-200 mb-2";
        }

        statusMessage.textContent = message;
        statusMessage.className = "text-gray-300 text-base";

        // Hide view details button by default
        statusViewDetailsBtn.classList.add("hidden");

        // Show modal
        statusModal.classList.remove("hidden");
      }

      // Close status modal
      function closeStatusModal() {
        const statusModal = document.getElementById("statusModal");
        statusModal.classList.add("hidden");
      }

      // Handle Enter key
      document.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !isAuthenticated) {
          authenticate();
        }
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
      });

      // Security: Clear session on page unload
      window.addEventListener("beforeunload", function () {
        if (!isAuthenticated) {
          sessionStorage.removeItem("entryAuthenticated");
        }
      });
    </script>
  </body>
</html>
