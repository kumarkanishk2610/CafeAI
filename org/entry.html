<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Management - Cafe Kyaa!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body {
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          #1e293b 50%,
          #334155 100%
        );
        min-height: 100vh;
      }

      .glass-effect {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      .glow-border {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
      }

      .glow-border:focus {
        box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
      }

      .success-glow {
        animation: successPulse 2s ease-in-out;
      }

      @keyframes successPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(34, 197, 94, 0.6);
        }
      }

      .error-glow {
        animation: errorPulse 2s ease-in-out;
      }

      @keyframes errorPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(239, 68, 68, 0.6);
        }
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-up {
        animation: slideUp 0.6s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pulse-glow {
        animation: pulseGlow 2s ease-in-out infinite;
      }

      @keyframes pulseGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        50% {
          box-shadow: 0 0 40px rgba(59, 130, 246, 0.6);
        }
      }

      .scanning-indicator {
        position: relative;
        overflow: hidden;
      }

      .scanning-indicator::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        animation: scanning 2s linear infinite;
      }

      @keyframes scanning {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      #qr-reader {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      #qr-reader__scan_region {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        overflow: hidden;
      }

      #qr-reader__scan_region video {
        border-radius: 12px;
      }

      #qr-reader__dashboard {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        margin-top: 10px;
        padding: 10px;
      }

      #qr-reader__dashboard button {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      #qr-reader__dashboard button:hover {
        transform: scale(1.05);
      }
    </style>
  </head>
  <body class="font-sans">
    <!-- Loading Modal -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen">
        <div class="glass-effect rounded-3xl p-10 text-center max-w-sm mx-4">
          <div class="relative">
            <div
              class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full spinner mx-auto mb-6"
            ></div>
            <div
              class="absolute inset-0 w-16 h-16 border-4 border-transparent border-green-400 rounded-full animate-ping opacity-20"
            ></div>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Processing Entry</h3>
          <p class="text-gray-300 text-base">Verifying booking details...</p>
          <div class="mt-4 flex justify-center space-x-1">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce"></div>
            <div
              class="w-2 h-2 bg-green-500 rounded-full animate-bounce"
              style="animation-delay: 0.1s"
            ></div>
            <div
              class="w-2 h-2 bg-green-500 rounded-full animate-bounce"
              style="animation-delay: 0.2s"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Popup Modal -->
    <div
      id="statusModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="glass-effect rounded-3xl p-8 text-center max-w-md mx-4 slide-up"
        >
          <div class="mb-6">
            <div
              id="statusIcon"
              class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl"
            >
              <!-- Icon will be set dynamically -->
            </div>
            <h3 id="statusTitle" class="text-2xl font-bold text-white mb-2">
              <!-- Title will be set dynamically -->
            </h3>
            <p id="statusMessage" class="text-gray-300 text-base">
              <!-- Message will be set dynamically -->
            </p>

            <!-- Reservation Summary -->
            <div
              id="reservationSummary"
              class="mt-6 p-4 bg-gray-800/50 rounded-lg border border-gray-600 hidden"
            >
              <h4 class="text-lg font-semibold text-white mb-3">
                Reservation Summary
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">Booked By:</span>
                  <span id="summaryBookedBy" class="text-white font-medium"
                    >-</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Slot Name:</span>
                  <span id="summarySlotName" class="text-white font-medium"
                    >-</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Status:</span>
                  <span id="summaryStatus" class="text-white font-medium"
                    >-</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Seats:</span>
                  <span id="summarySeats" class="text-white font-medium"
                    >-</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- View Details Button (hidden by default) -->
          <div id="statusViewDetailsBtn" class="hidden mb-4">
            <button
              onclick="showReservationsPopup()"
              class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg mb-3"
            >
              📋 View Reservation Details
            </button>
            <button
              onclick="continueToSeatBooking()"
              class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              🪑 Continue to Seat Booking
            </button>
          </div>

          <button
            onclick="closeStatusModal()"
            class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Reservations Popup Modal -->
    <div
      id="reservationsPopup"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="glass-effect rounded-2xl p-6 w-full max-w-4xl max-h-[80vh] overflow-hidden"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">Reservation Details</h3>
            <button
              onclick="closeReservationsPopup()"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <div class="overflow-x-auto overflow-y-auto max-h-[60vh]">
            <table class="w-full text-left">
              <thead class="bg-gray-800/50 sticky top-0">
                <tr>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Slot Name
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Timestamp
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Status
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Booked By
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Txn ID
                  </th>
                  <th
                    class="px-4 py-2 text-sm font-semibold text-gray-300 border-b border-gray-600"
                  >
                    Table
                  </th>
                </tr>
              </thead>
              <tbody id="reservationsTableBody">
                <!-- Data will be populated here -->
              </tbody>
            </table>
          </div>

          <div class="mt-4 text-center">
            <button
              onclick="closeReservationsPopup()"
              class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition-all duration-300"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Container -->
    <div class="h-screen flex items-center justify-center p-4">
      <div class="w-full max-w-lg">
        <!-- Header -->
        <div class="text-center mb-8 slide-up">
          <div
            class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full mb-4 shadow-lg"
          >
            <svg
              class="w-10 h-10 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </div>
          <h1
            class="text-4xl font-bold text-white mb-3 bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent"
          >
            Entry Management
          </h1>
          <p class="text-gray-300 text-lg">
            Cafe Kyaa! Entry Verification System
          </p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="glass-effect rounded-2xl p-8 mb-6 slide-up">
          <h2 class="text-2xl font-bold text-white mb-8 text-center">
            🔐 Admin Authentication
          </h2>

          <div class="space-y-6">
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-3"
                >Entry Management Password</label
              >
              <input
                type="password"
                id="passwordInput"
                class="w-full px-4 py-4 bg-gray-800/50 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-green-500 glow-border transition-all duration-300 text-center text-lg"
                placeholder="Enter password to continue"
                onkeypress="handleLoginKeypress(event)"
              />
            </div>

            <button
              onclick="authenticate()"
              class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              <div class="flex items-center justify-center">
                <span id="loginBtnText">🔓 Access Entry System</span>
                <div
                  id="loginSpinner"
                  class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full spinner ml-3"
                ></div>
              </div>
            </button>
          </div>
        </div>

        <!-- Entry Management Form -->
        <div
          id="scannerForm"
          class="glass-effect rounded-2xl p-8 hidden slide-up"
        >
          <!-- Slot Selection - Moved to top for priority -->
          <div class="mb-8">
            <h3 class="text-lg font-semibold text-white mb-4 text-center">
              🕐 Select Current Slot
            </h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-300 mb-2">
                  Which slot are you managing?
                </label>
                <select
                  id="slotSelector"
                  class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-green-500 glow-border transition-all duration-300"
                  onchange="updateSlotSelection()"
                >
                  <option value="">Choose a slot...</option>
                  <option value="Day 1 - 22 Aug - Slot 1">
                    Day 1 - 22 Aug - Slot 1 (10:00 AM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 2">
                    Day 1 - 22 Aug - Slot 2 (11:00 AM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 3">
                    Day 1 - 22 Aug - Slot 3 (12:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 4">
                    Day 1 - 22 Aug - Slot 4 (01:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 5">
                    Day 1 - 22 Aug - Slot 5 (02:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 6">
                    Day 1 - 22 Aug - Slot 6 (03:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 7">
                    Day 1 - 22 Aug - Slot 7 (03:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 8">
                    Day 1 - 22 Aug - Slot 8 (05:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 9">
                    Day 1 - 22 Aug - Slot 9 (06:00 PM)
                  </option>
                  <option value="Day 1 - 22 Aug - Slot 10">
                    Day 1 - 22 Aug - Slot 10 (07:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 1">
                    Day 2 - 23 Aug - Slot 1 (10:00 AM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 2">
                    Day 2 - 23 Aug - Slot 2 (11:00 AM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 3">
                    Day 2 - 23 Aug - Slot 3 (12:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 4">
                    Day 2 - 23 Aug - Slot 4 (01:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 5">
                    Day 2 - 23 Aug - Slot 5 (02:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 6">
                    Day 2 - 23 Aug - Slot 6 (03:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 7">
                    Day 2 - 23 Aug - Slot 7 (03:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 8">
                    Day 2 - 23 Aug - Slot 8 (05:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 9">
                    Day 2 - 23 Aug - Slot 9 (06:00 PM)
                  </option>
                  <option value="Day 2 - 23 Aug - Slot 10">
                    Day 2 - 23 Aug - Slot 10 (07:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 1">
                    Day 3 - 24 Aug - Slot 1 (10:00 AM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 2">
                    Day 3 - 24 Aug - Slot 2 (11:00 AM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 3">
                    Day 3 - 24 Aug - Slot 3 (12:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 4">
                    Day 3 - 24 Aug - Slot 4 (01:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 5">
                    Day 3 - 24 Aug - Slot 5 (02:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 6">
                    Day 3 - 24 Aug - Slot 6 (03:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 7">
                    Day 3 - 24 Aug - Slot 7 (03:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 8">
                    Day 3 - 24 Aug - Slot 8 (05:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 9">
                    Day 3 - 24 Aug - Slot 9 (06:00 PM)
                  </option>
                  <option value="Day 3 - 24 Aug - Slot 10">
                    Day 3 - 24 Aug - Slot 10 (07:00 PM)
                  </option>
                </select>
              </div>
              <div id="selectedSlotInfo" class="hidden">
                <div
                  class="bg-green-500/20 border border-green-500/40 rounded-lg p-3"
                >
                  <p class="text-green-200 text-sm font-medium">
                    ✅ Currently managing: <span id="selectedSlotText"></span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- QR Scanner - Primary Feature -->
          <div class="space-y-6">
            <h3 class="text-xl font-semibold text-white text-center">
              📱 QR Code Scanner
            </h3>
            <div class="scanning-indicator">
              <div
                id="qr-reader"
                class="rounded-xl overflow-hidden shadow-lg"
              ></div>
            </div>
            <div class="text-center">
              <p class="text-gray-300 text-sm mb-2">
                Point camera at the QR code to scan entry
              </p>
              <div class="flex items-center justify-center space-x-2">
                <div
                  class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
                ></div>
                <span class="text-green-400 text-xs font-medium"
                  >Ready to scan</span
                >
              </div>
            </div>
          </div>

          <!-- Manual Entry Button -->
          <div class="mt-6 pt-6 border-t border-gray-600">
            <button
              onclick="showManualEntryModal()"
              class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              📝 Manual Entry
            </button>
          </div>

          <!-- Logout Button -->
          <div class="mt-8 pt-6 border-t border-gray-600">
            <button
              onclick="logout()"
              class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
            >
              🚪 Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Entry Modal -->
    <div
      id="manualEntryModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md mx-4 slide-up">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">📝 Manual Entry</h3>
            <button
              onclick="closeManualEntryModal()"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <div class="space-y-6">
            <div>
              <label class="block text-sm font-semibold text-gray-300 mb-3">
                Booking ID
              </label>
              <input
                type="text"
                id="manualBookingId"
                class="w-full px-4 py-4 bg-gray-800/50 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-green-500 glow-border transition-all duration-300 text-center text-lg"
                placeholder="Enter booking ID"
                onkeypress="handleManualEntryKeypress(event)"
              />
            </div>

            <div class="flex space-x-3">
              <button
                onclick="processManualEntry()"
                class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
              >
                🔍 Check Booking
              </button>
              <button
                onclick="closeManualEntryModal()"
                class="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-900 shadow-lg"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // MD5 hash of password (same as admin for now, you can change this)
      const ENTRY_PASSWORD_HASH = "0a7fe17e846e0e035cac91fff6ad7cef";

      let isAuthenticated = false;
      let html5QrcodeScanner = null;

      // Check if already authenticated
      function checkAuth() {
        const authStatus = sessionStorage.getItem("entryAuthenticated");
        if (authStatus === "true") {
          isAuthenticated = true;
          showScannerForm();
        }
      }

      // Authenticate user
      function authenticate() {
        const password = document.getElementById("passwordInput").value;
        const loginBtn = document.getElementById("loginBtnText");
        const loginSpinner = document.getElementById("loginSpinner");

        if (!password) {
          showStatus("Please enter a password", "error");
          return;
        }

        // Show loading state
        loginBtn.textContent = "Authenticating...";
        loginSpinner.classList.remove("hidden");

        // Simulate processing delay
        setTimeout(() => {
          const passwordHash = CryptoJS.MD5(password).toString();

          if (passwordHash === ENTRY_PASSWORD_HASH) {
            isAuthenticated = true;
            sessionStorage.setItem("entryAuthenticated", "true");
            showStatus("Authentication successful!", "success");
            showScannerForm();
          } else {
            showStatus("Invalid password. Access denied.", "error");
            document.getElementById("passwordInput").value = "";
          }

          // Reset button state
          loginBtn.textContent = "Authenticate";
          loginSpinner.classList.add("hidden");
        }, 1000);
      }

      // Show scanner form
      function showScannerForm() {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("scannerForm").classList.remove("hidden");
        initializeQRScanner();
      }

      // Show login form
      function showLoginForm() {
        document.getElementById("scannerForm").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("passwordInput").value = "";
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear();
        }
      }

      // Logout
      function logout() {
        isAuthenticated = false;
        sessionStorage.removeItem("entryAuthenticated");
        showLoginForm();
        showStatus("Logged out successfully", "success");

        // Hide view details button in status modal
        const statusViewDetailsBtn = document.getElementById(
          "statusViewDetailsBtn"
        );
        if (statusViewDetailsBtn) {
          statusViewDetailsBtn.classList.add("hidden");
        }

        // Clear reservations data
        window.currentReservationsData = null;
        window.location.href = "/org/index.html";
      }

      // Initialize QR Scanner
      function initializeQRScanner() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear();
        }

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0,
        };

        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config, false);

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      }

      // Handle successful QR scan
      function onScanSuccess(decodedText, decodedResult) {
        // Don't stop scanner - keep camera running
        // Just process the scanned booking ID

        // Get selected slot
        const selectedSlot = document.getElementById("slotSelector").value;
        if (!selectedSlot) {
          showStatus("Please select a slot first", "error");
          return;
        }

        processEntry(decodedText, selectedSlot);
      }

      // Handle QR scan failure
      function onScanFailure(error) {
        // Handle scan failure, usually ignore
        // Disabled console logging to prevent spam
        // 
      }

      // Process entry verification
      async function processEntry(bookingId, selectedSlot = null) {
        
        
        
        
        

        // Store booking ID and slot for seat booking redirect
        window.currentBookingId = bookingId;
        window.currentSelectedSlot = selectedSlot;

        document.getElementById("loadingModal").classList.remove("hidden");

        try {
          // Step 1: Validate slot selection
          if (!selectedSlot) {
            showStatus("Please select a slot first", "error");
            return;
          }

          // Step 2: Fetch user data for given booking ID
          
          const allReservationsData = await fetchReservationsData(bookingId);
          
          

          if (!allReservationsData || allReservationsData.length === 0) {
            showStatus("No reservations found for this booking ID", "error");
            return;
          }

          // Step 3: Check if any slots in userdata match admin selected slot
          
          const hasMatchingSlot = allReservationsData.some((row) => {
            const slotName = row.c[0]?.v || row.c[1]?.v || "";
            return (
              String(slotName).toLowerCase() ===
              String(selectedSlot).toLowerCase()
            );
          });

          if (!hasMatchingSlot) {
            
            showStatus(
              `No bookings found for ${selectedSlot}. Please check slot selection.`,
              "error"
            );
            return;
          }

          // Step 4: Filter reservations by admin selected slot
          const filteredReservationsData = filterReservationsBySlot(
            allReservationsData,
            selectedSlot
          );
          
          
          window.currentReservationsData = filteredReservationsData;

          // Step 5: Cross checks (admin confirmation, entry status, etc.)
          

          // 5.1: Check payment status
          
          const paymentTrackerStatus = await checkPaymentTracker(bookingId);
          

          if (paymentTrackerStatus === "not_found") {
            
            showStatus("ID Not Found", "error");
            return;
          } else if (paymentTrackerStatus === "not_approved") {
            
            showStatus("Admin Confirmation Pending", "warning");
            showViewDetailsButton(); // Show View Details button
            return;
          }

          

          // 5.2: Check existing entry
          
          const entryStatus = await checkExistingEntry(bookingId, selectedSlot);
          

          // Step 6: Handle entry logging based on entry status
          
          if (entryStatus === "new") {
            

            // Log entry immediately for new users
            
            const logResult = await logEntry(bookingId, selectedSlot);
            

            if (logResult === "success") {
              

              
              showStatus(
                "Entry successful! Click 'View Details' to see reservation info.",
                "success"
              );
              
              showViewDetailsButton(); // Show View Details button
              
            } else {
              
              showStatus("Error logging entry", "error");
            }
          } else if (entryStatus === "exists") {
            

            showStatus(
              "Entry already done. You can still view reservation details.",
              "warning"
            );
            showViewDetailsButton(); // Show View Details button
            populateReservationSummary(); // Populate the summary
          }

          
        } catch (error) {
          
          
          showStatus("Error processing entry", "error");
        } finally {
          document.getElementById("loadingModal").classList.add("hidden");
        }
      }

      // Check Payment Tracker tab - column A for booking ID and column E for approval status
      async function checkPaymentTracker(bookingId) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "364335196"; // Payment Tracker tab GID (corrected)

        
        
        
        

        try {
          const query = encodeURIComponent(
            `SELECT A, E WHERE A = ${bookingId}`
          );
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          
          

          const response = await fetch(url);
          
          

          const text = await response.text();
          
          :",
            text.substring(0, 200)
          );

          const jsonText = text.substring(47).slice(0, -2); // Remove "google.visualization.Query.setResponse(" and ");"
          
          :",
            jsonText.substring(0, 200)
          );

          const data = JSON.parse(jsonText);
          
          

          if (data.table.rows.length === 0) {
            
            return "not_found";
          }

          // Check column E (payment status) - should be true for approved
          const paymentStatus = data.table.rows[0].c[1]?.v;
          
          

          const result = paymentStatus === true ? "approved" : "not_approved";
          
          return result;
        } catch (error) {
          
          
          throw error;
        }
      }

      // Check existing entry in Raw Data tab
      async function checkExistingEntry(bookingId, selectedSlot) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "2113355260"; // Raw Data tab GID (usually 0 for first sheet)

        
        

        try {
          // Fetch all data from Raw Data sheet to search locally
          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          :", query);
          

          const response = await fetch(url);
          

          const text = await response.text();
          

          const jsonText = text.substring(47).slice(0, -2);
          const data = JSON.parse(jsonText);
          

          // Check if there's an error in the response
          if (data.status === "error") {
            
            
            return "exists";
          }

          

          // Search through all rows for the booking ID in column I (index 8) AND slot in column J (index 9)
          let found = false;
          if (data.table && data.table.rows) {
            data.table.rows.forEach((row, index) => {
              // Check column I (index 8) for the booking ID
              const columnI = row.c[8]?.v;
              // Check column J (index 9) for the slot name
              const columnJ = row.c[9]?.v;

              `
              );

              // Convert both to strings for consistent comparison
              const columnIString = String(columnI || "");
              const columnJString = String(columnJ || "");
              const bookingIdString = String(bookingId || "");
              const selectedSlotString = String(selectedSlot || "");

              // Compare both booking ID AND slot
              if (
                columnIString === bookingIdString &&
                columnJString === selectedSlotString
              ) {
                
                found = true;
              }
            });
          }

          const result = found ? "exists" : "new";
          
          return result;
        } catch (error) {
          
          
          // If there's an error, be conservative and assume entry exists
          
          return "exists";
        }
      }

      // Fetch Reservations data for the booking ID
      async function fetchReservationsData(bookingId) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "706665562"; // Reservations tab GID

        
        

        try {
          // First, try to get all data and filter locally
          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          :", query);
          

          const response = await fetch(url);
          

          const text = await response.text();
          

          const jsonText = text.substring(47).slice(0, -2); // Remove "google.visualization.Query.setResponse(" and ");"
          const data = JSON.parse(jsonText);
          

          // Check if there's an error in the response
          if (data.status === "error") {
            
            // If there's an error, return empty array
            return [];
          }

          

          // Filter rows locally where column I (index 8) matches the booking ID
          const filteredRows = [];
          if (data.table && data.table.rows) {
            data.table.rows.forEach((row, index) => {
              // Check column I (index 8) for the booking ID
              const columnI = row.c[8]?.v; // Column I (index 8)
              `
              );

              // Convert both to strings for consistent comparison
              const columnIString = String(columnI || "");
              const bookingIdString = String(bookingId || "");

              // Compare as strings
              if (columnIString === bookingIdString) {
                
                // Extract only columns F, G, H, I, J, K (indices 5, 6, 7, 8, 9, 10)
                const filteredRow = {
                  c: [
                    row.c[5], // F
                    row.c[6], // G
                    row.c[7], // H
                    row.c[8], // I
                    row.c[9], // J
                    row.c[10], // K
                  ],
                };
                filteredRows.push(filteredRow);
              }
            });
          }

          
          
          return filteredRows;
        } catch (error) {
          
          
          return [];
        }
      }

      // Show view details button in status modal
      function showViewDetailsButton() {
        const statusViewDetailsBtn = document.getElementById(
          "statusViewDetailsBtn"
        );
        if (statusViewDetailsBtn) {
          statusViewDetailsBtn.classList.remove("hidden");
        }
      }

      // Populate reservation summary in status modal
      async function populateReservationSummary() {
        const bookingId = window.currentBookingId;
        const selectedSlot = window.currentSelectedSlot;
        if (!bookingId) return;

        try {
          // Fetch reservation data
          const reservationsData = await fetchReservationsData(bookingId);

          if (reservationsData && reservationsData.length > 0) {
            const firstReservation = reservationsData[0];

            // Extract data from the reservation (mapped indices: 0=F, 1=G, 2=H, 3=I, 4=J, 5=K)
            const slotName = selectedSlot || "-";
            const timestamp = firstReservation.c[1]?.v || "-";
            const status = firstReservation.c[2]?.v || "-";
            const bookedBy = firstReservation.c[3]?.v || "-";

            // Collect seats only for the currently selected slot
            const currentSlotSeats = reservationsData
              .filter((reservation) => reservation.c[0]?.v === selectedSlot)
              .map((reservation) => reservation.c[5]?.v)
              .filter((seat) => seat && seat !== "")
              .join(", ");

            // Update summary elements
            document.getElementById("summaryBookedBy").textContent = bookedBy;
            document.getElementById("summarySlotName").textContent = slotName;
            document.getElementById("summaryStatus").textContent = status;
            document.getElementById("summarySeats").textContent =
              currentSlotSeats || "-";

            // Show the summary section
            const summarySection =
              document.getElementById("reservationSummary");
            if (summarySection) {
              summarySection.classList.remove("hidden");
            }
          }
        } catch (error) {
          
        }
      }

      // Continue to seat booking with URL parameters
      function continueToSeatBooking() {
        // Get booking ID and slot from current context
        const bookingId = window.currentBookingId || "";
        const selectedSlot = window.currentSelectedSlot || "";

        
        
        

        // Build URL with parameters
        const url = new URL("org/seat.html", window.location.origin);
        if (bookingId) {
          url.searchParams.set("bookingId", bookingId);
        }
        if (selectedSlot) {
          url.searchParams.set("slot", selectedSlot);
        }

        );
        window.location.href = url.toString();
      }

      // Show reservations popup
      function showReservationsPopup() {
        const popup = document.getElementById("reservationsPopup");
        const tableBody = document.getElementById("reservationsTableBody");

        if (
          !window.currentReservationsData ||
          window.currentReservationsData.length === 0
        ) {
          showStatus("No reservation data found", "error");
          return;
        }

        // Clear existing table content
        tableBody.innerHTML = "";

        // Add data to table
        window.currentReservationsData.forEach((row, index) => {
          const tr = document.createElement("tr");
          tr.className = "border-b border-gray-700";

          // Process each column (F, G, H, I, J, K mapped to 0, 1, 2, 3, 4, 5)
          const columns = [
            { index: 0, name: "Slot Name" },
            { index: 1, name: "Timestamp" },
            { index: 2, name: "Status" },
            { index: 3, name: "Booked By" },
            { index: 4, name: "Txn ID" },
            { index: 5, name: "Table" },
          ];

          columns.forEach((col) => {
            const td = document.createElement("td");
            td.className = "px-4 py-2 text-sm text-gray-300";

            const cell = row.c[col.index];
            let cellValue = cell?.v || "";

            // Format timestamp if it's the timestamp column (index 1)
            if (col.index === 1 && cellValue) {
              cellValue = formatTimestamp(cellValue);
            }

            td.textContent = cellValue;
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });

        // Add table assignments section if available
        
        if (
          window.currentTableAssignments &&
          window.currentTableAssignments.length > 0
        ) {
          
          const tableAssignmentsSection = document.createElement("div");
          tableAssignmentsSection.className =
            "mt-6 pt-6 border-t border-gray-700";
          tableAssignmentsSection.innerHTML = `
              <h3 class="text-lg font-semibold text-white mb-4">Table Assignments</h3>
              <div class="bg-gray-800 rounded-lg p-4">
                ${window.currentTableAssignments
                  .map(
                    (assignment) => `
                  <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0">
                    <span class="text-gray-300">${assignment.slot}</span>
                    <span class="text-green-400 font-semibold">${assignment.table}</span>
                  </div>
                `
                  )
                  .join("")}
              </div>
            `;

          // Insert after the table but before the close button
          const closeButtonContainer = popup.querySelector(".mt-4.text-center");
          
          if (closeButtonContainer) {
            closeButtonContainer.parentNode.insertBefore(
              tableAssignmentsSection,
              closeButtonContainer
            );
            
          } else {
            
            // Try inserting after the table container
            const tableContainer = popup.querySelector(".overflow-x-auto");
            if (tableContainer) {
              tableContainer.parentNode.insertBefore(
                tableAssignmentsSection,
                tableContainer.nextSibling
              );
              
            }
          }
        } else {
          
        }

        popup.classList.remove("hidden");
      }

      // Format timestamp from Google Sheets format
      function formatTimestamp(timestamp) {
        try {
          // Handle Google Sheets timestamp format: Date(2025,7,2,21,44,50)
          if (typeof timestamp === "string" && timestamp.startsWith("Date(")) {
            // Extract the date parts from Date(2025,7,2,21,44,50)
            const match = timestamp.match(
              /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/
            );
            if (match) {
              const [_, year, month, day, hour, minute, second] = match;
              // Note: Google Sheets months are 0-indexed, so we need to subtract 1
              const date = new Date(
                parseInt(year),
                parseInt(month) - 1,
                parseInt(day),
                parseInt(hour),
                parseInt(minute),
                parseInt(second)
              );
              return date.toLocaleString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true,
              });
            }
          }

          // If it's already a number (timestamp), convert it
          if (typeof timestamp === "number") {
            const date = new Date(timestamp);
            return date.toLocaleString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: true,
            });
          }

          // Return as is if no special formatting needed
          return timestamp;
        } catch (error) {
          
          return timestamp; // Return original value if formatting fails
        }
      }

      // Close reservations popup
      function closeReservationsPopup() {
        const popup = document.getElementById("reservationsPopup");
        popup.classList.add("hidden");
      }

      // Log entry to Google Form
      async function logEntry(bookingId, slotName) {
        
        

        const formData = new FormData();
        formData.append("entry.1735629859", bookingId); // Booking ID
        formData.append("entry.1592144907", slotName); // Slot name

        const formUrl =
          "https://docs.google.com/forms/d/e/1FAIpQLSfbGZ2i3oJTEhSm15EJ7IPmIz6G29lzze4P2da-cXLYGn0xLg/formResponse";

        
        

        try {
          
          const response = await fetch(formUrl, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });
          
          
          

          // Since no-cors mode doesn't give us response details, we assume success
          // but we can add a small delay to simulate the request
          await new Promise((resolve) => setTimeout(resolve, 1000));

          
          return "success";
        } catch (error) {
          
          return "error";
        }
      }

      // Handle table assignment
      async function handleTableAssignment(bookingId, reservationsData) {
        try {
          // Extract unique slots from reservations data
          const slots = extractUniqueSlots(reservationsData);

          if (slots.length === 0) {
            
            return;
          }

          // If multiple slots, show slot selection modal
          if (slots.length > 1) {
            showSlotSelectionModal(slots, bookingId);
          } else {
            // Single slot, proceed directly
            await processTableAssignment(bookingId, slots[0]);
          }
        } catch (error) {
          
        }
      }

      // Extract unique slots from reservations data
      function extractUniqueSlots(reservationsData) {
        const slots = new Set();
        reservationsData.forEach((row) => {
          // Extract slot information from the data
          // This depends on how slot info is stored in reservations
          const slotInfo = row.c[0]?.v || row.c[1]?.v || ""; // Adjust based on actual data structure
          if (slotInfo) {
            slots.add(slotInfo);
          }
        });
        return Array.from(slots);
      }

      // Show slot selection modal
      function showSlotSelectionModal(slots, bookingId) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Select Slot for Table Assignment</h3>
            <p class="text-gray-600 mb-4">This booking has multiple slots. Please select which slot to assign a table for:</p>
            <div class="space-y-2 mb-4">
              ${slots
                .map(
                  (slot) => `
                <button 
                  class="w-full text-left p-3 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onclick="selectSlotForTableAssignment('${slot}', '${bookingId}')"
                >
                  ${slot}
                </button>
              `
                )
                .join("")}
            </div>
            <button 
              class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600"
              onclick="closeSlotSelectionModal()"
            >
              Cancel
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        window.currentSlotModal = modal;
      }

      // Close slot selection modal
      function closeSlotSelectionModal() {
        if (window.currentSlotModal) {
          document.body.removeChild(window.currentSlotModal);
          window.currentSlotModal = null;
        }
      }

      // Select slot for table assignment
      async function selectSlotForTableAssignment(slotName, bookingId) {
        closeSlotSelectionModal();
        await processTableAssignment(bookingId, slotName);
      }

      // Process table assignment
      async function processTableAssignment(bookingId, slotName) {
        try {
          

          // Check existing table assignment
          const existingAssignment = await checkExistingTableAssignment(
            bookingId,
            slotName
          );

          if (existingAssignment) {
            
            showTableAssignmentStatus(
              `Already assigned to ${existingAssignment}`,
              "info"
            );
          } else {
            
            // Assign new table
            const newTableAssignment = await assignNewTable(
              bookingId,
              slotName
            );
            if (newTableAssignment) {
              
              showTableAssignmentStatus(
                `Assigned to ${newTableAssignment}`,
                "success"
              );
            } else {
              
              showTableAssignmentStatus(
                "Failed to assign table - all tables may be occupied",
                "error"
              );
            }
          }
        } catch (error) {
          
          showTableAssignmentStatus(
            "Error processing table assignment",
            "error"
          );
        }
      }

      // Check existing table assignment
      async function checkExistingTableAssignment(bookingId, slotName) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "365103881"; // VenueTableReservation tab GID

        try {
          const query = encodeURIComponent(
            `SELECT * WHERE B = '${bookingId}' AND C = '${slotName}'`
          );
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          const response = await fetch(url);
          const text = await response.text();
          const jsonText = text.substring(47).slice(0, -2);
          const data = JSON.parse(jsonText);

          if (data.status === "error") {
            
            return null;
          }

          if (data.table && data.table.rows && data.table.rows.length > 0) {
            // Found existing assignment
            const row = data.table.rows[0];
            const tableSeat = row.c[3]?.v || ""; // Column D: Table/Seat
            return tableSeat;
          }

          return null; // No existing assignment
        } catch (error) {
          
          return null;
        }
      }

      // Assign new table
      async function assignNewTable(bookingId, slotName) {
        try {
          // Get available tables for the slot
          const availableTables = await getAvailableTables(slotName);

          if (availableTables.length === 0) {
            
            return null;
          }

          // Assign the first available table
          const assignedTable = availableTables[0];

          // Submit to table assignment form
          const formUrl =
            "https://docs.google.com/forms/d/e/1FAIpQLScr_5q__XyAbcK3wfBdKCEFwN-iDD6M21jU3U9Ss0u2FQRH0g/formResponse";

          const formData = new FormData();
          formData.append("entry.863334335", bookingId); // Booking ID
          formData.append("entry.1779047001", slotName); // Slot Name
          formData.append("entry.1374097765", assignedTable); // Table/Seat

          const response = await fetch(formUrl, {
            method: "POST",
            body: formData,
            mode: "no-cors",
          });

          
          return assignedTable;
        } catch (error) {
          
          return null;
        }
      }

      // Get available tables for a slot
      async function getAvailableTables(slotName) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "365103881"; // VenueTableReservation tab GID

        try {
          // Get all table assignments for this slot
          const query = encodeURIComponent(`SELECT D WHERE C = '${slotName}'`);
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          const response = await fetch(url);
          const text = await response.text();
          const jsonText = text.substring(47).slice(0, -2);
          const data = JSON.parse(jsonText);

          if (data.status === "error") {
            
            return [];
          }

          // Get all occupied tables for this slot
          const occupiedTables = new Set();
          if (data.table && data.table.rows) {
            data.table.rows.forEach((row) => {
              const tableSeat = row.c[0]?.v || ""; // Column D: Table/Seat
              if (tableSeat) {
                occupiedTables.add(tableSeat);
              }
            });
          }

          // All possible tables: A1, A2, B1, B2, C1, C2, D1, D2, E1, E2, F1, F2
          const allTables = [
            "A1",
            "A2",
            "B1",
            "B2",
            "C1",
            "C2",
            "D1",
            "D2",
            "E1",
            "E2",
            "F1",
            "F2",
          ];

          // Return available tables
          const availableTables = allTables.filter(
            (table) => !occupiedTables.has(table)
          );
          

          return availableTables;
        } catch (error) {
          
          return [];
        }
      }

      // Show table assignment status
      function showTableAssignmentStatus(message, type) {
        const statusModal = document.createElement("div");
        statusModal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";

        const bgColor =
          type === "success"
            ? "bg-green-500"
            : type === "error"
            ? "bg-red-500"
            : "bg-blue-500";

        statusModal.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
              <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColor} mb-4">
                <span class="text-white text-xl">${
                  type === "success" ? "✅" : type === "error" ? "❌" : "ℹ️"
                }</span>
              </div>
              <h3 class="text-lg font-semibold mb-2">Table Assignment</h3>
              <p class="text-gray-600 mb-4">${message}</p>
              <button 
                class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600"
                onclick="closeTableAssignmentStatus()"
              >
                OK
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(statusModal);
        window.currentTableStatusModal = statusModal;
      }

      // Close table assignment status modal
      function closeTableAssignmentStatus() {
        if (window.currentTableStatusModal) {
          document.body.removeChild(window.currentTableStatusModal);
          window.currentTableStatusModal = null;
        }
      }

      // Filter reservations by selected slot
      function filterReservationsBySlot(reservationsData, selectedSlot) {
        if (!selectedSlot) {
          return reservationsData; // Return all if no slot selected
        }

        return reservationsData.filter((row) => {
          // Extract slot information from the data
          // This depends on how slot info is stored in reservations
          const slotInfo = row.c[0]?.v || row.c[1]?.v || ""; // Adjust based on actual data structure
          return slotInfo === selectedSlot;
        });
      }

      // Table selection modal and all related functions removed - no longer needed

      // Get table assignments for a specific booking
      async function getTableAssignmentsForBooking(
        bookingId,
        selectedSlot = null
      ) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "365103881"; // VenueTableReservation tab GID

        try {
          // Convert bookingId to string to handle number vs string comparison
          const bookingIdStr = String(bookingId);

          // Fetch entire sheet and filter locally
          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          
          
          
          

          const response = await fetch(url);
          const text = await response.text();
          const jsonText = text.substring(47).slice(0, -2);
          const data = JSON.parse(jsonText);

          if (data.status === "error") {
            
            return [];
          }

          // Extract table assignments with local filtering
          const tableAssignments = [];
          if (data.table && data.table.rows) {
            

            data.table.rows.forEach((row, index) => {
              // Skip header row (index 0)
              if (index === 0) return;

              // Columns: A (Timestamp), B (Booking ID), C (Slot Name), D (Table/Seat)
              const timestamp = row.c[0]?.v || "";
              const bookingIdInSheet = String(row.c[1]?.v || ""); // Column B
              const slotName = row.c[2]?.v || ""; // Column C
              const tableSeat = row.c[3]?.v || ""; // Column D

              

              // Check if this row matches our booking ID
              if (bookingIdInSheet === bookingIdStr) {
                

                if (selectedSlot) {
                  // Filter by selected slot
                  if (
                    String(slotName).toLowerCase() ===
                    String(selectedSlot).toLowerCase()
                  ) {
                    tableAssignments.push({
                      slot: slotName,
                      table: tableSeat,
                    });
                    
                  } else {
                    
                  }
                } else {
                  // Include all assignments for this booking
                  tableAssignments.push({
                    slot: slotName,
                    table: tableSeat,
                  });
                  
                }
              }
            });
          }

          
          return tableAssignments;
        } catch (error) {
          
          return [];
        }
      }

      // Get occupied tables for a specific slot
      async function getOccupiedTablesForSlot(slotName) {
        const spreadsheetId = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const gid = "365103881"; // VenueTableReservation tab GID

        try {
          // Query: Get all table assignments for this specific slot
          const query = encodeURIComponent(`SELECT D WHERE C = '${slotName}'`);
          const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=${query}&gid=${gid}`;

          
          
          

          const response = await fetch(url);
          const text = await response.text();
          const jsonText = text.substring(47).slice(0, -2);
          const data = JSON.parse(jsonText);

          if (data.status === "error") {
            
            return [];
          }

          // Extract occupied table codes from Column D
          const occupiedTables = [];
          if (data.table && data.table.rows) {
            data.table.rows.forEach((row, index) => {
              const tableSeat = row.c[0]?.v || ""; // Column D: Table/Seat
              if (tableSeat) {
                occupiedTables.push(tableSeat);
                
              }
            });
          }

          
          return occupiedTables;
        } catch (error) {
          
          return [];
        }
      }

      // Close manual table selection modal
      function closeManualTableSelectionModal() {
        
        if (window.currentTableSelectionModal) {
          
          document.body.removeChild(window.currentTableSelectionModal);
          window.currentTableSelectionModal = null;
          window.selectedTables = []; // Clear selected tables
        } else {
          
          // Fallback: try to find modal by class
          const modal = document.querySelector(
            ".fixed.inset-0.bg-black.bg-opacity-50"
          );
          if (modal) {
            
            document.body.removeChild(modal);
            window.selectedTables = [];
          }
        }
      }

      // Toggle table selection (for multiple selection)
      async function toggleTableSelection(tableSeat, bookingId, slotName) {
        if (!window.selectedTables) {
          window.selectedTables = [];
        }

        // Get the remaining seats count from the modal
        const selectedCountElement =
          window.currentTableSelectionModal?.querySelector("#selectedCount");
        const maxSelections = window.currentReservationsData?.length || 0;

        // Calculate remaining seats to select (accounting for already assigned seats)
        const existingUserAssignments = await getTableAssignmentsForBooking(
          bookingId,
          slotName
        );
        const existingSeatsCount = existingUserAssignments?.length || 0;
        const remainingSeatsToSelect = maxSelections - existingSeatsCount;

        // Find the button within the current modal only
        const button = window.currentTableSelectionModal?.querySelector(
          `[data-table="${tableSeat}"]`
        );

        if (!button) {
          
          return;
        }

        if (window.selectedTables.includes(tableSeat)) {
          // Deselect table
          window.selectedTables = window.selectedTables.filter(
            (table) => table !== tableSeat
          );
          // Reset to unselected state - keep all base classes
          button.className =
            "p-3 border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-medium text-gray-700 table-selection-btn";
          
          
        } else {
          // Check if we can select more tables
          if (window.selectedTables.length >= maxSelections) {
            
            showTableAssignmentStatus(
              `You can only select up to ${maxSelections} table(s)`,
              "error"
            );
            return;
          }

          // Select table
          window.selectedTables.push(tableSeat);
          // Set to selected state - blue background and white text
          button.className =
            "p-3 border border-blue-500 rounded-lg bg-blue-500 text-white text-sm font-medium table-selection-btn";
          
          
        }

        // Update the selection counter
        if (selectedCountElement) {
          selectedCountElement.textContent = window.selectedTables.length;
          
        } else {
          
        }

        // Update submit button state
        const submitBtn = window.currentTableSelectionModal?.querySelector(
          "#submitTableSelectionBtn"
        );
        if (submitBtn) {
          
          

          if (window.selectedTables.length === maxSelections) {
            submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            submitBtn.classList.add("bg-blue-500", "hover:bg-blue-600");
            submitBtn.disabled = false;
            
          } else {
            submitBtn.classList.remove("bg-blue-500", "hover:bg-blue-600");
            submitBtn.classList.add("bg-gray-400", "cursor-not-allowed");
            submitBtn.disabled = true;
            
          }

          
        } else {
          
        }

        

        // Debug: Check all buttons in the modal
        const allButtons = window.currentTableSelectionModal?.querySelectorAll(
          ".table-selection-btn"
        );
        if (allButtons) {
          
          allButtons.forEach((btn) => {
            const tableName = btn.getAttribute("data-table");
            const isSelected = window.selectedTables.includes(tableName);
            
          });
        }
      }

      // Submit multiple table selections
      async function submitTableSelection(bookingId, slotName) {
        
        
        
        
        

        if (!window.selectedTables || window.selectedTables.length === 0) {
          
          showTableAssignmentStatus(
            "Please select at least one table",
            "error"
          );
          return;
        }

        // Validate that selected tables match the remaining seats needed
        const maxSelections = window.currentReservationsData?.length || 0;
        const existingUserAssignments = await getTableAssignmentsForBooking(
          bookingId,
          slotName
        );
        const existingSeatsCount = existingUserAssignments?.length || 0;
        const remainingSeatsToSelect = maxSelections - existingSeatsCount;

        
        
        
        

        if (window.selectedTables.length !== remainingSeatsToSelect) {
          
          showTableAssignmentStatus(
            `Please select exactly ${remainingSeatsToSelect} table(s) to complete your booking`,
            "error"
          );
          return;
        }

        // Store selected tables before closing modal (to prevent clearing)
        const tablesToSubmit = [...window.selectedTables];
        

        closeManualTableSelectionModal();

        try {
          

          // Submit each table assignment
          for (const tableSeat of tablesToSubmit) {
            const formUrl =
              "https://docs.google.com/forms/d/e/1FAIpQLScr_5q__XyAbcK3wfBdKCEFwN-iDD6M21jU3U9Ss0u2FQRH0g/formResponse";

            const formData = new FormData();
            formData.append("entry.863334335", bookingId); // Booking ID
            formData.append("entry.1779047001", slotName); // Slot Name
            formData.append("entry.1374097765", tableSeat); // Table/Seat

            
            
            
            
            

            

            try {
              // Method 1: Try fetch with no-cors
              const response = await fetch(formUrl, {
                method: "POST",
                body: formData,
                mode: "no-cors",
              });

              
              
              

              // Since no-cors mode doesn't give us response details, we'll assume success
              // but add a small delay to ensure the form submission completes
              await new Promise((resolve) => setTimeout(resolve, 500));
            } catch (error) {
              

              // Method 2: Try alternative submission method
              
              try {
                // Create a hidden iframe to submit the form
                const iframe = document.createElement("iframe");
                iframe.style.display = "none";
                document.body.appendChild(iframe);

                // Create form element
                const form = document.createElement("form");
                form.method = "POST";
                form.action = formUrl;
                form.target = iframe.name;

                // Add form fields
                const fields = [
                  { name: "entry.863334335", value: bookingId },
                  { name: "entry.1779047001", value: slotName },
                  { name: "entry.1374097765", value: tableSeat },
                ];

                fields.forEach((field) => {
                  const input = document.createElement("input");
                  input.type = "hidden";
                  input.name = field.name;
                  input.value = field.value;
                  form.appendChild(input);
                });

                // Submit form
                document.body.appendChild(form);
                form.submit();

                // Clean up
                setTimeout(() => {
                  document.body.removeChild(form);
                  document.body.removeChild(iframe);
                }, 1000);

                
              } catch (altError) {
                
                throw error; // Throw original error
              }
            }
          }

          const tableList = tablesToSubmit.join(", ");
          const successMessage =
            existingSeatsCount > 0
              ? `Additional seats assigned: ${tableList} (Total: ${
                  existingSeatsCount + tablesToSubmit.length
                } seats)`
              : `Assigned to: ${tableList}`;
          
          showTableAssignmentStatus(successMessage, "success");

          // Clear selected tables
          window.selectedTables = [];

          // NOW log the entry after successful table assignment
          

          const logResult = await logEntry(bookingId, slotName);
          

          if (logResult === "success") {
            
            // Show final success message
            showStatus(
              "Entry successful! Click 'View Details' to see reservation info.",
              "success"
            );
            showViewDetailsButton(false); // Show View Details button after table assignment
          } else {
            
            showStatus(
              "Entry logged but table assignment may have failed",
              "warning"
            );
          }
        } catch (error) {
          
          showTableAssignmentStatus("Error assigning tables", "error");
        }
      }

      // Test form submission (for debugging)
      async function testFormSubmission() {
        const testBookingId = "TEST123";
        const testSlotName = "Day 1 - 22 Aug - Slot 1";
        const testTableSeat = "A1";

        const formUrl =
          "https://docs.google.com/forms/d/e/1FAIpQLScr_5q__XyAbcK3wfBdKCEFwN-iDD6M21jU3U9Ss0u2FQRH0g/formResponse";

        const formData = new FormData();
        formData.append("entry.863334335", testBookingId);
        formData.append("entry.1779047001", testSlotName);
        formData.append("entry.1374097765", testTableSeat);

        
        
        

        try {
          const response = await fetch(formUrl, {
            method: "POST",
            body: formData,
            mode: "no-cors",
          });

          
          
          
        } catch (error) {
          
        }
      }

      // Legacy function for single table assignment (kept for compatibility)
      async function selectTableForAssignment(tableSeat, bookingId, slotName) {
        closeManualTableSelectionModal();

        try {
          // Submit to table assignment form
          const formUrl =
            "https://docs.google.com/forms/d/e/1FAIpQLScr_5q__XyAbcK3wfBdKCEFwN-iDD6M21jU3U9Ss0u2FQRH0g/formResponse";

          const formData = new FormData();
          formData.append("entry.863334335", bookingId); // Booking ID
          formData.append("entry.1779047001", slotName); // Slot Name
          formData.append("entry.1374097765", tableSeat); // Table/Seat

          const response = await fetch(formUrl, {
            method: "POST",
            body: formData,
            mode: "no-cors",
          });

          
          showTableAssignmentStatus(`Assigned to ${tableSeat}`, "success");
        } catch (error) {
          
          showTableAssignmentStatus("Error assigning table", "error");
        }
      }

      // Show status modal
      function showStatus(message, type) {
        const statusModal = document.getElementById("statusModal");
        const statusIcon = document.getElementById("statusIcon");
        const statusTitle = document.getElementById("statusTitle");
        const statusMessage = document.getElementById("statusMessage");
        const statusViewDetailsBtn = document.getElementById(
          "statusViewDetailsBtn"
        );

        // Set icon, title, and message based on type
        if (type === "success") {
          statusIcon.innerHTML = "✅";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-green-500/20 border-2 border-green-500/40 success-glow";
          statusTitle.textContent = "Success!";
          statusTitle.className = "text-2xl font-bold text-green-200 mb-2";
        } else if (type === "error") {
          statusIcon.innerHTML = "❌";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-red-500/20 border-2 border-red-500/40 error-glow";
          statusTitle.textContent = "Error";
          statusTitle.className = "text-2xl font-bold text-red-200 mb-2";
        } else {
          statusIcon.innerHTML = "ℹ️";
          statusIcon.className =
            "w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-3xl bg-blue-500/20 border-2 border-blue-500/40";
          statusTitle.textContent = "Information";
          statusTitle.className = "text-2xl font-bold text-blue-200 mb-2";
        }

        statusMessage.textContent = message;
        statusMessage.className = "text-gray-300 text-base";

        // Hide view details button by default
        statusViewDetailsBtn.classList.add("hidden");

        // Show modal
        statusModal.classList.remove("hidden");
      }

      // Close status modal
      function closeStatusModal() {
        const statusModal = document.getElementById("statusModal");
        statusModal.classList.add("hidden");
      }

      // Handle Enter key
      document.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !isAuthenticated) {
          authenticate();
        }
      });

      // Handle manual entry keypress (Enter key)
      // Handle login keypress
      function handleLoginKeypress(event) {
        if (event.key === "Enter") {
          authenticate();
        }
      }

      // Show manual entry modal
      function showManualEntryModal() {
        const modal = document.getElementById("manualEntryModal");
        const input = document.getElementById("manualBookingId");

        // Clear previous input
        input.value = "";

        // Show modal
        modal.classList.remove("hidden");

        // Focus on input
        setTimeout(() => {
          input.focus();
        }, 100);
      }

      // Close manual entry modal
      function closeManualEntryModal() {
        const modal = document.getElementById("manualEntryModal");
        modal.classList.add("hidden");
      }

      // Handle manual entry keypress
      function handleManualEntryKeypress(event) {
        if (event.key === "Enter") {
          processManualEntry();
        }
      }

      // Update slot selection display
      function updateSlotSelection() {
        const slotSelector = document.getElementById("slotSelector");
        const selectedSlotInfo = document.getElementById("selectedSlotInfo");
        const selectedSlotText = document.getElementById("selectedSlotText");

        if (slotSelector.value) {
          selectedSlotText.textContent = `Currently scanning for: ${slotSelector.value}`;
          selectedSlotInfo.classList.remove("hidden");
        } else {
          selectedSlotInfo.classList.add("hidden");
        }
      }

      // Process manual entry
      function processManualEntry() {
        const bookingId = document
          .getElementById("manualBookingId")
          .value.trim();

        if (!bookingId) {
          showStatus("Please enter a booking ID", "error");
          return;
        }

        // Check if slot is selected
        const selectedSlot = document.getElementById("slotSelector").value;
        if (!selectedSlot) {
          showStatus("Please select a slot first", "error");
          return;
        }

        // Close the modal
        closeManualEntryModal();

        // Process the entry using the same logic as QR scan
        processEntry(bookingId, selectedSlot);
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
      });

      // Security: Clear session on page unload
      window.addEventListener("beforeunload", function () {
        if (!isAuthenticated) {
          sessionStorage.removeItem("entryAuthenticated");
        }
      });
    </script>
  </body>
</html>
