<!-- order.html – Food & Beverage Selection -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cafe Kyaa! – Order Selection</title>

    <!-- Quicksand + Tailwind -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --sat: env(safe-area-inset-top, 0);
        --sab: env(safe-area-inset-bottom, 0);
      }
      html {
        --vh: 1vh;
      }
      body {
        font-family: "Quicksand", sans-serif;
        min-height: calc(var(--vh) * 100);
        padding: var(--sat) 0 var(--sab);
        background: linear-gradient(
          -60deg,
          #fff1f2 0%,
          #ffe4e6 25%,
          #fce7f3 50%,
          #ffe5f8 75%,
          #fff1f2 100%
        );
        background-size: 400% 400%;
        animation: grad 18s ease infinite;
      }
      @keyframes grad {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .menu-item {
        transition: all 0.3s ease;
      }

      .menu-item:hover {
        transform: translateY(-2px);
      }

      .menu-item.selected {
        border-color: #ec4899;
        background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
      }

      .seat-card {
        transition: all 0.3s ease;
      }

      .seat-card:hover {
        transform: translateY(-1px);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .gradient-text {
        background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
    </style>
  </head>
  <body class="text-gray-800">
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- header -->
    <header
      class="fixed inset-x-0 top-0 bg-white/60 backdrop-blur-md shadow-sm z-40"
    >
      <div class="flex items-center justify-between h-16 px-4">
        <div class="flex items-center">
          <a href="index.html" class="flex items-center hover:opacity-80">
            <img src="logo.png" class="h-12 w-12 rounded-full" alt="logo" />
            <div class="ml-2 flex flex-col">
              <h1
                class="text-lg font-bold bg-gradient-to-r from-pink-600 to-rose-500 bg-clip-text text-transparent uppercase tracking-wide leading-tight"
              >
                Cafe Kyaa!
              </h1>
              <span class="text-xs font-medium text-rose-600 leading-tight">
                Anime India 2025 · Mumbai
              </span>
            </div>
          </a>
        </div>
        <!-- User Details Button -->
        <button
          id="userDetailsBtn"
          class="p-2 text-pink-600 hover:text-pink-700 hover:bg-pink-50 rounded-full transition-colors duration-200"
          title="View User Details"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            ></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- User Details Popup -->
    <div
      id="userDetailsPopup"
      class="fixed top-20 right-4 bg-white rounded-lg shadow-lg border border-pink-200 p-4 z-50 hidden transform transition-all duration-200 opacity-0 scale-95"
    >
      <div class="space-y-3 min-w-[280px]">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-gray-800">User Details</h3>
          <button
            id="closePopupBtn"
            class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
              ></path>
              <path
                d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
              ></path>
            </svg>
            <span class="text-gray-600">Email:</span>
            <span id="popupEmail" class="font-semibold text-gray-800"></span>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-gray-600">Booking ID:</span>
            <span id="popupBookingId" class="font-bold text-gray-800"></span>
            <button
              id="copyBookingIdPopupBtn"
              class="ml-2 p-1 text-pink-600 hover:text-pink-700 hover:bg-pink-50 rounded transition-colors duration-200"
              title="Copy Booking ID"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path>
              </svg>
            </button>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
              ></path>
            </svg>
            <span class="text-gray-600">Mobile:</span>
            <span id="popupMobile" class="font-semibold text-gray-800"></span>
          </div>

          <div class="flex items-center gap-2">
            <svg
              class="w-4 h-4 text-pink-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                clip-rule="evenodd"
              ></path>
            </svg>
            <span class="text-gray-600">Total:</span>
            <span class="font-bold text-gray-800"
              >₹<span id="popupAmount">0</span></span
            >
            <span class="text-gray-600"
              >(<span id="popupSeats">0</span> seats)</span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- main -->
    <main class="pt-24 flex flex-col items-center p-4">
              <div class="w-full max-w-4xl space-y-6">
        <!-- Countdown Timer -->
        <div id="countdownContainer" class="fade-in sticky top-20 z-30">
          <!-- Full-width frosted glass backdrop -->
          <div
            class="absolute inset-x-0 -top-6 -bottom-6 -mx-4 pointer-events-none"
            style="
              background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0.95) 20%,
                rgba(255, 255, 255, 0.3) 40%,
                rgba(255, 255, 255, 0) 80%
              );
            "
          ></div>

          <div
            class="bg-gradient-to-r from-orange-50/90 to-red-50/90 backdrop-blur-md border border-orange-200/80 rounded-xl p-4 shadow-xl relative overflow-hidden"
          >
            <!-- Decorative blur elements -->
            <div
              class="absolute -top-8 -right-8 w-16 h-16 bg-gradient-to-br from-orange-200 to-red-200 rounded-full opacity-30 blur-xl"
            ></div>
            <div
              class="absolute -bottom-8 -left-8 w-12 h-12 bg-gradient-to-br from-red-200 to-orange-200 rounded-full opacity-30 blur-xl"
            ></div>

            <div class="relative z-10 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-md"
                >
                  <svg
                    class="w-5 h-5 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-800">
                    Complete your booking
                  </h3>
                  <p class="text-xs text-gray-600">before time runs out</p>
                </div>
              </div>
              <div class="text-right">
                <div
                  id="countdownTimer"
                  class="text-2xl font-bold text-orange-600 font-mono"
                >
                  Loading...
                </div>
                <div class="text-xs text-gray-500">minutes:seconds</div>
              </div>
            </div>
          </div>
        </div>

        <section
          class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6 space-y-6 border border-pink-200"
        >
        <!-- User Details Section -->
        

        <!-- Seat Selection -->
        <div class="space-y-4">
          <div class="flex items-center gap-3 mb-4">
            <div
              class="w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-4 h-4 text-pink-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 14v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                ></path>
              </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-800">Select your Food & Beverage Items!</h3>
          </div>


          <div
            id="seatContainer"
            class="w-full"
          >
            <!-- Dynamic slot-based interface will be generated here -->
          </div>
        </div>

        <!-- Continue Button -->
        <div class="flex justify-center pt-6">
          <button
            id="continueBtn"
            class="w-full max-w-2xl bg-pink-600 hover:bg-pink-700 text-white py-3 rounded-xl font-semibold shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Continue to Payment
          </button>
        </div>
        <div class="mt-8 flex items-start gap-3">
          <div
            class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"
          >
            <svg
              class="w-5 h-5 text-blue-600"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </div>
          <div>
            <h4 class="font-semibold text-gray-800 mb-1 text-sm">
              Need Help?
            </h4>
            <p class="text-xs text-gray-600 break-words">
              You can reach out to us by raising a ticket via
              <a
                href="https://forms.gle/e5BpBj6z9hTnk1Kt7"
                target="_blank"
                class="text-blue-600 underline hover:text-blue-800 font-medium"
                >this form</a
              >. We will try to get back to you as soon as possible.
            </p>
          </div>
        </div>
      </section>

      
    </main>

    <!-- Loading Modal with Spinner -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl p-8 shadow-2xl text-center max-w-sm mx-4"
      >
        <div
          class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full spinner mb-6 mx-auto"
        ></div>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">
          Loading your details…
        </h2>
        <p class="text-gray-600">Please wait a moment.</p>
      </div>
    </div>

    <!-- Selection Modal -->
    <div
      id="selectionModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto"
      >
        <!-- Modal Header -->
        <div
          class="bg-gradient-to-r from-pink-500 to-rose-500 text-white p-6 rounded-t-2xl"
        >
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-bold">
              Select Items for <span id="modalSeatTitle">Seat 1</span>
            </h3>
            <button
              id="closeModal"
              class="text-white hover:text-gray-200 transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
          <!-- Food Selection -->
          <div class="space-y-3">
            <h4
              class="text-lg font-semibold text-gray-800 flex items-center gap-2"
            >
              <div
                class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center"
              >
                <svg
                  class="w-3 h-3 text-orange-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              Food Item
            </h4>
            <div class="space-y-2">
              <label
                class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
              >
                <input
                  type="radio"
                  name="food"
                  value="omurice"
                  class="mr-3 text-pink-600 focus:ring-pink-500"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-800">Omurice</div>
                  <div class="text-sm text-gray-600">
                    Japanese omelette rice with ketchup
                  </div>
                </div>
              </label>
              <label
                class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
              >
                <input
                  type="radio"
                  name="food"
                  value="curry-rice"
                  class="mr-3 text-pink-600 focus:ring-pink-500"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-800">Curry Rice</div>
                  <div class="text-sm text-gray-600">
                    Japanese curry with rice and vegetables
                  </div>
                </div>
              </label>
            </div>
          </div>

          <!-- Beverage Selection -->
          <div class="space-y-3">
            <h4
              class="text-lg font-semibold text-gray-800 flex items-center gap-2"
            >
              <div
                class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center"
              >
                <svg
                  class="w-3 h-3 text-blue-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              Beverage
            </h4>
            <div class="space-y-2">
              <label
                class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
              >
                <input
                  type="radio"
                  name="beverage"
                  value="iced-tea"
                  class="mr-3 text-pink-600 focus:ring-pink-500"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-800">Iced Tea</div>
                  <div class="text-sm text-gray-600">
                    Refreshing iced black tea
                  </div>
                </div>
              </label>
              <label
                class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
              >
                <input
                  type="radio"
                  name="beverage"
                  value="lemon-tea"
                  class="mr-3 text-pink-600 focus:ring-pink-500"
                />
                <div class="flex-1">
                  <div class="font-medium text-gray-800">Plain Water</div>
                  <div class="text-sm text-gray-600">
                    It's just water. H₂O. Mizu.
                  </div>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex gap-3">
          <button
            id="saveSelection"
            class="flex-1 bg-pink-600 hover:bg-pink-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors"
          >
            Save Selection
          </button>
          <button
            id="cancelSelection"
            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      // ===== REFERRER CHECK =====
      /*const allowedReferrer = window.location.origin + "/slotselection.html";
      const urlParams = new URLSearchParams(window.location.search);
      const hasCode = urlParams.has("code");

      // Extract base URL from referrer (remove query parameters)
      const referrerUrl = new URL(document.referrer);
      const baseReferrer = referrerUrl.origin + referrerUrl.pathname;

      if (baseReferrer !== allowedReferrer || !hasCode) {
        console.log(
          "Access denied: Invalid referrer or missing code parameter"
        );
        console.log("Expected referrer:", allowedReferrer);
        console.log("Actual referrer:", document.referrer);
        console.log("Base referrer:", baseReferrer);
        console.log("Has code parameter:", hasCode);
        alert("Please access this page through the proper booking flow.");
        window.location.href = "initiatebooking.html";
      }*/

      // ===== COUNTDOWN TIMER CONFIGURATION =====
      let countdownInterval;
      let timeoutOccurred = false;

      const initializeCountdownTimer = async (bookingId) => {
        try {
          console.log("=== INITIALIZING COUNTDOWN TIMER ===");
          console.log("Booking ID:", bookingId);

          // Fetch data from Slot Blocking Sources sheet
          const sheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
          const sheetName = "Slot Blocking Sources";
          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(
            sheetName
          )}&tq=${query}`;

          console.log("Fetching data from:", url);

          const response = await fetch(url);
          const data = await response.text();
          const json = JSON.parse(data.substring(47).slice(0, -2));
          const rows = json.table.rows;

          console.log("Total rows fetched:", rows.length);

          // Find the last occurrence of the booking ID with status "Processing"
          let lastProcessingEntry = null;
          for (let i = rows.length - 1; i >= 0; i--) {
            const row = rows[i];
            const rowBookingId = row.c[3]?.v ? String(row.c[3].v).trim() : "";
            const status = row.c[4]?.v ? String(row.c[4].v).trim() : "";

            if (rowBookingId === bookingId && status === "Processing") {
              lastProcessingEntry = row;
              break;
            }
          }

          if (!lastProcessingEntry) {
            console.error(
              "No Processing entry found for booking ID:",
              bookingId
            );
            document.getElementById("countdownTimer").textContent = "N/A";
            return;
          }

          // Extract timestamp from the first column
          const timestampStr = lastProcessingEntry.c[0]?.v;
          if (!timestampStr) {
            console.error("No timestamp found in Processing entry");
            document.getElementById("countdownTimer").textContent = "N/A";
            return;
          }

          console.log("Found Processing entry timestamp:", timestampStr);

          // Parse the timestamp from Google Sheets format
          let timestamp;
          if (
            typeof timestampStr === "string" &&
            timestampStr.startsWith("Date(")
          ) {
            // Parse Google Sheets Date format: "Date(2025,7,1,10,19,16)"
            const match = timestampStr.match(
              /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/
            );
            if (match) {
              const [, year, month, day, hour, minute, second] = match;
              // Note: Google Sheets months are 1-indexed, JavaScript is 0-indexed
              // But it seems the month values are already 0-indexed in the data
              timestamp = new Date(
                parseInt(year),
                parseInt(month),
                parseInt(day),
                parseInt(hour),
                parseInt(minute),
                parseInt(second)
              );
            } else {
              console.error(
                "Could not parse timestamp format:",
                timestampStr
              );
              document.getElementById("countdownTimer").textContent = "N/A";
              return;
            }
          } else {
            // Try direct Date constructor as fallback
            timestamp = new Date(timestampStr);
          }

          if (isNaN(timestamp.getTime())) {
            console.error("Invalid timestamp after parsing:", timestampStr);
            document.getElementById("countdownTimer").textContent = "N/A";
            return;
          }

          const tPlus10 = new Date(timestamp.getTime() + 10 * 60 * 1000); // T + 10 minutes

          console.log("Original timestamp:", timestamp);
          console.log("T+10 deadline:", tPlus10);

          // Start countdown
          updateCountdown(tPlus10);
        } catch (error) {
          console.error("Error initializing countdown timer:", error);
          document.getElementById("countdownTimer").textContent = "Error";
        }
      };

      const updateCountdown = (deadline) => {
        const updateTimer = () => {
          if (timeoutOccurred) return;

          const now = new Date();
          const timeLeft = deadline - now;

          if (timeLeft <= 0) {
            // Timeout occurred
            timeoutOccurred = true;
            clearInterval(countdownInterval);

            console.log("=== TIMEOUT OCCURRED ===");
            console.log("Current time:", now);
            console.log("Deadline:", deadline);
            console.log("Time left:", timeLeft);

            // Show timeout message
            document.getElementById("countdownTimer").textContent = "00:00";
            document
              .getElementById("countdownTimer")
              .classList.add("text-red-600");

            // Notify user and redirect
            alert(
              "Payment timeout occurred. Your booking has expired. You will be redirected to the booking failed page."
            );
            window.location.href = "bookingfailed.html";
            return;
          }

          // Calculate minutes and seconds
          const minutes = Math.floor(timeLeft / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

          // Check for valid numbers
          if (isNaN(minutes) || isNaN(seconds)) {
            console.error("Invalid time calculation:", {
              timeLeft,
              minutes,
              seconds,
            });
            document.getElementById("countdownTimer").textContent = "Error";
            return;
          }

          // Update display
          const displayText = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          document.getElementById("countdownTimer").textContent = displayText;

          // Change color when less than 2 minutes remaining
          if (timeLeft < 2 * 60 * 1000) {
            document
              .getElementById("countdownTimer")
              .classList.add("text-red-600");
          } else if (timeLeft < 5 * 60 * 1000) {
            document
              .getElementById("countdownTimer")
              .classList.add("text-orange-600");
          } else {
            document
              .getElementById("countdownTimer")
              .classList.remove("text-red-600", "text-orange-600");
          }

          console.log("Countdown updated:", displayText);
        };

        // Update immediately
        updateTimer();

        // Update every second
        countdownInterval = setInterval(updateTimer, 1000);
      };

      // ===== ORDER TRACKING CONFIGURATION =====
      const orderFormURL =
        "https://docs.google.com/forms/d/e/1FAIpQLSc98yaLaB8GrnXKEo-gXUiGLsGVbXH7XHktNUt9arN850hrTQ/formResponse";
      const orderSheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const orderSheetName = "TabBlocking";

      // Function to check if Order already exists for a booking ID
      const checkOrderExists = async (bookingId) => {
        try {
          console.log("=== CHECKING ORDER STATUS ===");
          console.log(`Checking booking ID: "${bookingId}"`);

          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${orderSheetID}/gviz/tq?sheet=${encodeURIComponent(
            orderSheetName
          )}&tq=${query}`;

          console.log("Making fetch request to check order...");
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.text();
          const jsonStart = data.indexOf("{");
          const jsonEnd = data.lastIndexOf("}") + 1;
          const jsonData = data.substring(jsonStart, jsonEnd);
          const json = JSON.parse(jsonData);

          const rows = json.table.rows;
          console.log(`Total rows in sheet: ${rows.length}`);

          // Search for the booking ID in column B (index 1) and check if Order exists in column C (index 2)
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const bookingIdInSheet = row.c[1]?.v
              ? String(row.c[1].v).trim()
              : ""; // Column B (index 1)
            const tabToBlock = row.c[2]?.v ? String(row.c[2].v).trim() : ""; // Column C (index 2)

            console.log(
              `Row ${i}: Booking ID = "${bookingIdInSheet}", Tab To Block = "${tabToBlock}"`
            );

            if (bookingIdInSheet === bookingId) {
              console.log(`Found booking ID "${bookingId}" in row ${i}`);

              if (tabToBlock === "Order") {
                console.log(`Order found in row ${i} - User should be blocked`);
                return true;
              } else {
                console.log(
                  `Booking ID found but Tab To Block is "${tabToBlock}" (not Order)`
                );
              }
            }
          }

          console.log(
            `Booking ID "${bookingId}" not found in sheet or no Order recorded`
          );
          return false;
        } catch (error) {
          console.error("Error checking order status:", error);
          return false;
        }
      };

      // Function to write Order to form
      const writeOrder = async (bookingId) => {
        try {
          console.log("=== WRITING ORDER ===");
          console.log(`Writing booking ID: "${bookingId}"`);

          const formData = new FormData();
          formData.append("entry.1737294711", bookingId); // Booking ID
          formData.append("entry.1621765122", "Order"); // Order

          const response = await fetch(orderFormURL, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          });

          console.log("Order data written successfully");
          return true;
        } catch (error) {
          console.error("Error writing order:", error);
          return false;
        }
      };

      // Function to initialize order tracking
      const initializeOrderTracking = async (bookingId) => {
        try {
          console.log("=== INITIALIZING ORDER TRACKING ===");

          if (!bookingId) {
            console.log("No booking ID provided");
            return;
          }

          // Check if Order already exists
          const orderExists = await checkOrderExists(bookingId);

          if (orderExists) {
            console.log("Order already exists - Reload/Forward/Back detected");
            alert(
              "Reload/Forward/Back was detected. Please start booking again."
            );
            window.location.href = "initiatebooking.html";
            return;
          }

          // Write Order to form
          console.log("Order not found - writing to form");
          const writeSuccess = await writeOrder(bookingId);

          if (writeSuccess) {
            console.log("Order tracking initialized successfully");
          } else {
            console.log("Failed to write order data");
          }
        } catch (error) {
          console.error("Error in order tracking:", error);
        }
      };

      // Global variables for user details
      let userEmail = "";
      let userMobile = "";
      let userSeats = 0;
      let userBookingId = "";
      let userAmount = 0;
      let userSlotSelections = []; // New: Store user's slot selections

      // ===== AVAILABILITY UPDATER SHEET CONFIGURATION =====
      const availabilityUpdaterSheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const availabilityUpdaterSheetName = "Availability Updater";

      // ===== FETCH USER SLOT SELECTIONS =====
      const fetchUserSlotSelections = async (bookingId) => {
        try {
          console.log("=== FETCHING USER SLOT SELECTIONS ===");
          console.log(`Booking ID: "${bookingId}"`);
          console.log(`Sheet ID: ${availabilityUpdaterSheetID}`);
          console.log(`Sheet Name: ${availabilityUpdaterSheetName}`);

          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${availabilityUpdaterSheetID}/gviz/tq?sheet=${encodeURIComponent(availabilityUpdaterSheetName)}&tq=${query}`;

          console.log("Query URL:", url);
          const response = await fetch(url);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.text();
          const jsonStart = data.indexOf("{");
          const jsonEnd = data.lastIndexOf("}") + 1;
          const jsonData = data.substring(jsonStart, jsonEnd);
          const json = JSON.parse(jsonData);

          const rows = json.table.rows;
          console.log(`Total rows in sheet: ${rows.length}`);

          const userSlots = [];

          // Search for rows with matching booking ID and Active status
          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const rowBookingId = row.c[1]?.v ? String(row.c[1].v).trim() : ""; // Column B (Booking ID)
            const seatCount = row.c[2]?.v ? parseInt(row.c[2].v) : 0; // Column C (Number of Seats)
            const slotId = row.c[3]?.v ? String(row.c[3].v).trim() : ""; // Column D (Slot ID)
            const expiry = row.c[4]?.v ? String(row.c[4].v).trim() : ""; // Column E (Expiry)

            console.log(`Row ${i}: Booking ID = "${rowBookingId}", Seats = ${seatCount}, Slot = "${slotId}", Expiry = "${expiry}"`);

            if (rowBookingId === bookingId && expiry === "Active") {
              console.log(`Found active slot for booking ID "${bookingId}": ${slotId} with ${seatCount} seats`);
              userSlots.push({
                slotId: slotId,
                seatCount: seatCount,
                bookingId: bookingId
              });
            }
          }

          console.log(`Total active slots found for booking ID "${bookingId}": ${userSlots.length}`);
          console.log("User slots:", userSlots);

          return userSlots;
        } catch (error) {
          console.error("Error fetching user slot selections:", error);
          return [];
        }
      };

      // ===== SLOT NAME MAPPING =====
      const slotNameMapping = {
        "Slot 1": "11:00 AM",
        "Slot 2": "1:00 PM", 
        "Slot 3": "3:00 PM",
        "Slot 4": "5:00 PM",
      };

      // ===== DAY DATE MAPPING =====
      const dayDateMapping = {
        "Day 1": "Fri, 22 Aug 2025",
        "Day 2": "Sat, 23 Aug 2025", 
        "Day 3": "Sun, 24 Aug 2025",
      };

      // ===== CREATE DYNAMIC ORDER INTERFACE =====
      const createOrderInterface = (slotSelections) => {
        const seatContainer = document.getElementById("seatContainer");
        
        if (!seatContainer) {
          console.error("seatContainer element not found");
          return;
        }

        if (slotSelections.length === 0) {
          seatContainer.innerHTML = `
            <div class="text-center py-8">
              <div class="text-gray-500 text-lg">No active slot selections found.</div>
              <div class="text-gray-400 text-sm mt-2">Please ensure you have completed slot selection.</div>
            </div>
          `;
          return;
        }

        let interfaceHTML = `
          <div class="space-y-8 w-full">
            <div class="text-center">

            </div>
        `;

        // Create interface for each slot
        slotSelections.forEach((slot, slotIndex) => {
          // Extract day and slot from slotId (e.g., "Day 1 - 22 Aug - Slot 1")
          const dayMatch = slot.slotId.match(/^(Day \d+)/);
          const slotMatch = slot.slotId.match(/Slot (\d+)$/);
          
          let displayName = slot.slotId; // fallback
          let displayDate = "";
          
          if (dayMatch && slotMatch) {
            const day = dayMatch[1];
            const slotNumber = slotMatch[1];
            const timeSlot = slotNameMapping[`Slot ${slotNumber}`];
            const date = dayDateMapping[day];
            
            if (timeSlot && date) {
              displayName = `${timeSlot}`;
              displayDate = date;
            }
          }
          
          interfaceHTML += `
            <div class="bg-white rounded-xl border border-gray-200 p-6 w-full" data-slot-index="${slotIndex}">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-lg font-semibold text-gray-800">${displayName}</h3>
                  <p class="text-sm text-gray-500">${displayDate}</p>
                </div>
                <span class="text-sm text-gray-500">${slot.seatCount} seat${slot.seatCount > 1 ? 's' : ''}</span>
              </div>
              
              <!-- Food Items for this slot -->
              <div class="mb-8">
                <h4 class="text-md font-medium text-gray-700 mb-4">Food Items (${slot.seatCount} total)</h4>
                <div class="space-y-4">
                  <!-- Omurice -->
                  <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <div class="flex items-center gap-4">
                      <button 
                        class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center text-white hover:from-orange-600 hover:to-red-600 transition-all duration-200 hover:scale-105 flex-shrink-0"
                        onclick="showItemInfo('omurice', 'Omurice', 'Japanese-style omelette rice with ketchup and vegetables', 'assets/orderitems/omurice.png')"
                        title="View Omurice details"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </button>
                      <div>
                        <h5 class="text-base font-semibold text-gray-800">Omurice</h5>
                        <p class="text-xs text-gray-500">Japanese-style omelette rice</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="omuriceQty_${slotIndex}">0</div>
                        <div class="text-xs text-gray-500">Selected</div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button id="omuriceDec_${slotIndex}" class="w-8 h-8 bg-gray-100 text-gray-600 rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:bg-gray-200 hover:scale-105 flex-shrink-0">−</button>
                        <button id="omuriceInc_${slotIndex}" class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:from-orange-600 hover:to-red-600 hover:scale-105 flex-shrink-0">+</button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Curry Rice -->
                  <div class="flex items-center justify-between py-3">
                    <div class="flex items-center gap-4">
                      <button 
                        class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full flex items-center justify-center text-white hover:from-yellow-600 hover:to-orange-600 transition-all duration-200 hover:scale-105 flex-shrink-0"
                        onclick="showItemInfo('curryRice', 'Curry Rice', 'Spicy Japanese curry with rice and vegetables', 'assets/orderitems/curryrice.png')"
                        title="View Curry Rice details"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </button>
                      <div>
                        <h5 class="text-base font-semibold text-gray-800">Curry Rice</h5>
                        <p class="text-xs text-gray-500">Spicy Japanese curry</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="curryRiceQty_${slotIndex}">0</div>
                        <div class="text-xs text-gray-500">Selected</div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button id="curryRiceDec_${slotIndex}" class="w-8 h-8 bg-gray-100 text-gray-600 rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:bg-gray-200 hover:scale-105 flex-shrink-0">−</button>
                        <button id="curryRiceInc_${slotIndex}" class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:from-orange-600 hover:to-red-600 hover:scale-105 flex-shrink-0">+</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Beverage Items for this slot -->
              <div>
                <h4 class="text-md font-medium text-gray-700 mb-4">Beverage Items (${slot.seatCount} total)</h4>
                <div class="space-y-4">
                  <!-- Iced Tea -->
                  <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <div class="flex items-center gap-4">
                      <button 
                        class="w-8 h-8 bg-gradient-to-br from-green-500 to-teal-500 rounded-full flex items-center justify-center text-white hover:from-green-600 hover:to-teal-600 transition-all duration-200 hover:scale-105 flex-shrink-0"
                        onclick="showItemInfo('icedTea', 'Iced Tea', 'Refreshing iced tea with lemon', 'assets/orderitems/icedtea.png')"
                        title="View Iced Tea details"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </button>
                      <div>
                        <h5 class="text-base font-semibold text-gray-800">Iced Tea</h5>
                        <p class="text-xs text-gray-500">Refreshing iced tea</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="icedTeaQty_${slotIndex}">0</div>
                        <div class="text-xs text-gray-500">Selected</div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button id="icedTeaDec_${slotIndex}" class="w-8 h-8 bg-gray-100 text-gray-600 rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:bg-gray-200 hover:scale-105 flex-shrink-0">−</button>
                        <button id="icedTeaInc_${slotIndex}" class="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:from-green-600 hover:to-teal-600 hover:scale-105 flex-shrink-0">+</button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Plain Water -->
                  <div class="flex items-center justify-between py-3">
                    <div class="flex items-center gap-4">
                      <button 
                        class="w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-white hover:from-blue-600 hover:to-cyan-600 transition-all duration-200 hover:scale-105 flex-shrink-0"
                        onclick="showItemInfo('plainWater', 'Plain Water', 'Fresh drinking water', 'assets/orderitems/plainwater.png')"
                        title="View Plain Water details"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </button>
                      <div>
                        <h5 class="text-base font-semibold text-gray-800">Plain Water</h5>
                        <p class="text-xs text-gray-500">Fresh drinking water</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3">
                      <div class="text-center">
                        <div class="text-lg font-bold text-gray-800" id="plainWaterQty_${slotIndex}">0</div>
                        <div class="text-xs text-gray-500">Selected</div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button id="plainWaterDec_${slotIndex}" class="w-8 h-8 bg-gray-100 text-gray-600 rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:bg-gray-200 hover:scale-105 flex-shrink-0">−</button>
                        <button id="plainWaterInc_${slotIndex}" class="w-8 h-8 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-full text-sm font-bold flex items-center justify-center transition-all duration-200 hover:from-blue-600 hover:to-cyan-600 hover:scale-105 flex-shrink-0">+</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Progress for this slot -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                  <span>Food: <span id="foodProgress_${slotIndex}">0</span>/${slot.seatCount}</span>
                  <span>Beverages: <span id="beverageProgress_${slotIndex}">0</span>/${slot.seatCount}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div id="progressBar_${slotIndex}" class="bg-gradient-to-r from-pink-500 to-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
              </div>
            </div>
          `;
        });

        interfaceHTML += `
          <!-- Overall Progress -->
          <div class="bg-white rounded-xl border border-gray-200 p-6 w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Overall Progress</h3>
            <div class="flex justify-between text-sm text-gray-600 mb-3">
              <span>Total Food: <span id="totalFoodProgress">0</span>/${userSeats}</span>
              <span>Total Beverages: <span id="totalBeverageProgress">0</span>/${userSeats}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="totalProgressBar" class="bg-gradient-to-r from-pink-500 to-orange-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
        </div>
        `;

        seatContainer.innerHTML = interfaceHTML;
        
        // Initialize quantities for each slot
        initializeSlotQuantities(slotSelections);
      };

      // ===== INITIALIZE SLOT QUANTITIES =====
      const initializeSlotQuantities = (slotSelections) => {
        // Store quantities for each slot
        window.slotQuantities = {};
        
        slotSelections.forEach((slot, slotIndex) => {
          window.slotQuantities[slotIndex] = {
            omurice: 0,
            curryRice: 0,
            icedTea: 0,
            plainWater: 0
          };
        });

        // Add event listeners for all buttons
        slotSelections.forEach((slot, slotIndex) => {
          const items = ['omurice', 'curryRice', 'icedTea', 'plainWater'];
          
          items.forEach(item => {
            const decBtn = document.getElementById(`${item}Dec_${slotIndex}`);
            const incBtn = document.getElementById(`${item}Inc_${slotIndex}`);
            
            if (decBtn && incBtn) {
              decBtn.addEventListener('click', () => updateSlotQuantity(slotIndex, item, -1, slot.seatCount));
              incBtn.addEventListener('click', () => updateSlotQuantity(slotIndex, item, 1, slot.seatCount));
            }
          });
        });
      };

      // ===== UPDATE SLOT QUANTITY =====
      const updateSlotQuantity = (slotIndex, item, delta, maxSeats) => {
        const currentQty = window.slotQuantities[slotIndex][item];
        const newQty = Math.max(0, currentQty + delta);
        
        // Check if this would exceed the slot's seat count
        const currentFood = window.slotQuantities[slotIndex].omurice + window.slotQuantities[slotIndex].curryRice;
        const currentBeverages = window.slotQuantities[slotIndex].icedTea + window.slotQuantities[slotIndex].plainWater;
        
        let newFood = currentFood;
        let newBeverages = currentBeverages;
        
        if (item === 'omurice' || item === 'curryRice') {
          newFood = currentFood + delta;
        } else if (item === 'icedTea' || item === 'plainWater') {
          newBeverages = currentBeverages + delta;
        }
        
        // Check limits
        if (newQty >= 0 && newFood <= maxSeats && newBeverages <= maxSeats) {
          window.slotQuantities[slotIndex][item] = newQty;
          document.getElementById(`${item}Qty_${slotIndex}`).textContent = newQty;
          
          // Update progress for this slot
          updateSlotProgress(slotIndex, maxSeats);
          
          // Update overall progress
          updateOverallProgress();
          
          // Update button states
          updateSlotButtonStates(slotIndex, maxSeats);
        }
      };

      // ===== UPDATE SLOT PROGRESS =====
      const updateSlotProgress = (slotIndex, maxSeats) => {
        const quantities = window.slotQuantities[slotIndex];
        const foodTotal = quantities.omurice + quantities.curryRice;
        const beverageTotal = quantities.icedTea + quantities.plainWater;
        
        document.getElementById(`foodProgress_${slotIndex}`).textContent = foodTotal;
        document.getElementById(`beverageProgress_${slotIndex}`).textContent = beverageTotal;
        
        const progressPercentage = ((foodTotal + beverageTotal) / (maxSeats * 2)) * 100;
        document.getElementById(`progressBar_${slotIndex}`).style.width = `${progressPercentage}%`;
      };

      // ===== UPDATE OVERALL PROGRESS =====
      const updateOverallProgress = () => {
        let totalFood = 0;
        let totalBeverages = 0;
        
        Object.values(window.slotQuantities).forEach(quantities => {
          totalFood += quantities.omurice + quantities.curryRice;
          totalBeverages += quantities.icedTea + quantities.plainWater;
        });
        
        document.getElementById('totalFoodProgress').textContent = totalFood;
        document.getElementById('totalBeverageProgress').textContent = totalBeverages;
        
        const progressPercentage = ((totalFood + totalBeverages) / (userSeats * 2)) * 100;
        document.getElementById('totalProgressBar').style.width = `${progressPercentage}%`;
        
        // Update continue button state
        const continueBtn = document.getElementById('continueBtn');
        if (continueBtn) {
          const isComplete = totalFood === userSeats && totalBeverages === userSeats;
          continueBtn.disabled = !isComplete;
          continueBtn.classList.toggle('opacity-50', !isComplete);
          continueBtn.classList.toggle('cursor-not-allowed', !isComplete);
        }
      };

      // ===== UPDATE SLOT BUTTON STATES =====
      const updateSlotButtonStates = (slotIndex, maxSeats) => {
        const quantities = window.slotQuantities[slotIndex];
        const foodTotal = quantities.omurice + quantities.curryRice;
        const beverageTotal = quantities.icedTea + quantities.plainWater;
        
        const items = ['omurice', 'curryRice', 'icedTea', 'plainWater'];
        
        items.forEach(item => {
          const decBtn = document.getElementById(`${item}Dec_${slotIndex}`);
          const incBtn = document.getElementById(`${item}Inc_${slotIndex}`);
          
          if (decBtn && incBtn) {
            const qty = quantities[item];
            
            // Decrease button
            decBtn.disabled = qty === 0;
            decBtn.classList.toggle('opacity-40', qty === 0);
            decBtn.classList.toggle('cursor-not-allowed', qty === 0);
            
            // Increase button
            let canAdd = false;
            if (item === 'omurice' || item === 'curryRice') {
              canAdd = foodTotal < maxSeats;
            } else {
              canAdd = beverageTotal < maxSeats;
            }
            
            incBtn.disabled = !canAdd;
            incBtn.classList.toggle('opacity-40', !canAdd);
            incBtn.classList.toggle('cursor-not-allowed', !canAdd);
          }
        });
      };

      // ===== SUBMIT ORDERS FOR ALL SLOTS =====
      const submitOrdersForAllSlots = async () => {
        const foodFormURL = "https://docs.google.com/forms/d/e/1FAIpQLSfAJIyMEWNSuoY1Ltqd7nxy1AMvo6-WICBMEa8Vx_S97WnjJw/formResponse";
        
        for (let slotIndex = 0; slotIndex < userSlotSelections.length; slotIndex++) {
          const slot = userSlotSelections[slotIndex];
          const quantities = window.slotQuantities[slotIndex];
          
          console.log(`Submitting order for ${slot.slotId}:`, quantities);
          
          const formData = new FormData();
          formData.append("entry.1027873371", userBookingId); // Booking ID
          formData.append("entry.460493809", slot.slotId); // Slot ID
          formData.append("entry.1770511778", quantities.omurice.toString()); // Omurice Qty
          formData.append("entry.296635150", quantities.curryRice.toString()); // Curry Rice Qty
          formData.append("entry.900654767", quantities.icedTea.toString()); // Iced Tea Qty
          formData.append("entry.1335814590", quantities.plainWater.toString()); // Plain Water Qty
          
          try {
            await fetch(foodFormURL, {
              method: "POST",
              mode: "no-cors",
              body: formData,
            });
            console.log(`Order submitted successfully for ${slot.slotId}`);
            
            // Add a small delay between submissions
            await new Promise((resolve) => setTimeout(resolve, 200));
          } catch (error) {
            console.error(`Error submitting order for ${slot.slotId}:`, error);
            throw error;
          }
        }
      };

      // Google Sheet configuration for user details
      const userDetailsSheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
      const userDetailsSheetName = "Raw Data";

      // Function to fetch user details from Google Sheet
      async function fetchUserDetails(bookingId) {
        console.log("=== FETCH USER DETAILS START ===");
        console.log("Input booking ID:", JSON.stringify(bookingId));
        console.log("Sheet ID:", userDetailsSheetID);
        console.log("Sheet Name:", userDetailsSheetName);

        try {
          const query = encodeURIComponent("SELECT *");
          const url = `https://docs.google.com/spreadsheets/d/${userDetailsSheetID}/gviz/tq?sheet=${userDetailsSheetName}&tq=${query}`;

          console.log("Query URL:", url);
          console.log("Making fetch request...");

          const response = await fetch(url);
          console.log("Response status:", response.status);
          console.log("Response ok:", response.ok);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.text();
          console.log("Response data length:", data.length);
          console.log(
            "Raw response (first 500 chars):",
            data.substring(0, 500)
          );

          // Parse the response
          const jsonStart = data.indexOf("{");
          const jsonEnd = data.lastIndexOf("}") + 1;
          const jsonData = data.substring(jsonStart, jsonEnd);

          console.log("Parsing JSON response...");
          const json = JSON.parse(jsonData);
          console.log("JSON parsed successfully");
          console.log("JSON structure:", Object.keys(json));

          const rows = json.table.rows;
          console.log("Total rows in sheet:", rows.length);

          // Search for the booking ID
          console.log("Searching for booking ID:", JSON.stringify(bookingId));
          console.log("First few rows for debugging:");

          for (let i = 0; i < Math.min(3, rows.length); i++) {
            const row = rows[i];
            const hashValue = row.c[4]?.v ? String(row.c[4].v).trim() : "";
            console.log(
              `Row ${i}: col0="${row.c[0]?.v || ""}", col1="${
                row.c[1]?.v || ""
              }", col2="${row.c[2]?.v || ""}", col3="${
                row.c[3]?.v || ""
              }", col4="${hashValue}", col5="${row.c[5]?.v || ""}", col6="${
                row.c[6]?.v || ""
              }", col7="${row.c[7]?.v || ""}", col8="${
                row.c[8]?.v || ""
              }", col9="${row.c[9]?.v || ""}", col10="${row.c[10]?.v || ""}"`
            );
          }

          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const hashValue = row.c[4]?.v ? String(row.c[4].v).trim() : "";

            console.log(
              `Row ${i}: Hash value = "${hashValue}", looking for "${bookingId}"`
            );

            if (hashValue === bookingId) {
              console.log(
                `Row ${i} comparison: "${hashValue}" === "${bookingId}" = true`
              );

              // Additional debugging for type checking
              console.log(
                `Row ${i} - hashValue type: ${typeof hashValue}, length: ${
                  hashValue.length
                }`
              );
              console.log(
                `Row ${i} - bookingId type: ${typeof bookingId}, length: ${
                  bookingId.length
                }`
              );
              console.log(
                `Row ${i} - hashValue char codes: ${Array.from(hashValue)
                  .map((c) => c.charCodeAt(0))
                  .join(", ")}`
              );
              console.log(
                `Row ${i} - bookingId char codes: ${Array.from(bookingId)
                  .map((c) => c.charCodeAt(0))
                  .join(", ")}`
              );

              // Try trimming both values
              const trimmedHash = hashValue.trim();
              const trimmedBookingId = bookingId.trim();
              console.log(`Row ${i} - hashValue trimmed: "${trimmedHash}"`);
              console.log(
                `Row ${i} - bookingId trimmed: "${trimmedBookingId}"`
              );
              console.log(
                `Row ${i} - trimmed comparison: "${trimmedHash}" === "${trimmedBookingId}" = ${
                  trimmedHash === trimmedBookingId
                }`
              );

              if (trimmedHash === trimmedBookingId) {
                console.log(
                  `Found matching booking ID in row ${i} (exact match)`
                );

                const userDetails = {
                  email: row.c[1]?.v || "",
                  seats: parseInt(row.c[2]?.v) || 0,
                  mobile: row.c[3]?.v || "",
                  hash: row.c[4]?.v || "",
                };

                console.log("User details found:", userDetails);
                console.log("=== FETCH USER DETAILS SUCCESS ===");
                return userDetails;
              }
            } else {
              console.log(
                `Row ${i} comparison: "${hashValue}" === "${bookingId}" = false`
              );
            }
          }

          console.log("No matching booking ID found");
          console.log("=== FETCH USER DETAILS FAILED ===");
          return null;
        } catch (error) {
          console.error("Error fetching user details:", error);
          console.log("=== FETCH USER DETAILS FAILED ===");
          return null;
        }
      }

      // Function to initialize user details
      async function initializeUserDetails() {
        console.log("=== INITIALIZE USER DETAILS START ===");

        try {
          const params = new URLSearchParams(location.search);
          const bookingId = params.get("code")?.trim();

          console.log("Booking ID from URL:", JSON.stringify(bookingId));
          console.log("Sheet ID:", userDetailsSheetID);
          console.log("Sheet Name:", userDetailsSheetName);

          if (!bookingId) {
            console.log("No booking ID found in URL parameters");

            // Hide loading modal
            const loadingModal = document.getElementById("loadingModal");
            if (loadingModal) {
              loadingModal.classList.add("hidden");
            }

            alert("No booking ID found. Please start from the beginning.");
            window.location.href = "index.html";
            return;
          }

          console.log("Waiting 2 seconds before fetching...");
          await new Promise((resolve) => setTimeout(resolve, 2000));
          console.log("2-second wait completed, now fetching user details...");

          const userDetails = await fetchUserDetails(bookingId);

          if (!userDetails) {
            console.log("Failed to fetch user details");

            // Hide loading modal
            const loadingModal = document.getElementById("loadingModal");
            if (loadingModal) {
              loadingModal.classList.add("hidden");
            }

            alert("Failed to load user details. Please try again.");
            window.location.href = "initiatebooking.html";
            return;
          }

          console.log("User details returned:", userDetails);

          // Validate user details
          console.log("Validating user details:");
          console.log("Email:", JSON.stringify(userDetails.email));
          console.log("Mobile:", JSON.stringify(userDetails.mobile));
          console.log("Seats:", userDetails.seats);

          if (
            !userDetails.email ||
            !userDetails.mobile ||
            userDetails.seats <= 0
          ) {
            console.log("User details validation failed");

            // Hide loading modal
            const loadingModal = document.getElementById("loadingModal");
            if (loadingModal) {
              loadingModal.classList.add("hidden");
            }

            alert("Invalid user details. Please try again.");
            window.location.href = "initiatebooking.html";
            return;
          }

          console.log("User details validation passed");

          // Set global variables
          userEmail = userDetails.email;
          userMobile = userDetails.mobile;
          userSeats = userDetails.seats;
          userBookingId = bookingId;
          userAmount = userDetails.seats * 500; // Calculate amount

          console.log("Global variables set:");
          console.log("Email:", userEmail);
          console.log("Mobile:", userMobile);
          console.log("Seats:", userSeats);
          console.log("Amount:", userSeats * 500);
          console.log("Max Seats:", userSeats);

          // Update UI elements (only those that still exist)
          // Note: totalSeats and totalSelections elements were removed

          console.log("=== INITIALIZE USER DETAILS COMPLETED ===");

          // Hide loading modal after successful initialization
          const loadingModal = document.getElementById("loadingModal");
          if (loadingModal) {
            loadingModal.classList.add("hidden");
          }
        } catch (error) {
          console.error("=== ERROR IN INITIALIZE USER DETAILS ===");
          console.error("Error details:", error);
          console.error("Error message:", error.message);
          console.error("Error stack:", error.stack);

          // Hide loading modal on error
          const loadingModal = document.getElementById("loadingModal");
          if (loadingModal) {
            loadingModal.classList.add("hidden");
          }

          alert("Failed to load user details. Please try again.");
          window.location.href = "initiatebooking.html";
        }
      }

      // Copy function
      const copy = async (text, btn) => {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }
          btn.classList.add(
            "ring-2",
            "ring-offset-1",
            "ring-green-400",
            "transition",
            "duration-150"
          );
          setTimeout(() => {
            btn.classList.remove("ring-2", "ring-offset-1", "ring-green-400");
          }, 1100);
        } catch (err) {
          alert("Copy failed: " + err);
        }
      };

      document.addEventListener("DOMContentLoaded", async () => {
        // Show loading modal initially
        const loadingModal = document.getElementById("loadingModal");
        loadingModal.classList.remove("hidden");

        // Get booking ID from URL for order tracking
        const params = new URLSearchParams(location.search);
        const bookingId = params.get("code")?.trim();

        // ===== ORDER TRACKING INITIALIZATION =====
        // Initialize order tracking first
        await initializeOrderTracking(bookingId);

        // Initialize user details first
        await initializeUserDetails();

        // Fetch user slot selections
        userSlotSelections = await fetchUserSlotSelections(bookingId);
        console.log("Fetched slot selections:", userSlotSelections);

        // Create dynamic order interface based on slot selections
        createOrderInterface(userSlotSelections);
        
        // Debug: Log total seats from slot selections
        const totalSeatsFromSlots = userSlotSelections.reduce((total, slot) => total + slot.seatCount, 0);
        console.log(`Total seats from slot selections: ${totalSeatsFromSlots}`);
        console.log(`User seats from data: ${userSeats}`);
        
        if (totalSeatsFromSlots !== userSeats) {
          console.warn(`Mismatch: Slot seats (${totalSeatsFromSlots}) vs User seats (${userSeats})`);
        }

        // Initialize countdown timer
        initializeCountdownTimer(bookingId);

        // Ensure loading modal is hidden after all initialization
        if (loadingModal) {
          loadingModal.classList.add("hidden");
        }

        // Dynamic interface is now created by createOrderInterface() function

        // Old functions removed - now using dynamic slot-based system



        // Toast notification function
        const showToast = (message) => {
          const toastContainer = document.getElementById("toastContainer");
          const toast = document.createElement("div");
          
          toast.className = `
            bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg 
            transform transition-all duration-300 ease-in-out
            opacity-0 translate-x-full
            flex items-center gap-2
          `;
          
          toast.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span class="font-medium">${message}</span>
          `;
          
          toastContainer.appendChild(toast);
          
          // Animate in
          setTimeout(() => {
            toast.classList.remove("opacity-0", "translate-x-full");
            toast.classList.add("opacity-100", "translate-x-0");
          }, 10);
          
          // Auto remove after 3 seconds
          setTimeout(() => {
            toast.classList.add("opacity-0", "translate-x-full");
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }, 3000);
        };

        // Copy helper function
        const copy = async (text, btn) => {
          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(text);
            } else {
              const ta = document.createElement("textarea");
              ta.value = text;
              ta.style.position = "fixed";
              ta.style.opacity = "0";
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              document.execCommand("copy");
              document.body.removeChild(ta);
            }

            btn.classList.add(
              "ring-2",
              "ring-offset-1",
              "ring-green-400",
              "transition",
              "duration-150"
            );
            setTimeout(() => {
              btn.classList.remove("ring-2", "ring-offset-1", "ring-green-400");
            }, 1100);
            
            // Show toast notification
            showToast("Booking ID Copied!");
          } catch (err) {
            alert("Copy failed: " + err);
          }
        };

        // User Details Popup Functionality
        let isPopupOpen = false;

        const togglePopup = (show) => {
          const popup = document.getElementById("userDetailsPopup");
          const btn = document.getElementById("userDetailsBtn");
          
          if (show) {
            popup.classList.remove("hidden");
            setTimeout(() => {
              popup.classList.remove("opacity-0", "scale-95");
              popup.classList.add("opacity-100", "scale-100");
            }, 10);
            btn.classList.add("bg-gray-200", "text-gray-600");
            btn.classList.remove("text-pink-600", "hover:text-pink-700", "hover:bg-pink-50");
          } else {
            popup.classList.add("opacity-0", "scale-95");
            setTimeout(() => {
              popup.classList.add("hidden");
            }, 200);
            btn.classList.remove("bg-gray-200", "text-gray-600");
            btn.classList.add("text-pink-600", "hover:text-pink-700", "hover:bg-pink-50");
          }
        };

        // Initialize user details popup
        const initializeUserDetailsPopup = () => {
          // Populate popup with user data
          document.getElementById("popupEmail").textContent = userEmail || "";
          document.getElementById("popupBookingId").textContent = userBookingId || "";
          document.getElementById("popupMobile").textContent = userMobile || "";
          document.getElementById("popupAmount").textContent = userAmount || "0";
          document.getElementById("popupSeats").textContent = userSeats || "0";
        };

        // User details button click handler
        document.getElementById("userDetailsBtn").addEventListener("click", () => {
          isPopupOpen = !isPopupOpen;
          togglePopup(isPopupOpen);
        });

        // Close popup button handler
        document.getElementById("closePopupBtn").addEventListener("click", () => {
          isPopupOpen = false;
          togglePopup(false);
        });

        // Copy booking ID popup button handler
        document.getElementById("copyBookingIdPopupBtn").addEventListener("click", () => {
          copy(userBookingId, document.getElementById("copyBookingIdPopupBtn"));
        });

        // Close popup when clicking outside
        document.addEventListener("click", (e) => {
          const popup = document.getElementById("userDetailsPopup");
          const btn = document.getElementById("userDetailsBtn");
          
          if (!popup.contains(e.target) && !btn.contains(e.target)) {
            isPopupOpen = false;
            togglePopup(false);
          }
        });

        // Initialize user details popup when page loads
        initializeUserDetailsPopup();

        // Continue button handler
        document
          .getElementById("continueBtn")
          .addEventListener("click", async () => {
            // Check if all slots have complete selections
            let totalFood = 0;
            let totalBeverages = 0;
            
            if (window.slotQuantities) {
              Object.values(window.slotQuantities).forEach(quantities => {
                totalFood += quantities.omurice + quantities.curryRice;
                totalBeverages += quantities.icedTea + quantities.plainWater;
              });
            }
            
            if (totalFood === userSeats && totalBeverages === userSeats) {
              // Show loading modal
              const loadingModal = document.getElementById("loadingModal");
              loadingModal.classList.remove("hidden");

              // Update loading modal text for food submission
              const loadingTitle = loadingModal.querySelector("h2");
              const loadingText = loadingModal.querySelector("p");
              loadingTitle.textContent = "Submitting your food choices…";
              loadingText.textContent =
                "Please wait while we save your selections.";

              try {
                // Submit orders for each slot
                await submitOrdersForAllSlots();
                console.log("All food choices submitted successfully");

                // Hide loading modal
                loadingModal.classList.add("hidden");

                // Redirect to payment page
                window.location.href = `ordersummary.html?code=${userBookingId}`;
              } catch (error) {
                console.error("Error submitting food choices:", error);

                // Hide loading modal
                loadingModal.classList.add("hidden");

                alert(
                  "There was an issue saving your food choices. Please try again."
                );
              }
            }
          });

        // Item Info Modal Functions
        window.showItemInfo = function(itemId, itemName, description, imageSrc) {
          const modal = document.getElementById("itemInfoModal");
          const image = document.getElementById("itemInfoImage");
          const name = document.getElementById("itemInfoName");
          const desc = document.getElementById("itemInfoDescription");
          
          // Set modal content
          image.src = imageSrc;
          name.textContent = itemName;
          desc.textContent = description;
          
          // Show modal
          modal.classList.remove("hidden");
        };

        window.closeItemInfoModal = function() {
          const modal = document.getElementById("itemInfoModal");
          modal.classList.add("hidden");
        };

        // Close modal when clicking close button
        document.getElementById("closeItemInfoBtn").addEventListener("click", window.closeItemInfoModal);

        // Close modal when clicking backdrop
        document.getElementById("itemInfoModal").addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            window.closeItemInfoModal();
          }
        });
      });
    </script>

    <!-- Item Info Modal -->
    <div id="itemInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-lg font-semibold text-gray-800" id="itemInfoName"></h3>
          <button id="closeItemInfoBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="text-center mb-4">
          <img id="itemInfoImage" src="" alt="Item" class="w-32 h-32 object-cover rounded-lg mx-auto mb-3">
        </div>
        <p class="text-gray-600 text-sm" id="itemInfoDescription"></p>
      </div>
    </div>
  </body>
</html>
