<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Slot Availability</title>
  </head>
  <body>
    <h1>Slot Availability Checker</h1>
    <button onclick="checkSlotAvailability()">Check Availability</button>
    <pre id="output"></pre>

    <script>
      async function checkSlotAvailability() {
        const raceSheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const slotAvailabilitySheet = "Availability Helper";
        const seatQuery = encodeURIComponent("SELECT A, B"); // A = Slot, B = Free Slots
        const seatUrl = `https://docs.google.com/spreadsheets/d/${raceSheetID}/gviz/tq?sheet=${encodeURIComponent(
          slotAvailabilitySheet
        )}&tq=${seatQuery}`;

        const outputEl = document.getElementById("output");
        outputEl.textContent = "Fetching data...\n";

        try {
          const seatResponse = await fetch(seatUrl);
          const seatData = await seatResponse.text();
          const seatJson = JSON.parse(seatData.substring(47).slice(0, -2));
          const seatRows = seatJson.table.rows;

          const freeSlotsMap = {}; // slotName (lowercase) -> Free Slots
          seatRows.forEach((row) => {
            const slotName = row.c[0]?.v
              ? String(row.c[0].v).trim()
              : "[missing]";
            const freeCount = row.c[1]?.v ? parseInt(row.c[1].v) : 0;
            freeSlotsMap[slotName.toLowerCase()] = freeCount;
            outputEl.textContent += `${slotName} : Free Slots = ${freeCount}\n`;
          });

          outputEl.textContent +=
            "\nParsed Data:\n" + JSON.stringify(freeSlotsMap, null, 2);
        } catch (err) {
          outputEl.textContent += `\nError fetching or parsing data: ${err}`;
          console.error(err);
        }
      }
    </script>
  </body>
</html>
