<!-- payment.html – Redesigned with modern aesthetics -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cafe Kyaa! – Payment</title>

    <!-- Quicksand + Tailwind -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --sat: env(safe-area-inset-top, 0);
        --sab: env(safe-area-inset-bottom, 0);
      }
      html {
        --vh: 1vh;
      }
      body {
        font-family: "Quicksand", sans-serif;
        min-height: calc(var(--vh) * 100);
        padding: var(--sat) 0 var(--sab);
        background: linear-gradient(
          -60deg,
          #fff1f2 0%,
          #ffe4e6 25%,
          #fce7f3 50%,
          #ffe5f8 75%,
          #fff1f2 100%
        );
        background-size: 400% 400%;
        animation: grad 18s ease infinite;
      }
      @keyframes grad {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 5px rgba(236, 72, 153, 0.4);
        }
        50% {
          box-shadow: 0 0 20px rgba(236, 72, 153, 0.8);
        }
        100% {
          box-shadow: 0 0 5px rgba(236, 72, 153, 0.4);
        }
      }

      .glow-animation {
        animation: glow 2s ease-in-out infinite;
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .gradient-text {
        background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="text-gray-800">
    <!-- header -->
    <header
      class="fixed inset-x-0 top-0 bg-white/60 backdrop-blur-md shadow-sm z-40"
    >
      <div class="flex items-center h-14 px-4">
        <a href="index.html" class="flex items-center hover:opacity-80">
          <img src="logo.png" class="h-10 w-10 rounded-full" alt="logo" />
          <h1
            class="ml-2 text-lg font-bold bg-gradient-to-r from-pink-600 to-rose-500 bg-clip-text text-transparent uppercase tracking-wide"
          >
            Cafe Kyaa!
          </h1>
        </a>
        <span
          class="ml-auto text-xs font-medium text-rose-600 whitespace-nowrap"
        >
          Anime India 2025 · Mumbai
        </span>
      </div>
    </header>

    <!-- main -->
    <main class="pt-20 flex flex-col items-center p-4">
      <div class="w-full max-w-4xl space-y-6">
        <!-- Countdown Timer -->
        <div id="countdownContainer" class="fade-in sticky top-20 z-30">
          <!-- Full-width frosted glass backdrop -->
          <div
            class="absolute inset-x-0 -top-6 -bottom-6 -mx-4 pointer-events-none"
            style="
              background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0.95) 20%,
                rgba(255, 255, 255, 0.3) 40%,
                rgba(255, 255, 255, 0) 80%
              );
            "
          ></div>

          <div
            class="bg-gradient-to-r from-orange-50/90 to-red-50/90 backdrop-blur-md border border-orange-200/80 rounded-xl p-4 shadow-xl relative overflow-hidden"
          >
            <!-- Decorative blur elements -->
            <div
              class="absolute -top-8 -right-8 w-16 h-16 bg-gradient-to-br from-orange-200 to-red-200 rounded-full opacity-30 blur-xl"
            ></div>
            <div
              class="absolute -bottom-8 -left-8 w-12 h-12 bg-gradient-to-br from-red-200 to-orange-200 rounded-full opacity-30 blur-xl"
            ></div>

            <div class="relative z-10 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-md"
                >
                  <svg
                    class="w-5 h-5 text-white"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-800">
                    Complete your booking
                  </h3>
                  <p class="text-xs text-gray-600">before time runs out</p>
                </div>
              </div>
              <div class="text-right">
                <div
                  id="countdownTimer"
                  class="text-2xl font-bold text-orange-600 font-mono"
                >
                  Loading...
                </div>
                <div class="text-xs text-gray-500">minutes:seconds</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Order Summary Card -->
        <div class="fade-in">
          <div
            class="relative isolate overflow-hidden rounded-3xl bg-gradient-to-br from-white to-pink-50 p-6 shadow-2xl border border-pink-100"
          >
            <!-- Decorative elements -->
            <div
              class="absolute -top-20 -right-20 w-40 h-40 bg-gradient-to-br from-pink-200 to-rose-200 rounded-full opacity-20 blur-3xl"
            ></div>
            <div
              class="absolute -bottom-20 -left-20 w-40 h-40 bg-gradient-to-br from-rose-200 to-pink-200 rounded-full opacity-20 blur-3xl"
            ></div>

            <div class="relative z-10">
              <!-- Header -->
              <div
                class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-500 rounded-xl flex items-center justify-center shadow-lg"
                  >
                    <svg
                      class="w-6 h-6 text-white"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M2.25 9.75A2.25 2.25 0 0 1 4.5 7.5h15a2.25 2.25 0 0 1 2.25 2.25v1.08a3.219 3.219 0 0 0 0 6.42v1.08A2.25 2.25 0 0 1 19.5 21h-15A2.25 2.25 0 0 1 2.25 18.75v-1.08a3.219 3.219 0 0 0 0-6.42V9.75zM12 9a.75.75 0 0 0-.75.75v.75h1.5V9.75A.75.75 0 0 0 12 9zm-.75 3h1.5v1.5h-1.5V12zm1.5 4.5h-1.5V18a.75.75 0 0 0 1.5 0v-1.5z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-1">
                      Reserve Your Slot!
                    </h2>
                    <p class="text-gray-600 font-medium">Cafe Kyaa! Tickets</p>
                  </div>
                </div>

                <!-- Price Summary -->
                <div class="text-right">
                  <div class="text-2xl font-bold gradient-text mb-1">
                    ₹<span id="amtTitle">0</span>
                  </div>
                  <div class="text-gray-600">
                    <span id="seatCount">0</span> seat(s) @ ₹500 each
                  </div>
                </div>
              </div>

              <!-- Contact Details -->
              <div
                class="bg-white rounded-xl p-4 shadow-lg border border-gray-100"
              >
                <h3
                  class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2"
                >
                  <svg
                    class="w-5 h-5 text-pink-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                    ></path>
                    <path
                      d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                    ></path>
                  </svg>
                  Your Details
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"
                  >
                    <div
                      class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-pink-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                        ></path>
                        <path
                          d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">Email</div>
                      <div
                        id="emailVal"
                        class="text-sm font-semibold text-gray-800 break-words max-w-[40vw]"
                      ></div>
                    </div>
                  </div>

                  <div
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"
                  >
                    <div
                      class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-pink-600"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">
                        Mobile
                      </div>
                      <div
                        id="mobileVal"
                        class="text-sm font-semibold text-gray-800"
                      ></div>
                    </div>
                  </div>
                </div>

                <!-- Booking ID Section -->
                <div
                  class="flex items-center justify-between p-4 bg-gradient-to-r from-pink-50 to-rose-50 rounded-xl border border-pink-200"
                >
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-5 h-5 text-white"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs text-gray-500 font-medium">
                        Booking ID
                      </div>
                      <div
                        id="bookingIdValSummary"
                        class="text-sm font-bold text-gray-800"
                      ></div>
                    </div>
                  </div>
                  <button
                    id="copyBookingIdSummaryBtn"
                    class="bg-pink-500 hover:bg-pink-600 text-white px-2 py-1 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2 shadow-md hover:shadow-lg"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 002 2z"
                      ></path>
                    </svg>
                    Copy
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Section -->
        <div class="fade-in" style="animation-delay: 0.2s">
          <div
            class="bg-white rounded-3xl shadow-2xl p-6 border border-pink-100"
          >
            <!-- QR Code Section -->
            <div class="flex flex-col items-center">
              <div class="text-center mb-4">
                <div class="text-xl font-bold gradient-text mb-2 hidden">
                  ₹<span id="amountDisplay">0</span>
                </div>
                <!-- <p class="text-gray-600 font-medium">Scan QR Code to Pay</p> -->
              </div>

              <!-- Disclaimer -->
              <div
                class="relative overflow-hidden bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 rounded-2xl p-6 mb-6 border border-amber-200 shadow-lg"
              >
                <!-- Decorative background elements -->
                <div
                  class="absolute -top-4 -right-4 w-16 h-16 bg-gradient-to-br from-amber-200 to-orange-200 rounded-full opacity-30 blur-xl"
                ></div>
                <div
                  class="absolute -bottom-4 -left-4 w-12 h-12 bg-gradient-to-br from-orange-200 to-red-200 rounded-full opacity-30 blur-xl"
                ></div>

                <div class="relative z-10">
                  <!-- Header with icon -->
                  <div class="flex items-center gap-3 mb-4">
                    <div
                      class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center shadow-md"
                    >
                      <svg
                        class="w-5 h-5 text-white"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <h5
                        class="text-lg font-bold bg-gradient-to-r from-amber-700 to-orange-700 bg-clip-text text-transparent"
                      >
                        Important Notice
                      </h5>
                      <p class="text-xs text-amber-600 font-medium">
                        Please read carefully before proceeding
                      </p>
                    </div>
                  </div>

                  <!-- Main message -->
                  <div
                    class="bg-white/80 backdrop-blur-sm rounded-xl p-4 mb-4 border border-amber-100 shadow-sm"
                  >
                    <p class="text-sm text-gray-700 leading-relaxed">
                      <span class="font-semibold text-amber-700"
                        >Please mention the booking ID in your UPI payment
                        comment.</span
                      >
                      This helps us process your booking faster and ensures
                      accurate tracking of your payment!
                    </p>
                  </div>

                  <!-- Checkbox section -->
                  <div
                    class="bg-white/90 backdrop-blur-sm rounded-xl p-4 border border-amber-100 shadow-sm"
                  >
                    <label class="flex items-start gap-3 cursor-pointer group">
                      <div class="relative">
                        <input
                          type="checkbox"
                          id="qrCheckbox"
                          class="mt-1 h-5 w-5 text-amber-600 border-amber-300 rounded-lg focus:ring-amber-500 focus:ring-2 focus:ring-offset-2 transition-all duration-200"
                        />
                        <div
                          class="absolute inset-0 rounded-lg bg-gradient-to-br from-amber-500/20 to-orange-500/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none"
                        ></div>
                      </div>
                      <div class="flex-1">
                        <div class="font-semibold text-gray-800 text-sm mb-1">
                          I understand and will include the booking ID in my
                          payment
                        </div>
                        <div class="text-xs text-gray-500 leading-relaxed">
                          This helps us process your booking faster and more
                          accurately.
                          <span class="font-medium text-amber-600"
                            >Your cooperation is greatly appreciated!</span
                          >
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
              <!-- UPI Payment Methods -->
              <div
                class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-6 border border-blue-200"
              >
                <h4
                  class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2"
                >
                  <svg
                    class="w-5 h-5 text-blue-600"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Scan and Pay via any UPI App
                </h4>
                <p class="text-xs text-gray-600 mb-4">
                  You need to open your UPI app of choice, and scan the QR code
                  manually to pay.
                </p>
                <p class="text-xs text-gray-600 mb-4">
                  You can either take a screenshot, or use the download QR
                  button.
                </p>
              </div>
              <!-- QR Code -->
              <div class="flex justify-center mb-4">
                <div class="relative">
                  <img
                    id="qrImage"
                    alt="UPI QR Code"
                    class="w-56 h-56 rounded-xl border-4 shadow-lg"
                  />
                  <div
                    class="absolute inset-0 rounded-xl pointer-events-none"
                  ></div>
                </div>
              </div>

              <!-- Disclaimer -->
              <div
                class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200"
              >
                <p class="text-sm text-blue-800 leading-relaxed">
                  <span class="font-semibold">💡 Tip:</span> Use the button
                  below to copy your booking ID onto your clipboard, and
                  download your QR. Now, open your UPI app, upload this QR to
                  scan, then paste your booking ID from clipboard onto the UPI
                  note.
                </p>
              </div>

              <!-- Combined Copy Booking ID & Download QR Button -->
              <button
                id="copyAndDownloadBtn"
                class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white py-3 px-4 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-2"
                type="button"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 002 2z"
                  />
                </svg>
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                <span>Copy Booking ID & Download QR</span>
              </button>

              <!-- Help Button -->
              <button
                onclick="openModal()"
                id="havingtroublebutton"
                class="mt-4 bg-orange-50 hover:bg-orange-100 text-orange-700 hover:text-orange-800 font-medium px-4 py-2 rounded-lg border border-orange-200 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Having trouble with QR Payment?
              </button>
              <!-- UPI Transaction Confirmation -->
              <div class="mt-6 w-full max-w-md">
                <div
                  class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200 shadow-sm"
                >
                  <div class="flex items-center gap-2 mb-3">
                    <div
                      class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center"
                    >
                      <svg
                        class="w-3 h-3 text-white"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </div>
                    <h4 class="text-sm font-semibold text-gray-800">
                      Confirm Your Payment
                    </h4>
                  </div>

                  <div class="space-y-3">
                    <!-- UPI Transaction Number -->
                    <div>
                      <label
                        for="upiTransactionNumber"
                        class="block text-xs font-medium text-gray-700 mb-1"
                      >
                        UPI Transaction Number
                      </label>
                      <input
                        type="text"
                        id="upiTransactionNumber"
                        placeholder="Enter your UPI transaction number"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                      />
                    </div>

                    <!-- Confirm UPI Transaction Number -->
                    <div>
                      <label
                        for="confirmUpiTransactionNumber"
                        class="block text-xs font-medium text-gray-700 mb-1"
                      >
                        Confirm UPI Transaction Number
                      </label>
                      <input
                        type="text"
                        id="confirmUpiTransactionNumber"
                        placeholder="Re-enter your UPI transaction number"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                      />
                    </div>

                    <!-- Validation Message -->
                    <div
                      id="transactionValidationMessage"
                      class="text-xs hidden"
                    >
                      <div
                        id="transactionValidationSuccess"
                        class="text-green-600 font-medium hidden"
                      >
                        ✓ Transaction numbers match!
                      </div>
                      <div
                        id="transactionValidationError"
                        class="text-red-600 font-medium hidden"
                      >
                        ✗ Transaction numbers do not match
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Continue Button -->
              <button
                id="paidButton"
                disabled
                class="mt-4 w-full max-w-md bg-gradient-to-r from-gray-400 to-gray-500 text-white py-3 px-6 rounded-lg font-bold text-base shadow-lg transition-all duration-200 flex items-center justify-center gap-2 cursor-not-allowed"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                I've Paid – Complete my Booking!
              </button>
              <p> </p>
              <!-- Information Cards -->
              <div class="fade-in" style="animation-delay: 0.4s">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Note Card -->
                  <div
                    class="bg-white rounded-xl p-4 shadow-lg border border-blue-100"
                  >
                    <div class="flex items-start gap-3">
                      <div
                        class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"
                      >
                        <svg
                          class="w-5 h-5 text-blue-600"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800 mb-1">
                          Important Note
                        </h4>
                        <p class="text-sm text-gray-600 break-words">
                          In case of any issues or queries, please raise a
                          ticket via
                          <a
                            href="https://forms.gle/e5BpBj6z9hTnk1Kt7"
                            target="_blank"
                            class="text-blue-600 underline hover:text-blue-800 font-medium"
                            >this form</a
                          >. We will try to get back to you as soon as possible.
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Refund Card -->
                  <div
                    class="bg-white rounded-xl p-4 shadow-lg border border-green-100"
                  >
                    <div class="flex items-start gap-3">
                      <div
                        class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0"
                      >
                        <svg
                          class="w-5 h-5 text-green-600"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800 mb-1">
                          Refund Policy
                        </h4>
                        <p class="text-sm text-gray-600 leading-relaxed">
                          In case your booking fails but your payment is
                          completed, please raise a ticket at the link given
                          above and we will issue a refund.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal Overlay -->
    <div
      id="infoModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 px-4"
    >
      <!-- Modal Content -->
      <div
        class="bg-white border border-red-200 rounded-xl w-full max-w-md p-5 shadow-lg text-sm text-red-700"
      >
        <!-- Close Button -->
        <div class="flex justify-end">
          <button
            onclick="closeModal()"
            class="text-red-500 hover:text-red-700 text-lg font-bold"
          >
            &times;
          </button>
        </div>

        <!-- Modal Title -->
        <div class="font-semibold text-red-800 mb-3 text-base">
          Trouble with QR Code?
        </div>

        <!-- Modal Message -->
        <p class="mb-3">
          Sometimes, apps may not support auto-generated QR codes, which can
          cause payments to fail or prevent you from adding a note to your
          transaction.
        </p>
        <p class="mb-4">
          If that happens, please make a
          <strong>manual payment</strong> to ensure your Booking ID is included.
        </p>

        <!-- CTA Buttons -->
        <div class="flex flex-col gap-2">
          <button
            id="manualPayBtn"
            type="button"
            onclick="window.open('YOUR_MANUAL_PAYMENT_LINK', '_blank');"
            class="block w-full text-center bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition"
          >
            Manual Payment Instructions
          </button>

          <a
            href="https://forms.gle/e5BpBj6z9hTnk1Kt7"
            target="_blank"
            class="block text-center border border-red-400 text-red-700 px-4 py-2 rounded-lg font-medium hover:bg-red-50 transition"
          >
            Contact Support
          </a>
        </div>
      </div>
    </div>

    <!-- Modal Script -->
    <script>
      function openModal() {
        document.getElementById("infoModal").classList.remove("hidden");
      }
      function closeModal() {
        document.getElementById("infoModal").classList.add("hidden");
      }

      function openUPIApp(appType) {
        let appUrl = "";
        let appName = "";

        switch (appType) {
          case "gpay":
            appUrl = "googlepay://";
            appName = "Google Pay";
            break;
          case "paytm":
            appUrl = "paytmmp://";
            appName = "Paytm";
            break;
          case "phonepe":
            appUrl = "phonepe://";
            appName = "PhonePe";
            break;
          case "amazonpay":
            appUrl = "amazonpay://";
            appName = "Amazon Pay";
            break;
          case "bhim":
            appUrl = "bhim://";
            appName = "BHIM";
            break;
          case "upi":
            appUrl = "upi://";
            appName = "UPI";
            break;
          default:
            showError("Invalid UPI app selected");
            return;
        }

        // Check if user is on mobile
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );

        if (!isMobile) {
          showError(
            `${appName} can only be opened on mobile devices. Please use the QR code to scan and pay.`
          );
          return;
        }

        // Try to open the app
        try {
          window.location.href = appUrl;

          // Set a timeout to check if the app opened successfully
          setTimeout(() => {
            // If we're still on the same page after 2 seconds, the app probably didn't open
            if (document.hidden || document.webkitHidden) {
              // App opened successfully
              console.log(`${appName} opened successfully`);
            } else {
              // App didn't open, show fallback
              showError(
                `${appName} is not installed on your device. Please install the app or use the QR code to scan and pay.`
              );
            }
          }, 2000);
        } catch (error) {
          showError(
            `Failed to open ${appName}. Please use the QR code to scan and pay.`
          );
        }
      }

      function showError(message) {
        // Create error modal
        const errorModal = document.createElement("div");
        errorModal.className =
          "fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50";
        errorModal.innerHTML = `
          <div class="bg-white rounded-xl p-6 w-80 max-w-sm shadow-xl relative">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-800">App Not Available</h3>
            </div>
            <p class="text-gray-600 mb-6">${message}</p>
            <button onclick="this.closest('.fixed').remove()" class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200">
              OK
            </button>
          </div>
        `;
        document.body.appendChild(errorModal);
      }
    </script>

    <!-- manual payment modal -->
    <div
      id="manualModal"
      class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-xl p-6 w-80 space-y-4 shadow-xl relative text-xs"
      >
        <h4 class="text-base font-semibold text-gray-800 text-center">
          Manual UPI Payment Details
        </h4>
        <h5 class="text-sm font-semibold text-gray-800 text-center">
          Please pay manually according to the following details:
        </h5>
        <div class="text-sm text-gray-700 space-y-2">
          <details class="p-2 bg-gray-50 rounded-lg border border-gray-200">
            <summary class="cursor-pointer font-medium text-pink-700">
              GPay Instructions
            </summary>
            <p class="mt-1 pl-4">
              Tap "Pay Anyone", enter the UPI ID given below, press Continue,
              then Pay. Enter the amount and Booking ID in the note before
              proceeding.
            </p>
          </details>

          <details class="p-2 bg-gray-50 rounded-lg border border-gray-200">
            <summary class="cursor-pointer font-medium text-pink-700">
              Paytm Instructions
            </summary>
            <p class="mt-1 pl-4">
              Tap "To Bank A/c" →
              <strong>"Enter UPI ID/Mobile Number"</strong>, enter the UPI
              address, tap Pay, and enter the amount and Booking ID in the note
              before paying.
            </p>
          </details>

          <details class="p-2 bg-gray-50 rounded-lg border border-gray-200">
            <summary class="cursor-pointer font-medium text-pink-700">
              PhonePe Instructions
            </summary>
            <p class="mt-1 pl-4">
              Tap "To Bank & Self A/c" →
              <strong>"To Any UPI App"</strong>, click
              <strong>+ UPI ID</strong>, enter the UPI address, then proceed.
              Add the amount and Booking ID in the note before paying. The note
              icon may be tricky to find here, it's a paper icon in the text
              box, towards the left of the pay button.
            </p>
          </details>
        </div>

        <!-- rows -->
        <div class="space-y-2">
          <div
            class="grid grid-cols-[auto,1fr,auto] items-center bg-gray-50 rounded px-2 py-1 gap-2"
          >
            <span class="font-medium">Amount</span>
            <span id="manualAmountText" class="text-center font-mono"></span>
            <button
              id="copyAmtBtn"
              type="button"
              class="justify-self-end bg-pink-100 text-pink-700 text-xs font-medium px-2 py-0.5 rounded"
            >
              Copy
            </button>
          </div>
          <div
            class="grid grid-cols-[auto,1fr,auto] items-center bg-gray-50 rounded px-2 py-1 gap-2"
          >
            <span class="font-medium">To</span>
            <span id="upiIdVal" class="text-center font-mono break-all"
              >8758610922@ptsbi</span
            >
            <button
              id="copyUpiBtn"
              type="button"
              class="justify-self-end bg-pink-100 text-pink-700 text-xs font-medium px-2 py-0.5 rounded"
            >
              Copy
            </button>
          </div>
          <div
            class="grid grid-cols-[auto,1fr,auto] items-center bg-gray-50 rounded px-2 py-1 gap-2"
          >
            <span class="font-medium">Note</span>
            <code
              id="bookingIdTextModal"
              class="text-center font-mono break-all"
            ></code>
            <button
              id="copyBookingIdModalBtn"
              type="button"
              class="justify-self-end bg-pink-100 text-pink-700 text-xs font-medium px-2 py-0.5 rounded"
            >
              Copy
            </button>
          </div>
        </div>

        <button
          id="closeModal"
          type="button"
          class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl"
        >
          &times;
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- all your current script code goes inside here ---

        /* ---------- viewport helper ---------- */
        const setVH = () =>
          document.documentElement.style.setProperty(
            "--vh",
            `${innerHeight * 0.01}px`
          );
        setVH();
        addEventListener("resize", setVH);

        /* ---------- constants ---------- */
        const HEADER_OFFSET = 60;
        const UPI_ID = "8758610922@ptsbi",
          PAYEE = "Kanishk Kumar"; // appears in some UPI apps

        /* ---------- elements ---------- */
        const seatCount = document.getElementById("seatCount");
        const amtTitle = document.getElementById("amtTitle");
        const amtDisp = document.getElementById("amountDisplay");
        const manualAmt = document.getElementById("manualAmountText");

        const emailVal = document.getElementById("emailVal");
        const mobileVal = document.getElementById("mobileVal");
        const bookingIdTextModal =
          document.getElementById("bookingIdTextModal");

        const qrImg = document.getElementById("qrImage");
        const copyAndDownloadBtn =
          document.getElementById("copyAndDownloadBtn");

        const manualPayBtn = document.getElementById("manualPayBtn");
        const manualModal = document.getElementById("manualModal");
        const closeModal = document.getElementById("closeModal");

        const copyAmtBtn = document.getElementById("copyAmtBtn");
        const copyUpiBtn = document.getElementById("copyUpiBtn");
        const copyBookingIdModalBtn = document.getElementById(
          "copyBookingIdModalBtn"
        );

        const paidBtn = document.getElementById("paidButton");
        const qrCheckbox = document.getElementById("qrCheckbox");
        const havingtroublebutton = document.getElementById(
          "havingtroublebutton"
        );

        /* ---------- read query‑params ---------- */
        const params = new URLSearchParams(location.search);
        const code = params.get("code")?.trim() || "";

        // Debug logging
        console.log("=== URL PARAMETERS DEBUG ===");
        console.log("Raw URL:", window.location.href);
        console.log("URL search params:", location.search);
        console.log("Code:", code, "| Valid:", !!code);

        if (!code) {
          console.error("=== REDIRECTING DUE TO MISSING BOOKING ID ===");
          alert("Missing booking ID. Redirecting to initiate payment page...");
          setTimeout(() => {
            location.replace("initiatebooking.html");
          }, 2000);
          return;
        }

        // ===== USER DETAILS SHEET CONFIGURATION =====
        const userDetailsSheetID =
          "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
        const userDetailsSheetName = "Raw Data";

        // ===== FETCH USER DETAILS BY BOOKING ID =====
        /**
         * Fetches user details from the Google Sheet using booking ID
         * @param {string} bookingId - The booking ID to search for
         * @returns {Promise<Object|null>} - User details object or null if not found
         */
        const fetchUserDetailsByBookingId = async (bookingId) => {
          try {
            console.log("=== FETCH USER DETAILS START ===");
            console.log(`Input booking ID: "${bookingId}"`);
            console.log(`Sheet ID: ${userDetailsSheetID}`);
            console.log(`Sheet Name: ${userDetailsSheetName}`);

            // Fetch the entire sheet data
            const userUrl = `https://docs.google.com/spreadsheets/d/${userDetailsSheetID}/gviz/tq?sheet=${encodeURIComponent(
              userDetailsSheetName
            )}&tq=${encodeURIComponent("SELECT *")}`;

            console.log(`Query URL: ${userUrl}`);

            console.log("Making fetch request...");
            const response = await fetch(userUrl);
            console.log(`Response status: ${response.status}`);
            console.log(`Response ok: ${response.ok}`);

            const data = await response.text();
            console.log(`Response data length: ${data.length}`);
            console.log(
              `Raw response (first 500 chars): ${data.substring(0, 500)}...`
            );

            if (!response.ok) {
              console.error(
                `HTTP Error: ${response.status} ${response.statusText}`
              );
              return null;
            }

            console.log("Parsing JSON response...");
            const json = JSON.parse(data.substring(47).slice(0, -2));
            console.log("JSON parsed successfully");
            console.log(`JSON structure:`, Object.keys(json));

            const rows = json.table.rows;
            console.log(`Total rows in sheet: ${rows.length}`);

            if (rows.length === 0) {
              console.warn("No rows found in sheet");
              return null;
            }

            console.log(`Searching for booking ID: "${bookingId}"`);
            console.log("First few rows for debugging:");
            for (let i = 0; i < Math.min(3, rows.length); i++) {
              const row = rows[i];
              console.log(
                `Row ${i}:`,
                row.c
                  ?.map((cell, idx) => `col${idx}="${cell?.v || ""}"`)
                  .join(", ")
              );
            }

            // Search through all rows for the matching booking ID
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              const hashValue = row.c[4]?.v || ""; // E column (Hash/Booking ID) - 5th column (0-indexed as 4)
              const hashValueStr = String(hashValue); // Convert to string to handle both number and string types

              console.log(
                `Row ${i}: Hash value = "${hashValueStr}", looking for "${bookingId}"`
              );
              console.log(
                `Row ${i} comparison: "${hashValueStr}" === "${bookingId}" = ${
                  hashValueStr === bookingId
                }`
              );

              // Detailed character analysis
              console.log(
                `Row ${i} - hashValue type: ${typeof hashValue}, length: ${
                  hashValueStr.length
                }`
              );
              console.log(
                `Row ${i} - bookingId type: ${typeof bookingId}, length: ${
                  bookingId.length
                }`
              );
              console.log(
                `Row ${i} - hashValue char codes: ${Array.from(hashValueStr)
                  .map((c) => c.charCodeAt(0))
                  .join(", ")}`
              );
              console.log(
                `Row ${i} - bookingId char codes: ${Array.from(bookingId)
                  .map((c) => c.charCodeAt(0))
                  .join(", ")}`
              );
              console.log(
                `Row ${i} - hashValue trimmed: "${hashValueStr.trim()}"`
              );
              console.log(
                `Row ${i} - bookingId trimmed: "${bookingId.trim()}"`
              );
              console.log(
                `Row ${i} - trimmed comparison: "${hashValueStr.trim()}" === "${bookingId.trim()}" = ${
                  hashValueStr.trim() === bookingId.trim()
                }`
              );

              if (
                hashValueStr === bookingId ||
                hashValueStr.trim() === bookingId.trim()
              ) {
                console.log(
                  `Found matching booking ID in row ${i} (${
                    hashValueStr === bookingId ? "exact match" : "trimmed match"
                  })`
                );

                const userDetails = {
                  email: row.c[1]?.v || "", // B column (Email) - 2nd column (0-indexed as 1)
                  seats: parseInt(row.c[2]?.v) || 0, // C column (Seats) - 3rd column (0-indexed as 2)
                  mobile: row.c[3]?.v || "", // D column (Mobile Number) - 4th column (0-indexed as 3)
                  hash: hashValue, // E column (Hash/Booking ID) - 5th column (0-indexed as 4)
                };

                console.log(`User details found:`, userDetails);
                console.log("=== FETCH USER DETAILS SUCCESS ===");
                return userDetails;
              }
            }

            console.warn(
              `No user details found for booking ID: "${bookingId}"`
            );
            console.log("All rows checked, no match found");
            console.log("=== FETCH USER DETAILS FAILED ===");
            return null;
          } catch (error) {
            console.error("=== ERROR IN FETCH USER DETAILS ===");
            console.error("Error details:", error);
            console.error("Error message:", error.message);
            console.error("Error stack:", error.stack);
            return null;
          }
        };

        // ===== INITIALIZE USER DETAILS =====
        // Countdown timer functionality
        let countdownInterval;
        let timeoutOccurred = false;

        const initializeCountdownTimer = async (bookingId) => {
          try {
            console.log("=== INITIALIZING COUNTDOWN TIMER ===");
            console.log("Booking ID:", bookingId);

            // Fetch data from Slot Blocking Sources sheet
            const sheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
            const sheetName = "Slot Blocking Sources";
            const query = encodeURIComponent("SELECT *");
            const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(
              sheetName
            )}&tq=${query}`;

            console.log("Fetching data from:", url);

            const response = await fetch(url);
            const data = await response.text();
            const json = JSON.parse(data.substring(47).slice(0, -2));
            const rows = json.table.rows;

            console.log("Total rows fetched:", rows.length);

            // Find the last occurrence of the booking ID with status "Processing"
            let lastProcessingEntry = null;
            for (let i = rows.length - 1; i >= 0; i--) {
              const row = rows[i];
              const rowBookingId = row.c[3]?.v ? String(row.c[3].v).trim() : "";
              const status = row.c[4]?.v ? String(row.c[4].v).trim() : "";

              if (rowBookingId === bookingId && status === "Processing") {
                lastProcessingEntry = row;
                break;
              }
            }

            if (!lastProcessingEntry) {
              console.error(
                "No Processing entry found for booking ID:",
                bookingId
              );
              document.getElementById("countdownTimer").textContent = "N/A";
              return;
            }

            // Extract timestamp from the first column
            const timestampStr = lastProcessingEntry.c[0]?.v;
            if (!timestampStr) {
              console.error("No timestamp found in Processing entry");
              document.getElementById("countdownTimer").textContent = "N/A";
              return;
            }

            console.log("Found Processing entry timestamp:", timestampStr);

            // Parse the timestamp from Google Sheets format
            let timestamp;
            if (
              typeof timestampStr === "string" &&
              timestampStr.startsWith("Date(")
            ) {
              // Parse Google Sheets Date format: "Date(2025,7,1,10,19,16)"
              const match = timestampStr.match(
                /Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/
              );
              if (match) {
                const [, year, month, day, hour, minute, second] = match;
                // Note: Google Sheets months are 1-indexed, JavaScript is 0-indexed
                // But it seems the month values are already 0-indexed in the data
                timestamp = new Date(
                  parseInt(year),
                  parseInt(month),
                  parseInt(day),
                  parseInt(hour),
                  parseInt(minute),
                  parseInt(second)
                );
              } else {
                console.error(
                  "Could not parse timestamp format:",
                  timestampStr
                );
                document.getElementById("countdownTimer").textContent = "N/A";
                return;
              }
            } else {
              // Try direct Date constructor as fallback
              timestamp = new Date(timestampStr);
            }

            if (isNaN(timestamp.getTime())) {
              console.error("Invalid timestamp after parsing:", timestampStr);
              document.getElementById("countdownTimer").textContent = "N/A";
              return;
            }

            const tPlus10 = new Date(timestamp.getTime() + 10 * 60 * 1000); // T + 10 minutes

            console.log("Original timestamp:", timestamp);
            console.log("T+10 deadline:", tPlus10);

            // Start countdown
            updateCountdown(tPlus10);
          } catch (error) {
            console.error("Error initializing countdown timer:", error);
            document.getElementById("countdownTimer").textContent = "Error";
          }
        };

        const updateCountdown = (deadline) => {
          const updateTimer = () => {
            if (timeoutOccurred) return;

            const now = new Date();
            const timeLeft = deadline - now;

            if (timeLeft <= 0) {
              // Timeout occurred
              timeoutOccurred = true;
              clearInterval(countdownInterval);

              console.log("=== TIMEOUT OCCURRED ===");
              console.log("Current time:", now);
              console.log("Deadline:", deadline);
              console.log("Time left:", timeLeft);

              // Show timeout message
              document.getElementById("countdownTimer").textContent = "00:00";
              document
                .getElementById("countdownTimer")
                .classList.add("text-red-600");

              // Notify user and redirect
              alert(
                "Payment timeout occurred. Your booking has expired. You will be redirected to the booking failed page."
              );
              window.location.href = "bookingfailed.html";
              return;
            }

            // Calculate minutes and seconds
            const minutes = Math.floor(timeLeft / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            // Check for valid numbers
            if (isNaN(minutes) || isNaN(seconds)) {
              console.error("Invalid time calculation:", {
                timeLeft,
                minutes,
                seconds,
              });
              document.getElementById("countdownTimer").textContent = "Error";
              return;
            }

            // Update display
            const displayText = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
            document.getElementById("countdownTimer").textContent = displayText;

            // Change color when less than 2 minutes remaining
            if (timeLeft < 2 * 60 * 1000) {
              document
                .getElementById("countdownTimer")
                .classList.add("text-red-600");
            } else if (timeLeft < 5 * 60 * 1000) {
              document
                .getElementById("countdownTimer")
                .classList.add("text-orange-600");
            } else {
              document
                .getElementById("countdownTimer")
                .classList.remove("text-red-600", "text-orange-600");
            }

            console.log("Countdown updated:", displayText);
          };

          // Update immediately
          updateTimer();

          // Update every second
          countdownInterval = setInterval(updateTimer, 1000);
        };

        const initializeUserDetails = async () => {
          try {
            console.log("=== INITIALIZE USER DETAILS START ===");
            console.log(`Booking ID from URL: "${code}"`);
            console.log(`Sheet ID: ${userDetailsSheetID}`);
            console.log(`Sheet Name: ${userDetailsSheetName}`);

            // Show loading state
            document.getElementById("loadingModal").classList.remove("hidden");

            // Wait 2 seconds before fetching user details from Raw Data
            console.log("Waiting 2 seconds before fetching...");
            await new Promise((resolve) => setTimeout(resolve, 500));
            console.log(
              "2-second wait completed, now fetching user details..."
            );

            // Fetch user details from sheet
            const userDetails = await fetchUserDetailsByBookingId(code);

            console.log("User details returned:", userDetails);

            if (!userDetails) {
              console.error(
                "No user details found - redirecting to initiatebooking.html"
              );
              alert("Invalid booking ID. Please try again.");
              location.replace("initiatebooking.html");
              return;
            }

            // Validate user details
            console.log("Validating user details:");
            console.log(`Email: "${userDetails.email}"`);
            console.log(`Mobile: "${userDetails.mobile}"`);
            console.log(`Seats: ${userDetails.seats}`);

            if (
              !userDetails.email ||
              !userDetails.mobile ||
              userDetails.seats < 1
            ) {
              console.error(
                "Invalid user details - redirecting to initiatebooking.html"
              );
              console.error(`Email valid: ${!!userDetails.email}`);
              console.error(`Mobile valid: ${!!userDetails.mobile}`);
              console.error(`Seats valid: ${userDetails.seats >= 1}`);
              alert("Invalid user details. Please try again.");
              location.replace("initiatebooking.html");
              return;
            }

            console.log("User details validation passed");

            // Set global variables
            const email = userDetails.email;
            const mobile = userDetails.mobile;
            const seats = userDetails.seats;
            const amount = seats * 500;

            console.log("Global variables set:");
            console.log(`Email: ${email}`);
            console.log(`Mobile: ${mobile}`);
            console.log(`Seats: ${seats}`);
            console.log(`Amount: ${amount}`);

            // Update UI elements
            const seatCountEl = document.getElementById("seatCount");
            const amtTitleEl = document.getElementById("amtTitle");
            const amountDisplayEl = document.getElementById("amountDisplay");
            const manualAmountTextEl =
              document.getElementById("manualAmountText");
            const emailValEl = document.getElementById("emailVal");
            const mobileValEl = document.getElementById("mobileVal");
            const bookingIdValSummaryEl = document.getElementById(
              "bookingIdValSummary"
            );
            const bookingIdTextModalEl =
              document.getElementById("bookingIdTextModal");

            if (seatCountEl) seatCountEl.textContent = seats;
            if (amtTitleEl) amtTitleEl.textContent = amount;
            if (amountDisplayEl) amountDisplayEl.textContent = amount;
            if (manualAmountTextEl) manualAmountTextEl.textContent = amount;
            if (emailValEl) emailValEl.textContent = email;
            if (mobileValEl) mobileValEl.textContent = mobile;
            if (bookingIdValSummaryEl) bookingIdValSummaryEl.textContent = code;
            if (bookingIdTextModalEl) bookingIdTextModalEl.textContent = code;

            console.log("UI elements updated successfully");

            // Build UPI URL
            upiURL = buildUPI(email, seats, amount);
            console.log("UPI URL built:", upiURL);

            // Set up QR checkbox event listener
            if (qrCheckbox) {
              qrCheckbox.addEventListener("change", () => {
                const isChecked = qrCheckbox.checked;

                if (isChecked) {
                  qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(
                    upiURL
                  )}`;
                } else {
                  qrImg.src = qrPlaceholder;
                }

                const buttonsToToggle = [
                  copyAndDownloadBtn,
                  manualPayBtn,
                  paidBtn,
                  havingtroublebutton,
                ].filter((btn) => btn); // Filter out null/undefined buttons

                buttonsToToggle.forEach((btn) => {
                  btn.disabled = !isChecked;
                  btn.classList.toggle("opacity-20", !isChecked);
                  btn.classList.toggle("cursor-not-allowed", !isChecked);
                });

                // Also control the UPI transaction number inputs and confirm payment modal
                const upiTransactionNumber = document.getElementById(
                  "upiTransactionNumber"
                );
                const confirmUpiTransactionNumber = document.getElementById(
                  "confirmUpiTransactionNumber"
                );

                if (upiTransactionNumber && confirmUpiTransactionNumber) {
                  upiTransactionNumber.disabled = !isChecked;
                  confirmUpiTransactionNumber.disabled = !isChecked;
                  upiTransactionNumber.classList.toggle(
                    "opacity-50",
                    !isChecked
                  );
                  confirmUpiTransactionNumber.classList.toggle(
                    "opacity-50",
                    !isChecked
                  );
                  upiTransactionNumber.classList.toggle(
                    "cursor-not-allowed",
                    !isChecked
                  );
                  confirmUpiTransactionNumber.classList.toggle(
                    "cursor-not-allowed",
                    !isChecked
                  );

                  // Clear the inputs when checkbox is unchecked
                  if (!isChecked) {
                    upiTransactionNumber.value = "";
                    confirmUpiTransactionNumber.value = "";
                    // Reset validation state
                    const validationMessage = document.getElementById(
                      "transactionValidationMessage"
                    );
                    const successMessage = document.getElementById(
                      "transactionValidationSuccess"
                    );
                    const errorMessage = document.getElementById(
                      "transactionValidationError"
                    );
                    if (validationMessage)
                      validationMessage.classList.add("hidden");
                    if (successMessage) successMessage.classList.add("hidden");
                    if (errorMessage) errorMessage.classList.add("hidden");
                  }
                }
              });
            }

            // Show placeholder image initially
            qrImg.src = qrPlaceholder;

            // Disable buttons initially until checkbox is checked
            const buttonsToDisable = [
              copyAndDownloadBtn,
              manualPayBtn,
              paidBtn,
              havingtroublebutton,
            ].filter((btn) => btn); // Filter out null/undefined buttons

            buttonsToDisable.forEach((btn) => {
              btn.disabled = true;
              btn.classList.add("opacity-20", "cursor-not-allowed");
            });

            // Also disable UPI transaction number inputs initially
            const upiTransactionNumber = document.getElementById(
              "upiTransactionNumber"
            );
            const confirmUpiTransactionNumber = document.getElementById(
              "confirmUpiTransactionNumber"
            );

            if (upiTransactionNumber && confirmUpiTransactionNumber) {
              upiTransactionNumber.disabled = true;
              confirmUpiTransactionNumber.disabled = true;
              upiTransactionNumber.classList.add(
                "opacity-50",
                "cursor-not-allowed"
              );
              confirmUpiTransactionNumber.classList.add(
                "opacity-50",
                "cursor-not-allowed"
              );
            }

            // Initialize countdown timer
            initializeCountdownTimer(code);

            // Hide loading modal
            document.getElementById("loadingModal").classList.add("hidden");

            console.log("Loading modal hidden, starting application...");

            console.log("=== INITIALIZE USER DETAILS COMPLETED ===");
          } catch (error) {
            console.error("=== ERROR IN INITIALIZE USER DETAILS ===");
            console.error("Error details:", error);
            console.error("Error message:", error.message);
            console.error("Error stack:", error.stack);
            alert("Failed to load user details. Please try again.");
            location.replace("initiatebooking.html");
          }
        };

        // Initialize user details and start the application
        initializeUserDetails();

        /* ---------- helpers ---------- */

        const buildUPI = (e, s, a) =>
          "upi://pay?" +
          new URLSearchParams({
            pa: UPI_ID,
            pn: PAYEE,
            //mc: "0000",
            //mode: "02",
            //purpose: "00",
            am: a,
            cu: "INR",
          });

        const copy = async (text, btn) => {
          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(text);
            } else {
              const ta = document.createElement("textarea");
              ta.value = text;
              ta.style.position = "fixed";
              ta.style.opacity = "0";
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              document.execCommand("copy");
              document.body.removeChild(ta);
            }
            btn.classList.add(
              "ring-2",
              "ring-offset-1",
              "ring-green-400",
              "transition",
              "duration-150"
            );
            setTimeout(() => {
              btn.classList.remove("ring-2", "ring-offset-1", "ring-green-400");
            }, 1100);
          } catch (err) {
            alert("Copy failed: " + err);
          }
        };

        /* ---------- UI will be initialized by initializeUserDetails() ---------- */

        // UPI URL will be built after user details are loaded
        let upiURL = "";

        const qrPlaceholder = "assets/qrdekinai.png"; // placeholder image
        qrImg.src = qrPlaceholder;

        // Checkbox event listener will be set up after user details are loaded

        /* ---------- events ---------- */
        manualPayBtn.onclick = () => manualModal.classList.remove("hidden");
        closeModal.onclick = () => manualModal.classList.add("hidden");
        manualModal.addEventListener("click", (e) => {
          if (e.target === manualModal) manualModal.classList.add("hidden");
        });

        copyAmtBtn.onclick = () => copy(manualAmt.textContent, copyAmtBtn);
        copyUpiBtn.onclick = () => copy(UPI_ID, copyUpiBtn);
        copyBookingIdModalBtn.onclick = () => copy(code, copyBookingIdModalBtn);
        document.getElementById("copyBookingIdSummaryBtn").onclick = () =>
          copy(code, document.getElementById("copyBookingIdSummaryBtn"));

        // UPI Transaction Validation
        const upiTransactionNumber = document.getElementById(
          "upiTransactionNumber"
        );
        const confirmUpiTransactionNumber = document.getElementById(
          "confirmUpiTransactionNumber"
        );
        const transactionValidationMessage = document.getElementById(
          "transactionValidationMessage"
        );
        const transactionValidationSuccess = document.getElementById(
          "transactionValidationSuccess"
        );
        const transactionValidationError = document.getElementById(
          "transactionValidationError"
        );

        function validateTransactionNumbers() {
          const transaction1 = upiTransactionNumber.value.trim();
          const transaction2 = confirmUpiTransactionNumber.value.trim();

          if (transaction1 === "" || transaction2 === "") {
            transactionValidationMessage.classList.add("hidden");
            paidBtn.disabled = true;
            paidBtn.className =
              "mt-4 w-full max-w-md bg-gradient-to-r from-gray-400 to-gray-500 text-white py-3 px-6 rounded-lg font-bold text-base shadow-lg transition-all duration-200 flex items-center justify-center gap-2 cursor-not-allowed";
            return false;
          }

          if (transaction1 === transaction2) {
            transactionValidationMessage.classList.remove("hidden");
            transactionValidationSuccess.classList.remove("hidden");
            transactionValidationError.classList.add("hidden");
            paidBtn.disabled = false;
            paidBtn.className =
              "mt-4 w-full max-w-md bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 px-6 rounded-lg font-bold text-base shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-2";
            return true;
          } else {
            transactionValidationMessage.classList.remove("hidden");
            transactionValidationSuccess.classList.add("hidden");
            transactionValidationError.classList.remove("hidden");
            paidBtn.disabled = true;
            paidBtn.className =
              "mt-4 w-full max-w-md bg-gradient-to-r from-gray-400 to-gray-500 text-white py-3 px-6 rounded-lg font-bold text-base shadow-lg transition-all duration-200 flex items-center justify-center gap-2 cursor-not-allowed";
            return false;
          }
        }

        upiTransactionNumber.addEventListener(
          "input",
          validateTransactionNumbers
        );
        confirmUpiTransactionNumber.addEventListener(
          "input",
          validateTransactionNumbers
        );

        paidBtn.onclick = async () => {
          try {
            const params = new URLSearchParams(location.search);
            const bookingId = params.get("code")?.trim();

            if (!bookingId) {
              alert("Invalid booking ID.");
              return;
            }

            // Get UPI transaction number
            const upiTransactionNumberValue = upiTransactionNumber.value.trim();

            if (!upiTransactionNumberValue) {
              alert("Please enter your UPI transaction number.");
              return;
            }

            // User details are already loaded from the sheet during initialization
            // We can access them from the UI elements or store them globally
            const email = document.getElementById("emailVal").textContent;
            const mobile = document.getElementById("mobileVal").textContent;
            const seats = parseInt(
              document.getElementById("seatCount").textContent
            );

            // Show loading modal
            const modal = document.getElementById("loadingModal");
            modal.classList.remove("hidden");

            // Submit UPI transaction data to Google Form
            const upiFormURL =
              "https://docs.google.com/forms/u/0/d/e/1FAIpQLSfuSCJ_RNotyMM4JXItNzn-PODSrM8RjBj1xOFDrec3mxs8bQ/formResponse";

            const upiFormData = new FormData();
            upiFormData.append("entry.1522002465", bookingId); // Booking ID
            upiFormData.append("entry.1130423461", upiTransactionNumberValue); // UPI Transaction Number

            try {
              await fetch(upiFormURL, {
                method: "POST",
                mode: "no-cors",
                body: upiFormData,
              });
              console.log("UPI transaction data submitted successfully");
            } catch (upiError) {
              console.error("Error submitting UPI transaction data:", upiError);
              // Continue with the process even if UPI form submission fails
            }

            const formBaseURL =
              "https://docs.google.com/forms/d/e/1FAIpQLSdKvVjiL3W356UZsWKy0BBRpqHxoFN7Q_5UQHUKlQDjxpNxBA/formResponse";
            const sheetID = "1Sxrv3iIIdl_6RqAahVZBKKCA-PvzIJXIyz5fkhq0HNc";
            const sheetName = "Slot Blocking Sources";
            const query = encodeURIComponent("SELECT *");
            const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

            // User details are already loaded from the sheet, no need to fetch again

            const response = await fetch(url);
            const data = await response.text();
            const json = JSON.parse(data.substring(47).slice(0, -2));
            const rows = json.table.rows;

            const matchingRows = rows.filter((row) => {
              const rowBookingId = row.c[3]?.v ? String(row.c[3].v).trim() : "";
              const status = row.c[4]?.v ? String(row.c[4].v).trim() : "";
              const activity = row.c[6]?.v ? String(row.c[6].v).trim() : "";

              return (
                rowBookingId === bookingId &&
                status === "Processing" &&
                activity === "Active"
              );
            });

            if (matchingRows.length === 0) {
              modal.classList.add("hidden");
              alert(
                "Your have either timed out or the seat is no longer available. Please contact support to claim refund or book another slot. No matching Processing + Active entries found."
              );
              return;
            }

            for (let row of matchingRows) {
              const day = row.c[1]?.v ? String(row.c[1].v).trim() : "";
              const slot = row.c[2]?.v ? String(row.c[2].v).trim() : "";

              const formData = new FormData();
              formData.append("entry.706936465", day);
              formData.append("entry.1380648863", slot);
              formData.append("entry.1536265716", bookingId);
              formData.append("entry.38505346", "Booked");

              await fetch(formBaseURL, {
                method: "POST",
                mode: "no-cors",
                body: formData,
              });

              await new Promise((res) => setTimeout(res, 200));
            }

            // Redirect after successful submission
            window.location.href = `paid.html?code=${bookingId}`;
          } catch (error) {
            console.error("Booking confirmation failed:", error);
            alert(
              "There was an issue confirming your booking. Please try again."
            );
            document.getElementById("loadingModal").classList.add("hidden");
          }
        };

        document.getElementById("copyAndDownloadBtn").onclick =
          async function () {
            // Copy booking ID
            await copy(code, this);

            // Download QR code (force download even for cross-origin images)
            try {
              const qrImage = document.getElementById("qrImage");
              const response = await fetch(qrImage.src, { mode: "cors" });
              const blob = await response.blob();
              const url = URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.download = "cafe-kyaa-qr.png";
              link.href = url;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);

              // Show next steps modal after successful copy and download
              document
                .getElementById("nextStepsModal")
                .classList.remove("hidden");
            } catch (err) {
              alert(
                "Couldn't download the QR code. Please long‑press or right‑click the image instead."
              );
              console.error(err);
            }
          };
      });
    </script>
    <!-- Loading Modal -->
    <div
      id="loadingModal"
      class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-sm mx-4"
      >
        <div
          class="w-16 h-16 border-4 border-pink-500 border-t-transparent rounded-full spinner mx-auto mb-6"
        ></div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">
          Confirming your booking…
        </h2>
        <p class="text-gray-600">
          Please wait a moment while we process your payment.
        </p>
      </div>
    </div>

    <!-- Next Steps Modal -->
    <div
      id="nextStepsModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl relative animate-fadeIn mx-4"
      >
        <button
          onclick="closeNextStepsModal()"
          class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-xl font-bold"
        >
          &times;
        </button>

        <div class="text-center mb-6">
          <div
            class="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <svg
              class="w-8 h-8 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Ready to Pay!</h3>
          <p class="text-gray-600">
            Your booking ID is copied and QR is downloaded
          </p>
        </div>

        <div class="space-y-4">
          <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
            <div
              class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <span class="text-white text-xs font-bold">1</span>
            </div>
            <div>
              <p class="text-sm font-medium text-blue-800">Open your UPI app</p>
              <p class="text-xs text-blue-600 mt-1">
                Launch GPay, Paytm, PhonePe, or any UPI app
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3 p-3 bg-purple-50 rounded-lg">
            <div
              class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <span class="text-white text-xs font-bold">2</span>
            </div>
            <div>
              <p class="text-sm font-medium text-purple-800">
                Scan the downloaded QR
              </p>
              <p class="text-xs text-purple-600 mt-1">
                Upload the QR image you just downloaded
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3 p-3 bg-green-50 rounded-lg">
            <div
              class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <span class="text-white text-xs font-bold">3</span>
            </div>
            <div>
              <p class="text-sm font-medium text-green-800">
                Paste booking ID in note
              </p>
              <p class="text-xs text-green-600 mt-1">
                Paste the copied booking ID in the UPI payment note
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3 p-3 bg-orange-50 rounded-lg">
            <div
              class="w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <span class="text-white text-xs font-bold">4</span>
            </div>
            <div>
              <p class="text-sm font-medium text-orange-800">
                Complete payment
              </p>
              <p class="text-xs text-orange-600 mt-1">
                Review amount and confirm the payment
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3 p-3 bg-pink-50 rounded-lg">
            <div
              class="w-6 h-6 bg-pink-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"
            >
              <span class="text-white text-xs font-bold">5</span>
            </div>
            <div>
              <p class="text-sm font-medium text-pink-800">
                Come back to booking
              </p>
              <p class="text-xs text-pink-600 mt-1">
                Return to this page to confirm your payment
              </p>
            </div>
          </div>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-200">
          <button
            onclick="closeNextStepsModal()"
            class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white py-2 px-4 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
          >
            Got it!
          </button>
        </div>
      </div>
    </div>

    <script>
      function closeNextStepsModal() {
        document.getElementById("nextStepsModal").classList.add("hidden");
      }
    </script>
  </body>
</html>
