<!DOCTYPE html>
<html>
  <head>
    <title>Generate Payment Key</title>
  </head>
  <body>
    <h2>Payment Key Generatorrrr</h2>
    <form id="keyForm">
      <label>Email: <input type="email" id="email" required /></label
      ><br /><br />
      <label
        >Seat (1-12):
        <input type="number" id="seat" min="1" max="12" required /></label
      ><br /><br />
      <button type="submit">Generate Key</button>
    </form>

    <h3 id="result"></h3>

    <script>
      async function generateSHA256(input) {
        const encoder = new TextEncoder();
        const data = encoder.encode(input);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
        return hashHex.toUpperCase();
      }

      document
        .getElementById("keyForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const email = document
            .getElementById("email")
            .value.trim()
            .toLowerCase();
          const seat = document.getElementById("seat").value.trim();
          const inputStr = `${email}-${seat}`;
          const hash = await generateSHA256(inputStr);
          const shortHash = hash.slice(0, 6);
          const key = `PAY-${shortHash}`;
          document.getElementById(
            "result"
          ).innerText = `Your Payment Key: ${key}`;

          // Send data as plain text to avoid CORS preflight
          const scriptURL =
            "https://script.google.com/macros/s/AKfycbxC8DoHIrCbzi4fmwrF7bRdXi0x24d-odPHzjT2hGM/dev"; // Replace with your real URL
          const payload = `email=${encodeURIComponent(
            email
          )}&seat=${encodeURIComponent(seat)}&key=${encodeURIComponent(key)}`;
          fetch(scriptURL, {
            method: "POST",
            body: payload,
            headers: { "Content-Type": "text/plain" },
          })
            .then((response) => response.text())
            .then((data) => alert("Key saved to database!"))
            .catch((error) => alert("Error saving key: " + error));
        });
    </script>
  </body>
</html>
